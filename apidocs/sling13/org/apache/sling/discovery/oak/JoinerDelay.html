<!DOCTYPE HTML>
<html lang>
<head>
<!-- Generated by javadoc (17) -->
<title>JoinerDelay (Apache Sling 13 API)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="description" content="declaration: package: org.apache.sling.discovery.oak, class: JoinerDelay">
<meta name="generator" content="javadoc/ClassWriterImpl">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../script-dir/jquery-ui.min.css" title="Style">
<link rel="stylesheet" type="text/css" href="../../../../../jquery-ui.overrides.css" title="Style">
<script type="text/javascript" src="../../../../../script.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-3.6.1.min.js"></script>
<script type="text/javascript" src="../../../../../script-dir/jquery-ui.min.js"></script>
</head>
<body class="class-declaration-page">
<script type="text/javascript">var evenRowColor = "even-row-color";
var oddRowColor = "odd-row-color";
var tableTab = "table-tab";
var activeTableTab = "active-table-tab";
var pathtoroot = "../../../../../";
loadScripts(document, 'script');</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<div class="flex-box">
<header role="banner" class="flex-header">
<nav role="navigation">
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="top-nav" id="navbar-top">
<div class="skip-nav"><a href="#skip-navbar-top" title="Skip navigation links">Skip navigation links</a></div>
<ul id="navbar-top-firstrow" class="nav-list" title="Navigation">
<li><a href="../../../../../index.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="nav-bar-cell1-rev">Class</li>
<li><a href="class-use/JoinerDelay.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../help-doc.html#class">Help</a></li>
</ul>
</div>
<div class="sub-nav">
<div>
<ul class="sub-nav-list">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#constructor-summary">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-summary">Method</a></li>
</ul>
<ul class="sub-nav-list">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li><a href="#constructor-detail">Constr</a>&nbsp;|&nbsp;</li>
<li><a href="#method-detail">Method</a></li>
</ul>
</div>
<div class="nav-list-search"><label for="search-input">SEARCH:</label>
<input type="text" id="search-input" value="search" disabled="disabled">
<input type="reset" id="reset-button" value="reset" disabled="disabled">
</div>
</div>
<!-- ========= END OF TOP NAVBAR ========= -->
<span class="skip-nav" id="skip-navbar-top"></span></nav>
</header>
<div class="flex-content">
<main role="main">
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="sub-title"><span class="package-label-in-type">Package</span>&nbsp;<a href="package-summary.html">org.apache.sling.discovery.oak</a></div>
<h1 title="Class JoinerDelay" class="title">Class JoinerDelay</h1>
</div>
<div class="inheritance" title="Inheritance Tree"><a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">java.lang.Object</a>
<div class="inheritance">org.apache.sling.discovery.oak.JoinerDelay</div>
</div>
<section class="class-description" id="class-description">
<dl class="notes">
<dt>All Implemented Interfaces:</dt>
<dd><code><a href="../commons/providers/spi/ClusterSyncService.html" title="interface in org.apache.sling.discovery.commons.providers.spi">ClusterSyncService</a></code></dd>
</dl>
<hr>
<div class="type-signature"><span class="modifiers">public class </span><span class="element-name type-name-label">JoinerDelay</span>
<span class="extends-implements">extends <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a>
implements <a href="../commons/providers/spi/ClusterSyncService.html" title="interface in org.apache.sling.discovery.commons.providers.spi">ClusterSyncService</a></span></div>
<div class="block">The JoinerDelay is an ClusterSyncService used in the sync chain and got
 introduced as part of SLING-10489.
 <p>
 With SLING-10489 new-joining instances are ignored/suppressed by existing
 instances in the cluster as long as they are potentially only partially
 started up. The definition of partial-vs-full is the when everything
 is written and the consistencyService (sync) would succeed. In other words
 it includes: lease update / idMap / leaderElectionId / syncToken.
 It is undefined how long a startup lasts and to avoid blocking other instances
 from operating under a well-defined topology, the notion of ignoring/suppressing
 partially started instances has been introduced.
 <p>
 Generally speaking there are the following different cases wrt changes
 in the local cluster:
 <ul>
  <li>only properties change -&gt; that is handled separately already and not interesting here</li>
  <li>only leaving instances -&gt; not interesting for this problem</li>
  <li>only joining instances: in this case, these joining instances get
      ignored/suppressed until they are fully started and have written all needed discovery data.
      Until that has happened, the existing instances don't do anything discovery-related
      yet, ie they don't store syncToken yet neither. Thus, the newly joined instances,
      once they are finished with the startup, they would have to wait for the
      existing ones to yet take note of their full startup, of them writing their own
      sync token, so that the new-joiners can see those sync tokens and finish.
      So this case is perfectly fine simply with ignoring/suppressing.</li>
  <li>some leaving, some joining instances: it is this case which is a bit more tricky:
      with SLING-10489 the joining instances are now ignored/suppressed until they
      are fully started, so upon a cluster change they don't trigger any discovery
      activity on the existing instances.
      However, because there are also some instances leaving, the existing instances
      will take note of a cluster change and *therefore* update the syncToken etc.
      In that case, we have a new situation: the cluster change has been
      announced in the existing instances, the existing instances wrote their new
      sync token, but the new-joiners are still partially starting up.
      Let's say now the new-joiners finish their startup, so they write down the
      sync token. In that very moment the following happens concurrently:
      (a) the new-joiners check the topology and notice that everybody else already
      wrote the new sync token, so they can immediately go ahead and do a TOPOLOGY_INIT.
      (b) the existing instances just now stop ignoring/suppressing the new-joiners
      and then go through the consistencyService/syncing - but before they can do that,
      they have to inform existing listeners with a TOPOLOGY_CHANGING. Since that
      might take a while, it is realistic that the new-joiner already thinks they
      are in the new topology *while* the existing ones haven't received
      a TOPOLOGY_CHANGING event yet. And voila, we have a sort of short-lived split-brain.
      Now usually this should really only be very short-lived, as all that is holding
      back is TopologyEventListeners reacting to TOPOLOGY_CHANGING - plus then some
      repository writes. So all of that shouldn't take too long. But it could be a few
      seconds. And the aim of discovery is to provide guarantees that there are never
      different topologies in the , aehm .., topology.
      Now to fix this, we'd have to probably do another synching, which would be
      unfeasibly complicated.
      But there's a rather simple way out: we can artificially delay the new-joiners
      from sending their very first TOPOLOGY_INIT. That way, if that delay is
      bigger than the above described race-condition, things would be fine.
      And that's what this JoinerDelay is about : delay new-joiner's TOPOLOGY_INIT.</li>
 </ul></div>
</section>
<section class="summary">
<ul class="summary-list">
<!-- ======== CONSTRUCTOR SUMMARY ======== -->
<li>
<section class="constructor-summary" id="constructor-summary">
<h2>Constructor Summary</h2>
<div class="caption"><span>Constructors</span></div>
<div class="summary-table two-column-summary">
<div class="table-header col-first">Constructor</div>
<div class="table-header col-last">Description</div>
<div class="col-constructor-name even-row-color"><code><a href="#%3Cinit%3E(long,org.apache.sling.commons.scheduler.Scheduler)" class="member-name-link">JoinerDelay</a><wbr>(long&nbsp;timeoutMs,
 <a href="../../commons/scheduler/Scheduler.html" title="interface in org.apache.sling.commons.scheduler">Scheduler</a>&nbsp;scheduler)</code></div>
<div class="col-last even-row-color">&nbsp;</div>
</div>
</section>
</li>
<!-- ========== METHOD SUMMARY =========== -->
<li>
<section class="method-summary" id="method-summary">
<h2>Method Summary</h2>
<div id="method-summary-table">
<div class="table-tabs" role="tablist" aria-orientation="horizontal"><button id="method-summary-table-tab0" role="tab" aria-selected="true" aria-controls="method-summary-table.tabpanel" tabindex="0" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table', 3)" class="active-table-tab">All Methods</button><button id="method-summary-table-tab2" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab2', 3)" class="table-tab">Instance Methods</button><button id="method-summary-table-tab4" role="tab" aria-selected="false" aria-controls="method-summary-table.tabpanel" tabindex="-1" onkeydown="switchTab(event)" onclick="show('method-summary-table', 'method-summary-table-tab4', 3)" class="table-tab">Concrete Methods</button></div>
<div id="method-summary-table.tabpanel" role="tabpanel">
<div class="summary-table three-column-summary" aria-labelledby="method-summary-table-tab0">
<div class="table-header col-first">Modifier and Type</div>
<div class="table-header col-second">Method</div>
<div class="table-header col-last">Description</div>
<div class="col-first even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>void</code></div>
<div class="col-second even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#cancelSync()" class="member-name-link">cancelSync</a>()</code></div>
<div class="col-last even-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">&nbsp;</div>
<div class="col-first odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code>void</code></div>
<div class="col-second odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4"><code><a href="#sync(org.apache.sling.discovery.commons.providers.BaseTopologyView,java.lang.Runnable)" class="member-name-link">sync</a><wbr>(<a href="../commons/providers/BaseTopologyView.html" title="class in org.apache.sling.discovery.commons.providers">BaseTopologyView</a>&nbsp;view,
 <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Runnable.html" title="class or interface in java.lang" class="external-link">Runnable</a>&nbsp;callback)</code></div>
<div class="col-last odd-row-color method-summary-table method-summary-table-tab2 method-summary-table-tab4">
<div class="block">Starts the synchronization process and calls the provided
 callback upon completion.</div>
</div>
</div>
</div>
</div>
<div class="inherited-list">
<h3 id="methods-inherited-from-class-java.lang.Object">Methods inherited from class&nbsp;java.lang.<a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html" title="class or interface in java.lang" class="external-link">Object</a></h3>
<code><a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#clone()" title="class or interface in java.lang" class="external-link">clone</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#equals(java.lang.Object)" title="class or interface in java.lang" class="external-link">equals</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#finalize()" title="class or interface in java.lang" class="external-link">finalize</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#getClass()" title="class or interface in java.lang" class="external-link">getClass</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#hashCode()" title="class or interface in java.lang" class="external-link">hashCode</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#notify()" title="class or interface in java.lang" class="external-link">notify</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#notifyAll()" title="class or interface in java.lang" class="external-link">notifyAll</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#toString()" title="class or interface in java.lang" class="external-link">toString</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#wait()" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#wait(long)" title="class or interface in java.lang" class="external-link">wait</a>, <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Object.html#wait(long,int)" title="class or interface in java.lang" class="external-link">wait</a></code></div>
</section>
</li>
</ul>
</section>
<section class="details">
<ul class="details-list">
<!-- ========= CONSTRUCTOR DETAIL ======== -->
<li>
<section class="constructor-details" id="constructor-detail">
<h2>Constructor Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="&lt;init&gt;(long,org.apache.sling.commons.scheduler.Scheduler)">
<h3>JoinerDelay</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="element-name">JoinerDelay</span><wbr><span class="parameters">(long&nbsp;timeoutMs,
 <a href="../../commons/scheduler/Scheduler.html" title="interface in org.apache.sling.commons.scheduler">Scheduler</a>&nbsp;scheduler)</span></div>
</section>
</li>
</ul>
</section>
</li>
<!-- ============ METHOD DETAIL ========== -->
<li>
<section class="method-details" id="method-detail">
<h2>Method Details</h2>
<ul class="member-list">
<li>
<section class="detail" id="sync(org.apache.sling.discovery.commons.providers.BaseTopologyView,java.lang.Runnable)">
<h3>sync</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">sync</span><wbr><span class="parameters">(<a href="../commons/providers/BaseTopologyView.html" title="class in org.apache.sling.discovery.commons.providers">BaseTopologyView</a>&nbsp;view,
 <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/lang/Runnable.html" title="class or interface in java.lang" class="external-link">Runnable</a>&nbsp;callback)</span></div>
<div class="block"><span class="descfrm-type-label">Description copied from interface:&nbsp;<code><a href="../commons/providers/spi/ClusterSyncService.html#sync(org.apache.sling.discovery.commons.providers.BaseTopologyView,java.lang.Runnable)">ClusterSyncService</a></code></span></div>
<div class="block">Starts the synchronization process and calls the provided
 callback upon completion.
 <p>
 sync() is not thread-safe and should not be invoked 
 concurrently.
 <p>
 If sync() gets called before a previous invocation finished,
 that previous invocation will be discarded, ie the callback
 of the previous invocation will no longer be called.
 <p>
 The synchronization process consists of making sure that
 the repository has processed any potential backlog of instances
 that are no longer part of the provided, new view. Plus 
 it writes a 'sync-token' to a well-defined location, with
 all peers doing the same, and upon seeing all other sync-tokens
 declares successful completion - at which point it calls the
 callback.run().</div>
<dl class="notes">
<dt>Specified by:</dt>
<dd><code><a href="../commons/providers/spi/ClusterSyncService.html#sync(org.apache.sling.discovery.commons.providers.BaseTopologyView,java.lang.Runnable)">sync</a></code>&nbsp;in interface&nbsp;<code><a href="../commons/providers/spi/ClusterSyncService.html" title="interface in org.apache.sling.discovery.commons.providers.spi">ClusterSyncService</a></code></dd>
<dt>Parameters:</dt>
<dd><code>view</code> - the view which all instances in the local cluster
 should agree on having seen</dd>
<dd><code>callback</code> - the runnable which should be called after
 successful syncing</dd>
</dl>
</section>
</li>
<li>
<section class="detail" id="cancelSync()">
<h3>cancelSync</h3>
<div class="member-signature"><span class="modifiers">public</span>&nbsp;<span class="return-type">void</span>&nbsp;<span class="element-name">cancelSync</span>()</div>
<dl class="notes">
<dt>Specified by:</dt>
<dd><code><a href="../commons/providers/spi/ClusterSyncService.html#cancelSync()">cancelSync</a></code>&nbsp;in interface&nbsp;<code><a href="../commons/providers/spi/ClusterSyncService.html" title="interface in org.apache.sling.discovery.commons.providers.spi">ClusterSyncService</a></code></dd>
</dl>
</section>
</li>
</ul>
</section>
</li>
</ul>
</section>
<!-- ========= END OF CLASS DATA ========= -->
</main>
<footer role="contentinfo">
<hr>
<p class="legal-copy"><small>Copyright &#169; 2024 <a href="https://www.apache.org/">The Apache Software Foundation</a>. All rights reserved.</small></p>
</footer>
</div>
</div>
</body>
</html>
