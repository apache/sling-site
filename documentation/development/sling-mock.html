<!DOCTYPE html><html lang="en">
    <head>
<meta charset="utf-8"/>
        <title>Apache Sling on JBake</title>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <link rel="stylesheet" href="/res/css/codehilite.css"/>
        <div class="title">
            <div class="logo">
                <a href="http://sling.apache.org">
                    <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                </a>
            </div><div class="header">
                <a href="http://www.apache.org">
                    <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                </a>
            </div>
        </div>        
    </head><body>
<div class="menu">
            <strong><a href="/documentation.html">Documentation</a></strong><br/><a href="/documentation/getting-started.html">Getting Started</a><br/><a href="/documentation/the-sling-engine.html">The Sling Engine</a><br/><a href="/documentation/development.html">Development</a><br/><a href="/documentation/bundles.html">Bundles</a><br/><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a><br/><a href="/documentation/configuration.html">Configuration</a><p></p><a href="http://s.apache.org/sling.wiki">Wiki</a><br/><a href="http://s.apache.org/sling.faq">FAQ</a><br/><p></p><strong>API Docs</strong><br/><a href="/apidocs/sling9/index.html">Sling 9</a><br/><a href="/apidocs/sling8/index.html">Sling 8</a><br/><a href="/apidocs/sling7/index.html">Sling 7</a><br/><a href="/apidocs/sling6/index.html">Sling 6</a><br/><a href="/apidocs/sling5/index.html">Sling 5</a><br/><a href="/javadoc-io.html">Archive at javadoc.io</a><br/><p></p><strong>Project info</strong><br/><a href="/downloads.cgi">Downloads</a><br/><a href="http://www.apache.org/licenses/">License</a><br/><a href="/contributing.html">Contributing</a><br/><a href="/news.html">News</a><br/><a href="/links.html">Links</a><br/><a href="/project-information.html">Project Information</a><br/><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a><br/><a href="http://ci.apache.org/builders/sling-trunk">Build Server</a><br/><a href="/project-information/security.html">Security</a><br/><p></p><strong>Source</strong><br/><a href="http://svn.apache.org/viewvc/sling/trunk">Subversion</a><br/><a href="git://git.apache.org/sling.git">Git</a><br/><a href="https://github.com/apache/sling">Github Mirror</a><br/><p></p><strong>Sponsorship</strong><br/><a href="http://www.apache.org/foundation/thanks.html">Thanks</a><br/><a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a><br/><a href="https://donate.apache.org/">Donate!</a><br/><a href="http://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a><br/><p></p><strong><a href="/sitemap.html">Site Map</a></strong>
        </div>        <div class="main">
<div class="row"><div class="small-12 columns"><section class="wrap"><header><h1>Sling Mocks</h1></header><p>Mock implementation of selected Sling APIs for easier testing.</p>
<p>[TOC]</p>
<h2>Maven Dependency</h2>
<h1>!xml</h1>
<p><dependency> <groupId>org.apache.sling</groupId> <artifactId>org.apache.sling.testing.sling-mock</artifactId> </dependency></p>
<p>See latest version on the <a href="/downloads.cgi">downloads page</a>.</p>
<p>There are two major version ranges available:</p>
<ul>
  <li>sling-mock 1.x: compatible with older Sling versions from 2014 (Sling API 2.4 and above)</li>
  <li>sling-mock 2.x: compatible with Sling versions from 2016 (Sling API 2.11 and above)</li>
</ul>
<h2>Implemented mock features</h2>
<p>The mock implementation supports:</p>
<ul>
  <li><code>ResourceResolver</code> implementation for reading and writing resource data using the Sling Resource API</li>
  <li>Backed by a <a href="/documentation/development/jcr-mock.html">mocked</a> or real Jackrabbit JCR implementation</li>
  <li>Uses the productive <a href="http://svn.apache.org/repos/asf/sling/trunk/bundles/jcr/resource">Sling JCR resource provider implementation</a> internally to do the Resource-JCR mapping</li>
  <li>Alternatively the non-JCR mock implementation provided by the <a href="/documentation/development/resourceresolver-mock.html">Sling resourceresolver-mock implementation</a> can be used</li>
  <li><code>AdapterManager</code> implementation for registering adapter factories and resolving adaptions</li>
  <li>The implementation is thread-safe so it can be used in parallel running unit tests</li>
  <li><code>SlingScriptHelper</code> implementation providing access to mocked request/response objects and supports getting OSGi services from the <a href="/documentation/development/osgi-mock.html">mocked OSGi</a> environment.</li>
  <li>Implementations of the servlet-related Sling API classes like <code>SlingHttpServletRequest</code> and <code>SlingHttpServletRequest</code></li>
  <li>It is possible to set request data to simulate a certain Sling HTTP request</li>
  <li>Support for Sling Models (Sling Models API 1.1 and Impl 1.1 or higher required)</li>
  <li>Additional services <code>MimeTypeService</code></li>
  <li>Context Plugins</li>
</ul>
<p>The following features are <em>not supported</em>:</p>
<ul>
  <li>It is not possible (nor intended) to really execute sling components/scripts and render their results.</li>
  <li>The goal is to test supporting classes in Sling context, not the sling components/scripts themselves</li>
</ul>
<h3>Additional features</h3>
<p>Additional features provided:</p>
<ul>
  <li><code>SlingContext</code> JUnit Rule for easily setting up a Sling Mock environment in your JUnit test cases</li>
  <li><code>ContentLoader</code> supports importing JSON data and binary data into the mock resource hierarchy to easily prepare a test fixture consisting of a hierarchy of resources and properties.</li>
  <li>The same JSON format can be used that is provided by the Sling GET servlet for output</li>
  <li><code>ContentBuilder</code> and <code>ResourceBuilder</code> make it easier to create resources and properties as test fixture</li>
</ul>
<h2>Usage</h2>
<h3>Sling Context JUnit Rule</h3>
<p>The Sling mock context can be injected into a JUnit test using a custom JUnit rule named <code>SlingContext</code>. This rules takes care of all initialization and cleanup tasks required to make sure all unit tests can run independently (and in parallel, if required).</p>
<p>Example:</p>
<h1>!java</h1>
<p>public class ExampleTest {</p>
<p>@Rule public final SlingContext context = new SlingContext();</p>
<p>@Test public void testSomething() { Resource resource = context.resourceResolver().getResource("/content/sample/en"); // further testing }</p>
<p>}</p>
<p>It is possible to combine such a unit test rule with a <code>@RunWith</code> annotation e.g. for <a href="http://mockito.github.io/mockito/docs/current/org/mockito/runners/MockitoJUnitRunner.html">Mockito JUnit Runner</a>.</p>
<p>The <code>SlingContext</code> object provides access to mock implementations of:</p>
<ul>
  <li>OSGi Component Context</li>
  <li>OSGi Bundle Context</li>
  <li>Sling Resource Resolver</li>
  <li>Sling Request</li>
  <li>Sling Response</li>
  <li>Sling Script Helper</li>
</ul>
<p>Additionally it supports:</p>
<ul>
  <li>Registering OSGi services</li>
  <li>Registering adapter factories</li>
  <li>Accessing ContentLoader, and ContentBuilder and ResourceBuilder</li>
</ul>
<h3>Choosing Resource Resolver Mock Type</h3>
<p>The Sling mock context supports different resource resolver types. Example:</p>
<h1>!java</h1>
<p>public class ExampleTest {</p>
<p>@Rule public final SlingContext context = new SlingContext(ResourceResolverType.RESOURCERESOLVER_MOCK);</p>
<p>}</p>
<p>Different resource resolver mock types are supported with pros and cons, see next chapter for details.</p>
<h3>Resource Resolver Types</h3>
<p>The Sling Mocks resource resolver implementation supports different "types" of adapters for the mocks. Depending on the type an underlying JCR repository is used or not, and the data is stored in-memory or in a real repository.</p>
<p>Resource resolver types currently supported:</p>
<p><strong>RESOURCERESOLVER_MOCK (default)</strong></p>
<ul>
  <li>Simulates an In-Memory resource tree, does not provide adaptions to JCR API.</li>
  <li>Based on the <a href="/documentation/development/resourceresolver-mock.html">Sling resourceresolver-mock implementation</a> implementation</li>
  <li>You can use it to make sure the code you want to test does not contain references to JCR API.</li>
  <li>Behaves slightly different from JCR resource mapping e.g. handling binary and date values.</li>
  <li>This resource resolver type is very fast because data is stored in memory and no JCR mapping is applied.</li>
</ul>
<p><strong>JCR_MOCK</strong></p>
<ul>
  <li>Based on the <a href="/documentation/development/jcr-mock.html">JCR Mocks</a> implementation</li>
  <li>Uses the productive <a href="http://svn.apache.org/repos/asf/sling/trunk/bundles/jcr/resource">Sling JCR resource provider implementation</a> internally to do the Resource-JCR mapping</li>
  <li>Is quite fast because data is stored only in-memory</li>
</ul>
<p><strong>NONE</strong></p>
<ul>
  <li>Uses the productive Sling resource factory implementation without any ResourceProvider. You have to register one yourself to do anything useful with it.</li>
  <li>The performance of this resource resolver type depends on the resource provider registered.</li>
  <li>This is useful if you want to test your own resource provides mapped to root without any JCR.</li>
</ul>
<p><strong>JCR_OAK</strong></p>
<ul>
  <li>Uses a real JCR Jackrabbit Oak implementation based on the <code>MemoryNodeStore</code></li>
  <li>Full JCR/Sling features supported e.g. observations manager, transactions, versioning</li>
  <li>Uses the productive <a href="http://svn.apache.org/repos/asf/sling/trunk/bundles/jcr/resource">Sling JCR resource provider implementation</a> internally to do the Resource-JCR mapping</li>
  <li>Takes some seconds for startup on the first access</li>
  <li>Node types defined in OSGi bundle header 'Sling-Nodetypes' found in MANIFEST.MF files in the classpath are registered automatically.</li>
  <li>Lucene indexing is not included, thus fulltext search queries will return no result</li>
</ul>
<p>To use this type you have to declare an additional dependency in your test project:</p>
<h1>!xml</h1>
<p><dependency> <groupId>org.apache.sling</groupId> <artifactId>org.apache.sling.testing.sling-mock-oak</artifactId> <scope>test</scope> </dependency></p>
<p>See latest version on the <a href="/downloads.cgi">downloads page</a>.</p>
<p><strong>JCR_JACKRABBIT</strong></p>
<ul>
  <li>Uses a real JCR Jackrabbit implementation (not Oak) as provided by <a href="http://svn.apache.org/repos/asf/sling/trunk/bundles/commons/testing">sling/commons/testing</a></li>
  <li>Full JCR/Sling features supported e.g. observations manager, transactions, versioning</li>
  <li>Uses the productive <a href="http://svn.apache.org/repos/asf/sling/trunk/bundles/jcr/resource">Sling JCR resource provider implementation</a> internally to do the Resource-JCR mapping</li>
  <li>Takes some seconds for startup on the first access</li>
  <li>Node types defined in OSGi bundle header 'Sling-Nodetypes' found in MANIFEST.MF files in the classpath are registered automatically.</li>
</ul>
<p>To use this type you have to declare an additional dependency in your test project:</p>
<h1>!xml</h1>
<p><dependency> <groupId>org.apache.sling</groupId> <artifactId>org.apache.sling.testing.sling-mock-jackrabbit</artifactId> <scope>test</scope> </dependency></p>
<p>See latest version on the <a href="/downloads.cgi">downloads page</a>.</p>
<p><em>Remarks on the JCR_JACKRABBIT type:</em></p>
<ul>
  <li>The repository is not cleared for each unit test, so make sure to use a unique node path for each unit test. You may use the <code>uniquePath()</code> helper object of the SlingContext rule for this.</li>
  <li>The <a href="http://svn.apache.org/repos/asf/sling/trunk/bundles/commons/testing">sling/commons/testing</a> dependency introduces a lot of further dependencies from jackrabbit and others, be careful that they do not conflict and are imported in the right order in your test project</li>
</ul>
<h3>Sling Resource Resolver</h3>
<p>Example:</p>
<h1>!java</h1>
<p>// get a resource resolver ResourceResolver resolver = MockSling.newResourceResolver();</p>
<p>// get a resource resolver backed by a specific repository type ResourceResolver resolver = MockSling.newResourceResolver(ResourceResolverType.JCR_MOCK);</p>
<p>If you use the <code>SlingContext</code> JUnit rule you case just use <code>context.resourceResolver()</code>.</p>
<h3>Adapter Factories</h3>
<p>You can register your own or existing adapter factories to support adaptions e.g. for classes extending <code>SlingAdaptable</code>.</p>
<p>Example:</p>
<h1>!java</h1>
<p>// register adapter factory BundleContext bundleContext = MockOsgi.newBundleContext(); MockSling.setAdapterManagerBundleContext(bundleContext); bundleContext.registerService(myAdapterFactory);</p>
<p>// test adaption MyClass object = resource.adaptTo(MyClass.class);</p>
<p>// cleanup after unit test MockSling.clearAdapterManagerBundleContext();</p>
<p>Make sure you clean up the adapter manager bundle association after running the unit test otherwise it can interfere with the following tests. If you use the <code>SlingContext</code> JUnit rule this is done automatically for you.</p>
<p>If you use the <code>SlingContext</code> JUnit rule you case just use <code>context.registerService()</code>.</p>
<h3>SlingScriptHelper</h3>
<p>Example:</p>
<h1>!java</h1>
<p>// get script helper SlingScriptHelper scriptHelper = MockSling.newSlingScriptHelper();</p>
<p>// get request SlingHttpServletRequest request = scriptHelper.getRequest();</p>
<p>// get service MyService object = scriptHelper.getService(MyService.class);</p>
<p>To support getting OSGi services you have to register them via the <code>BundleContext</code> interface of the <a href="/documentation/development/jcr-mock.html">JCR Mocks</a> before. You can use an alternative factory method for the <code>SlingScriptHelper</code> providing existing instances of request, response and bundle context.</p>
<p>If you use the <code>SlingContext</code> JUnit rule you case just use <code>context.slingScriptHelper()</code>.</p>
<h3>SlingHttpServletRequest</h3>
<p>Example for preparing a sling request with custom request data:</p>
<h1>!java</h1>
<p>// prepare sling request ResourceResolver resourceResolver = MockSling.newResourceResolver(); MockSlingHttpServletRequest request = new MockSlingHttpServletRequest(resourceResolver);</p>
<p>// simulate query string request.setQueryString("param1=aaa&amp;param2=bbb");</p>
<p>// alternative - set query parameters as map request.setParameterMap(ImmutableMap.&lt;String,Object&gt;builder() .put("param1", "aaa") .put("param2", "bbb") .build());</p>
<p>// set current resource request.setResource(resourceResolver.getResource("/content/sample"));</p>
<p>// set sling request path info properties MockRequestPathInfo requestPathInfo = (MockRequestPathInfo)request.getRequestPathInfo(); requestPathInfo.setSelectorString("selector1.selector2"); requestPathInfo.setExtension("html");</p>
<p>// set method request.setMethod(HttpConstants.METHOD_POST);</p>
<p>// set attributes request.setAttribute("attr1", "value1");</p>
<p>// set headers request.addHeader("header1", "value1");</p>
<p>// set cookies request.addCookie(new Cookie("cookie1", "value1"));</p>
<h3>SlingHttpServletResponse</h3>
<p>Example for preparing a sling response which can collect the data that was written to it:</p>
<h1>!java</h1>
<p>// prepare sling response MockSlingHttpServletResponse response = new MockSlingHttpServletResponse();</p>
<p>// execute your unit test code that writes to the response...</p>
<p>// validate status code assertEquals(HttpServletResponse.SC_OK, response.getStatus());</p>
<p>// validate content type and content length assertEquals("text/plain;charset=UTF-8", response.getContentType()); assertEquals(CharEncoding.UTF_8, response.getCharacterEncoding()); assertEquals(55, response.getContentLength());</p>
<p>// validate headers assertTrue(response.containsHeader("header1")); assertEquals("5", response.getHeader("header2"));</p>
<p>// validate response body as string assertEquals(TEST_CONTENT, response.getOutputAsString());</p>
<p>// validate response body as binary data assertArrayEquals(TEST_DATA, response.getOutput());</p>
<h3>Import resource data from JSON file in classpath</h3>
<p>With the <code>ContentLoader</code> it is possible to import structured resource and property data from a JSON file stored in the classpath beneath the unit tests. This data can be used as text fixture for unit tests.</p>
<p>Example JSON data:</p>
<h1>!json</h1>
<p>{ "jcr:primaryType": "app:Page", "jcr:content": { "jcr:primaryType": "app:PageContent", "jcr:title": "English", "app:template": "/apps/sample/templates/homepage", "sling:resourceType": "sample/components/homepage", "jcr:createdBy": "admin", "jcr:created": "Thu Aug 07 2014 16:32:59 GMT+0200", "par": { "jcr:primaryType": "nt:unstructured", "sling:resourceType": "foundation/components/parsys", "colctrl": { "jcr:primaryType": "nt:unstructured", "layout": "2;colctrl-lt0", "sling:resourceType": "foundation/components/parsys/colctrl" } } } }</p>
<p>Example code to import the JSON data:</p>
<h1>!java</h1>
<p>context.load().json("/sample-data.json", "/content/sample/en");</p>
<p>This codes creates a new resource at <code>/content/sample/en</code> (and - if not existent - the parent resources) and imports the JSON data to this node. It can be accessed using the Sling Resource or JCR API afterwards.</p>
<h3>Import binary data from file in classpath</h3>
<p>With the <code>ContentLoader</code> it is possible to import a binary file stored in the classpath beneath the unit tests. The data is stored using a nt:file/nt:resource or nt:resource node type.</p>
<p>Example code to import a binary file:</p>
<h1>!java</h1>
<p>context.load().binaryFile("/sample-file.gif", "/content/binary/sample-file.gif");</p>
<p>This codes creates a new resource at <code>/content/binary/sample-file.gif</code> (and - if not existent - the parent resources) and imports the binary data to a jcr:content subnode.</p>
<h3>Building content</h3>
<p>Sling Mocks provides two alterantives for quickly building test content in the repository with as few code as possible. Sling Mocks provides two alternatives. Both are quite similar in their results, but follow different API concepts. You can choose whatever matches your needs and mix them as well.</p>
<ul>
  <li><code>ContentBuilder</code>: Part of Sling Mocks since its first release. If you need a references to each created resource this is the easiest way.</li>
  <li><code>ResourceBuilder</code>: Separate bundle that can also be used in integration tests or live instances. Supports a "fluent" API to create a bunch of resources in hierarchy at once.</li>
</ul>
<h4>Building content using <code>ContentBuilder</code></h4>
<p>The entry point for the <code>ContentBuilder</code> is the <code>create()</code> method on the Sling context.</p>
<p>Example:</p>
<h1>!java</h1>
<p>context.create().resource("/content/test1", ImmutableMap.&lt;String, Object&gt;builder() .put("prop1", "value1") .put("prop2", "value2") .build());</p>
<p>Simplified syntax without using a map:</p>
<h1>!java</h1>
<p>context.create().resource("/content/test1", "prop1", "value1", "prop2", "value2");</p>
<p>If you use the <code>SlingContext</code> JUnit rule you case just use <code>context.create()</code>.</p>
<h4>Building content using <code>ResourceBuilder</code></h4>
<p>The entry point for the <code>ResourceBuilder</code> is the <code>build()</code> method on the Sling context.</p>
<p>Example:</p>
<h1>!java</h1>
<p>context.build().resource("/content/test1") .siblingsMode() .resource("test1.1", "stringParam", "configValue1.1") .resource("test1.2", "stringParam", "configValue1.2") .resource("test1.2", "stringParam", "configValue1.3");</p>
<p>See JavaDocs of the class <code>org.apache.sling.resourcebuilder.api.ResourceBuilder</code> for a detailed documentation.</p>
<h3>Context Plugins</h3>
<p>Sling Mocks supports "Context Plugins" that hook into the lifecycle of each test run and can prepare test setup before or after the other setUp actions, and execute test tear down code before or after the other tearDown action.</p>
<p>To define a plugin implement the <code>org.apache.sling.testing.mock.osgi.context.ContextPlugin&lt;SlingContextImpl&gt;</code> interface. For convenience it is recommended to extend the abstract class <code>org.apache.sling.testing.mock.osgi.context.AbstractContextPlugin&lt;SlingContextImpl&gt;</code>. These plugins can be used with Sling Mock context, but also with context instances deriving from it like AEM Mocks. In most cases you would just override the <code>afterSetUp</code> method. In this method you can register additional OSGi services or do other preparation work. It is recommended to define a constant pointing to a singleton of a plugin instance for using it.</p>
<p>To use a plugin in your unit test class, use the <code>SlingContextBuilder</code> class instead of directly instantiating the <code>SlingContext</code>class. This allows you in a fluent style to configure more options, with the <code>plugin(...)</code> method you can add one or more plugins.</p>
<p>Example:</p>
<h1>!java</h1>
<p>@Rule public SlingContext context = new SlingContextBuilder().plugin(MY_PLUGIN).build();</p>
<p>More examples:</p>
<ul>
  <li><a href="https://github.com/apache/sling/blob/trunk/contrib/extensions/contextaware-config/testing/mocks/caconfig-mock-plugin/src/main/java/org/apache/sling/testing/mock/caconfig/ContextPlugins.java">Apache Sling Context-Aware Configuration Mock Plugin</a></li>
  <li><a href="https://github.com/apache/sling/blob/trunk/contrib/extensions/contextaware-config/testing/mocks/caconfig-mock-plugin/src/test/java/org/apache/sling/testing/mock/caconfig/ContextPluginsTest.java">Apache Sling Context-Aware Configuration Mock Plugin Test</a></li>
</ul></section></div></div>            
<div class="footer">
                <div class="timestamp">
                    TODO display revision number here
                </div><div class="trademarkFooter">
                    Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
                </div>
            </div>            
            
        </div>
    </body>
</html>
