<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: Logging</title>
        <link rel="icon" href="/res/favicon.ico"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
    </head>    <body>
<div class="title">
            <div class="logo">
                <a href="http://sling.apache.org">
                    <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                </a>
            </div><div class="header">
                <a href="http://www.apache.org">
                    <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                </a>
            </div>
        </div><div class="menu">
            <p>
                <strong><a href="/documentation.html">Documentation</a></strong><br/>
                <a href="/documentation/getting-started.html">Getting Started</a><br/>
                <a href="/documentation/the-sling-engine.html">The Sling Engine</a><br/>
                <a href="/documentation/development.html">Development</a><br/>
                <a href="/documentation/bundles.html">Bundles</a><br/>
                <a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a><br/>
                <a href="http://sling.apache.org/components/">Maven Plugins</a><br/>
                <a href="/documentation/configuration.html">Configuration</a>
                
            </p><p>
                <a href="http://s.apache.org/sling.wiki">Wiki</a><br/>
                <a href="http://s.apache.org/sling.faq">FAQ</a><br/>
                
            </p><p>
                <strong>API Docs</strong><br/>
                <a href="/apidocs/sling10/index.html">Sling 10</a><br/>
                <a href="/apidocs/sling9/index.html">Sling 9</a><br/>
                <a href="/documentation/apidocs.html">All versions</a><br/>
                
            </p><p>
                <strong>Project Info</strong><br/>
                <a href="/downloads.cgi">Downloads</a><br/>
                <a href="http://www.apache.org/licenses/">License</a><br/>
                <a href="/news.html">News</a><br/>
                <a href="/releases.html">Releases</a><br/>
                <a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a><br/>
                <a href="/links.html">Links</a><br/>
                <a href="/contributing.html">Contributing</a><br/>
                <a href="/project-information.html">Project Information</a><br/>
                <a href="/project-information/security.html">Security</a><br/>
                
            </p><p>
                <strong>Source</strong><br/>
                <a href="https://github.com/apache/?utf8=%E2%9C%93&q=sling">GitHub</a><br/>
                <a href="https://gitbox.apache.org/repos/asf?s=sling">Git at Apache</a><br/>
                
            </p><p>
                <strong><a href="/sitemap.html">Site Map</a></strong>
            </p><p>
                <strong>Apache Software Foundation</strong><br/>
                <a href="http://www.apache.org/foundation/thanks.html">Thanks!</a><br/>
                <a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a><br/>
                <a href="http://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a><br/>
                <a href="https://www.apache.org/events/current-event.html">
                    <img border="0" alt="Current ASF Events" src="https://www.apache.org/events/current-event-125x125.png" width="125px"/>
                </a><a href="http://apache.org/foundation/contributing.html">
                    <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125px"/>
                </a>
            </p>
        </div>        <div class="main">
            <div class="pagenav">
<div class="breadcrumbs">
                    <a href="/">
                        Home
                    </a>&nbsp;&raquo;&nbsp;<a href="/documentation.html">
                        Documentation
                    </a>&nbsp;&raquo;&nbsp;<a href="/documentation/development.html">
                        Development
                    </a>&nbsp;&raquo;&nbsp;
                </div>                
<div class="tags">
                    <a href="/tags/logging.html" class="label">
                        logging
                    </a> <a href="/tags/operations.html" class="label">
                        operations
                    </a> 
                </div>                
                
            </div><h1 class="pagetitle">
                Logging
            </h1><div id="generatedToC"></div><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=pagetitle],h2,h3'}); } );</script>
<div class="row"><div class="small-12 columns"><section class="wrap"><div class="note">
This document is for the new (November 2013) 4.x release of the Sling Commons Log components. Refer to
<a href="http://sling.apache.org/documentation/legacy/logging.html">Logging 3.x</a> for older versions.
</div>
<p><!-- TODO reactivate TOC once JBake moves to flexmark-java -->
</p>
<h2><a href="#introduction" name="introduction">Introduction</a></h2>
<p>Logging in Sling is supported by the <code>org.apache.sling.commons.log</code> bundle, which is one of the first bundles installed and started by the Sling Launcher. This bundle along with other bundles manages the Sling Logging and provides the following features:</p>
<ul>
  <li>Implements the OSGi Log Service Specification and registers the <code>LogService</code> and <code>LogReader</code> services</li>
  <li>Exports three commonly used logging APIs:</li>
  <li><a href="http://www.slf4j.org">Simple Logging Facade for Java (SLF4J)</a></li>
  <li><a href="http://jakarta.apache.org/commons/logging">Apache Commons Logging</a></li>
  <li><a href="http://logging.apache.org/log4j/index.html">log4j</a></li>
  <li><a href="http://download.oracle.com/javase/6/docs/api/java/util/logging/package-summary.html">java.util.logging</a></li>
  <li>Configures logging through Logback which is integrated with the OSGi environment</li>
  <li>Allows logging to be configured both via editing Logback xml or via OSGi Configurations</li>
</ul>
<h3><a href="#v5-0-0-release" name="v5-0-0-release">v5.0.0 release</a></h3>
<p>With Sling Log 5.0.0. release the webconsole support has been moved to a different bundle named Sling Commons Log WebConsole (org.apache.sling.commons.log.webconsole:1.0.0)</p>
<p>Also with this release Logback 1.1.7 version is embedded and thus it requires slf4j-api:1.7.15. See <a href="https://issues.apache.org/jira/browse/SLING-6144">SLING-6144</a> for details</p>
<h2><a href="#webconsole-plugin" name="webconsole-plugin">WebConsole Plugin</a></h2>
<p>The Web Console Plugin supports the following features:</p>
<ul>
  <li>Display the list of loggers which have levels or appenders configured.</li>
  <li>List the file appenders with the location of current active log files.</li>
  <li>Show the contents of LogBack config files.</li>
  <li>Show the contents of various Logback config fragments.</li>
  <li>Show Logback Status logs.</li>
  <li>Inline edit the Logger setting</li>
  <li>Configure Logger with content assist for logger names</li>
  <li>Provides links to log file content allows log file content to be viewed from Web UI</li>
</ul>
<img src="sling-log-support.png" />
<h2><a href="#webtail" name="webtail">WebTail</a></h2>
<p>The Web Console Plugin also supports tailing of the current active log files. It generates link to all active log files which can be used to see there content from within the browser. The url used is like</p>
<p><code>
http://localhost:8080/system/console/slinglog/tailer.txt?tail=1000&amp;grep=lucene&amp;name=%2Flogs%2Ferror.log
</code></p>
<p>It supports following parameters</p>
<ul>
  <li><code>name</code> - Appender name like <em>/logs/error.log</em></li>
  <li><code>tail</code> - Number of lines to include in dump. -1 to include whole file</li>
  <li><code>grep</code> - Filter the log lines based on <code>grep</code> value which can be
    <ul>
      <li>Simple string phrase - In this case search is done in case insensitive way via String.contains</li>
      <li>regex - In this case the search would be done via regex pattern matching</li>
    </ul>
  </li>
</ul>
<h2><a href="#initial-configuration" name="initial-configuration">Initial Configuration</a></h2>
<p>The <code>org.apache.sling.commons.log</code> bundle gets its initial configuration from the following <code>BundleContext</code> properties:</p>
<table>
  <thead>
    <tr>
      <th>Property </th>
      <th>Default </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>org.apache.sling.commons.log.level</code> </td>
      <td><code>INFO</code> </td>
      <td>Sets the initial logging level of the root logger. This may be any of the defined logging levels <code>DEBUG</code>, <code>INFO</code>, <code>WARN</code>, <code>ERROR</code> and <code>FATAL</code>. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.file</code> </td>
      <td>undefined </td>
      <td>Sets the log file to which log messages are written. If this property is empty or missing, log messages are written to <code>System.out</code>. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.file.number</code> </td>
      <td>5 </td>
      <td>The number of rotated files to keep. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.file.size</code> </td>
      <td>'.'yyyy-MM-dd </td>
      <td>Defines how the log file is rotated (by schedule or by size) and when to rotate. See the section <em>Log File Rotation</em> below for full details on log file rotation. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.pattern</code> </td>
      <td>{0,date,dd.MM.yyyy HH:mm:ss.SSS} *{4}* {2} {3} {5} </td>
      <td>The <code>MessageFormat</code> pattern to use for formatting log messages with the root logger. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.julenabled</code> </td>
      <td>n/a </td>
      <td>Enables the <code>java.util.logging</code> support. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.configurationFile</code> </td>
      <td>n/a </td>
      <td>Path for the Logback config file which would be used to configure logging. If the path is not absolute then it would be resolved against Sling Home </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.packagingDataEnabled</code> </td>
      <td>true </td>
      <td>Boolean property to control packaging data support of Logback. See <a href="http://www.slf4j.org/manual.html#mdc">Packaging Data</a> section of Logback for more details </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.numOfLines</code> </td>
      <td>1000 </td>
      <td>Number of lines from each log files to include while generating the dump in 'txt' mode. If set to -1 then whole file would be included </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.maxOldFileCountInDump</code> </td>
      <td>3 </td>
      <td>Maximum number of old rolled over files for each active file to be included while generating the dump as part of Status zip support </td>
    </tr>
    <tr>
      <td><code>sling.log.root</code> </td>
      <td>Sling Home </td>
      <td>The directory, which is used to resolve relative path names against. If not specified it would map to sling.home. Since <a href="https://issues.apache.org/jira/browse/SLING-4225">4.0.2</a></td>
    </tr>
  </tbody>
</table>
<h2><a href="#user-configuration-osgi-based" name="user-configuration-osgi-based">User Configuration - OSGi Based</a></h2>
<p>User Configuration after initial configuration is provided by the Configuration Admin Service. To this avail two <code>org.osgi.services.cm.ManagedServiceFactory</code> services are registered under the PIDs <code>org.apache.sling.commons.log.LogManager.factory.writer</code> and <code>org.apache.sling.commons.log.LogManager.factory.config</code> to receive configurations.</p>
<h3><a href="#logger-configuration" name="logger-configuration">Logger Configuration</a></h3>
<p>Loggers (or Categories) can be configured to log to specific files at specific levels using configurable patterns. To this avail factory configuration instances with factory PID <code>org.apache.sling.commons.log.LogManager.factory.config</code> may be created and configured with the Configuration Admin Service.</p>
<p>The following properties may be set:</p>
<table>
  <thead>
    <tr>
      <th>Property </th>
      <th>Type </th>
      <th>Default </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>org.apache.sling.commons.log.level</code> </td>
      <td><code>String</code> </td>
      <td><code>INFO</code> </td>
      <td>Sets the logging level of the loggers. This may be any of the defined logging levels <code>DEBUG</code>, <code>INFO</code>, <code>WARN</code>, <code>ERROR</code> and <code>FATAL</code>. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.file</code> </td>
      <td><code>String</code> </td>
      <td>undefined </td>
      <td>Sets the log file to which log messages are written. If this property is empty or missing, log messages are written to <code>System.out</code>. This property should refer to the file name of a configured Log Writer (see below). If no Log Writer is configured with the same file name an implicit Log Writer configuration with default configuration is created. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.pattern</code> </td>
      <td><code>String</code> </td>
      <td>{0,date,dd.MM.yyyy HH:mm:ss.SSS} *{4}* {2} {3} {5} </td>
      <td>The <code>java.util.MessageFormat</code> pattern to use for formatting log messages with the root logger. This is a <code>java.util.MessageFormat</code> pattern supporting up to six arguments: {0} The timestamp of type <code>java.util.Date</code>, {1} the log marker, {2} the name of the current thread, {3} the name of the logger, {4} the log level and {5} the actual log message. If the log call includes a Throwable, the stacktrace is just appended to the message regardless of the pattern. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.names</code> </td>
      <td><code>String[]</code> </td>
      <td> </td>
      <td>A list of logger names to which this configuration applies. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.additiv</code> </td>
      <td><code>Boolean</code> </td>
      <td>false </td>
      <td>If set to false then logs from these loggers would not be sent to any appender attached higher in the hierarchy </td>
    </tr>
  </tbody>
</table>
<p>Note that multiple Logger Configurations may refer to the same Log Writer Configuration. If no Log Writer Configuration exists whose file name matches the file name set on the Logger Configuration an implicit Log Writer Configuration with default setup (daily log rotation) is internally created. While the log level configuration is case insensitive, it is suggested to always use upper case letters.</p>
<h3><a href="#log-writer-configuration" name="log-writer-configuration">Log Writer Configuration</a></h3>
<p>Log Writer Configuration is used to setup file output and log file rotation characteristics for log writers used by the Loggers.</p>
<p>The following properties may be set:</p>
<table>
  <thead>
    <tr>
      <th>Property </th>
      <th>Default </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>org.apache.sling.commons.log.file</code> </td>
      <td>undefined </td>
      <td>Sets the log file to which log messages are written. If this property is empty or missing, log messages are written to <code>System.out</code>. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.file.number</code> </td>
      <td>5 </td>
      <td>The number of rotated files to keep. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.commons.log.file.size</code> </td>
      <td>'.'yyyy-MM-dd </td>
      <td>Defines how the log file is rotated (by schedule or by size) and when to rotate. See the section <em>Log File Rotation</em> below for full details on log file rotation. </td>
    </tr>
  </tbody>
</table>
<p>Note that any log writer config should not refer to same log file which is referred in global config i.e. OSGi config pid for <code>org.apache.sling.commons.log.LogManager</code></p>
<p>See the section <em>Log File Rotation</em> below for full details on the <code>org.apache.sling.commons.log.file.size</code> and <code>org.apache.sling.commons.log.file.number</code> properties.</p>
<h4><a href="#log-file-rotation" name="log-file-rotation">Log File Rotation</a></h4>
<p>Log files can grow rather quickly and fill up available disk space. To cope with this growth log files may be rotated in two ways: At specific times or when the log file reaches a configurable size. The first method is called <em>Scheduled Rotation</em> and is used by specifying a <code>SimpleDateFormat</code> pattern as the log file "size". The second method is called <em>Size Rotation</em> and is used by setting a maximum file size as the log file size.</p>
<p>As of version 2.0.6 of the Sling Commons Log bundle, the default value for log file scheduling is <code>&#39;.&#39;yyyy-MM-dd</code> causing daily log rotation. In previous version, log rotation defaults to a 10MB file size limit.</p>
<h5><a href="#scheduled-rotation" name="scheduled-rotation">Scheduled Rotation</a></h5>
<p>The rolling schedule is specified by setting the <code>org.apache.sling.commons.log.file.size</code> property to a <code>java.text.SimpleDateFormat</code> pattern. Literal text (such as a leading dot) to be included must be <em>enclosed</em> within a pair of single quotes. A formatted version of the date pattern is used as the suffix for the rolled file name. Internally the Log bundle configures a <code>TimeBasedRollingPolicy</code> for the appender. Refer to <a href="http://logback.qos.ch/manual/appenders.html#TimeBasedRollingPolicy">TimeBasedRollingPolicy</a> for more details around the pattern format</p>
<p>For example, if the log file is configured as <code>/foo/bar.log</code> and the pattern set to <code>&#39;.&#39;yyyy-MM-dd</code>, on 2001-02-16 at midnight, the logging file <code>/foo/bar.log</code> will be renamed to <code>/foo/bar.log.2001-02-16</code> and logging for 2001-02-17 will continue in a new <code>/foo/bar.log</code> file until it rolls over the next day.</p>
<p>It is possible to specify monthly, weekly, half-daily, daily, hourly, or minutely rollover schedules.</p>
<table>
  <thead>
    <tr>
      <th>DatePattern </th>
      <th>Rollover schedule </th>
      <th>Example </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>&#39;.&#39;yyyy-MM</code> </td>
      <td>Rollover at the beginning of each month </td>
      <td>At midnight of May 31st, 2002 <code>/foo/bar.log</code> will be copied to <code>/foo/bar.log.2002-05</code>. Logging for the month of June will be output to <code>/foo/bar.log</code> until it is also rolled over the next month. </td>
    </tr>
    <tr>
      <td><code>&#39;.&#39;yyyy-ww</code> </td>
      <td>Rollover at the first day of each week. The first day of the week depends on the locale. </td>
      <td>Assuming the first day of the week is Sunday, on Saturday midnight, June 9th 2002, the file <code>/foo/bar.log</code> will be copied to <code>/foo/bar.log.2002-23</code>. Logging for the 24th week of 2002 will be output to <code>/foo/bar.log</code> until it is rolled over the next week. </td>
    </tr>
    <tr>
      <td><code>&#39;.&#39;yyyy-MM-dd</code> </td>
      <td>Rollover at midnight each day.</td>
      <td>At midnight, on March 8th, 2002, <code>/foo/bar.log</code> will be copied to <code>/foo/bar.log.2002-03-08</code>. Logging for the 9th day of March will be output to <code>/foo/bar.log</code> until it is rolled over the next day.</td>
    </tr>
    <tr>
      <td><code>&#39;.&#39;yyyy-MM-dd-a</code> </td>
      <td>Rollover at midnight and midday of each day.</td>
      <td>at noon, on March 9th, 2002, <code>/foo/bar.log</code> will be copied to <code>/foo/bar.log.2002-03-09-AM</code>. Logging for the afternoon of the 9th will be output to <code>/foo/bar.log</code> until it is rolled over at midnight.</td>
    </tr>
    <tr>
      <td><code>&#39;.&#39;yyyy-MM-dd-HH</code> </td>
      <td>Rollover at the top of every hour.</td>
      <td>At approximately 11:00.000 o'clock on March 9th, 2002, <code>/foo/bar.log</code> will be copied to <code>/foo/bar.log.2002-03-09-10</code>. Logging for the 11th hour of the 9th of March will be output to <code>/foo/bar.log</code> until it is rolled over at the beginning of the next hour.</td>
    </tr>
    <tr>
      <td><code>&#39;.&#39;yyyy-MM-dd-HH-mm</code> </td>
      <td>Rollover at the beginning of every minute.</td>
      <td>At approximately 11:23,000, on March 9th, 2001, <code>/foo/bar.log</code> will be copied to <code>/foo/bar.log.2001-03-09-10-22</code>. Logging for the minute of 11:23 (9th of March) will be output to <code>/foo/bar.log</code> until it is rolled over the next minute.</td>
    </tr>
  </tbody>
</table>
<p>Do not use the colon ":" character in anywhere in the pattern option. The text before the colon is interpreted as the protocol specification of a URL which is probably not what you want.</p>
<p>Note that when using Scheduled Rotation purging of old log files  can be disabled by setting the property <code>org.apache.sling.commons.log.file.number</code> to '0'. </p>
<h5><a href="#size-rotation" name="size-rotation">Size Rotation</a></h5>
<p>Log file rotation by size is specified by setting the <code>org.apache.sling.commons.log.file.size</code> property to a plain number or a number plus a size multiplier. The size multiplier may be any of <code>K</code>, <code>KB</code>, <code>M</code>, <code>MB</code>, <code>G</code>, or <code>GB</code> where the case is ignored and the meaning is probably obvious.</p>
<p>When using Size Rotation, the <code>org.apache.sling.commons.log.file.number</code> defines the number of old log file generations to keep. For example to keep 5 old log files indexed by 0 through 4, set the <code>org.apache.sling.commons.log.file.number</code> to <code>5</code> (which happens to be the default).</p>
<h2><a href="#logback-integration" name="logback-integration">Logback Integration</a></h2>
<p>Logback integration provides following features</p>
<ul>
  <li>LogBack configuration can be provided via Logback config xml</li>
  <li>Supports Appenders registered as OSGi Services</li>
  <li>Supports Filters and TurboFilters registered as OSGi Services</li>
  <li>Support providing Logback configuration as fragments through OSGi Service Registry</li>
  <li>Support for referring to Appenders registered as OSGi services from with Logback config</li>
  <li>Exposes Logback runtime state through the Felix WebConsole Plugin</li>
</ul>
<p>The following sections provide more details.</p>
<h3><a href="#turbofilters-as-osgi-services" name="turbofilters-as-osgi-services">TurboFilters as OSGi Services</a></h3>
<p><a href="http://logback.qos.ch/manual/filters.html#TurboFilter">Logback TurboFilters</a> operate globally and are invoked for every Logback call. To register an OSGi <code>TurboFilter</code>, just to register an service that implements the <code>ch.qos.logback.classic.turbo.TurboFilter</code> interface.</p>
<pre><code>:<!-- TODO syntax marker (::java) disabled -->import import ch.qos.logback.classic.turbo.MatchingFilter;

SimpleTurboFilter stf = new SimpleTurboFilter();
ServiceRegistration sr  = bundleContext.registerService(TurboFilter.class.getName(), stf, null);

private static class SimpleTurboFilter extends MatchingFilter {
    @Override
    public FilterReply decide(Marker marker, Logger logger, Level level, String format,
     Object[] params, Throwable t) {
        if(logger.getName().equals(&quot;turbofilter.foo.bar&quot;)){
                return FilterReply.DENY;
        }
        return FilterReply.NEUTRAL;
    }
}
</code></pre>
<p>As these filters are invoked for every call they must execute quickly.</p>
<h3><a href="#filters-as-osgi-services" name="filters-as-osgi-services">Filters as OSGi services</a></h3>
<p><a href="http://logback.qos.ch/manual/filters.html">Logback Filters</a> are attached to appenders and are used to determine if any LoggingEvent needs to be passed to the appender. When registering a filter the bundle needs to configure a service property <code>appenders</code> which refers to list of appender names to which the Filter must be attached</p>
<pre><code>:<!-- TODO syntax marker (::java) disabled -->import ch.qos.logback.core.filter.Filter;

SimpleFilter stf = new SimpleFilter();
Dictionary&lt;String, Object&gt; props = new Hashtable&lt;String, Object&gt;();
props.put(&quot;appenders&quot;, &quot;TestAppender&quot;);
ServiceRegistration sr  = bundleContext.registerService(Filter.class.getName(), stf, props);

private static class SimpleFilter extends Filter&lt;ILoggingEvent&gt; {

    @Override
    public FilterReply decide(ILoggingEvent event) {
        if(event.getLoggerName().equals(&quot;filter.foo.bar&quot;)){
            return FilterReply.DENY;
        }
        return FilterReply.NEUTRAL;
    }
}
</code></pre>
<p>If the <code>appenders</code> value is set to <code>*</code> then the filter would be registered with all the appenders (<code>Since 4.0.4</code>)</p>
<h3><a href="#appenders-as-osgi-services" name="appenders-as-osgi-services">Appenders as OSGi services</a></h3>
<p><a href="http://logback.qos.ch/manual/appenders.html">Logback Appenders</a> handle the logging events produced by Logback. To register an OSGi <code>Appender</code>, just register a service that implements the <code>ch.qos.logback.core.Appender</code> interface. Such a service must have a <code>loggers</code> service property, which refers to list of logger names to which the Appender must be attached.</p>
<pre><code>:<!-- TODO syntax marker (::java) disabled -->Dictionary&lt;String,Object&gt; props = new Hashtable&lt;String, Object&gt;();

String[] loggers = {
        &quot;foo.bar:DEBUG&quot;,
        &quot;foo.bar.zoo:INFO&quot;,
};

props.put(&quot;loggers&quot;,loggers);
sr = bundleContext.registerService(Appender.class.getName(),this,props);
</code></pre>
<h3><a href="#logback-config-fragment-support" name="logback-config-fragment-support">Logback Config Fragment Support</a></h3>
<p>Logback supports including parts of a configuration file from another file (See <a href="http://logback.qos.ch/manual/configuration.html#fileInclusion">File Inclusion</a>). This module extends that support by allowing other bundles to provide config fragments. There are two ways to achieve that, described below.</p>
<h4><a href="#logback-config-fragments-as-string-objects" name="logback-config-fragments-as-string-objects">Logback config fragments as String objects</a></h4>
<p>If you have the config as string then you can register that String instance as a service with property <code>logbackConfig</code> set to true. The Sling Logback Extension monitors such objects and passes them to logback.</p>
<pre><code>:<!-- TODO syntax marker (::java) disabled -->Properties props = new Properties();
props.setProperty(&quot;logbackConfig&quot;,&quot;true&quot;);

String config = &quot;&lt;included&gt;\n&quot; +
        &quot;  &lt;appender name=\&quot;FOOFILE\&quot; class=\&quot;ch.qos.logback.core.FileAppender\&quot;&gt;\n&quot; +
        &quot;    &lt;file&gt;${sling.home}/logs/foo.log&lt;/file&gt;\n&quot; +
        &quot;    &lt;encoder&gt;\n&quot; +
        &quot;      &lt;pattern&gt;%d %-5level %logger{35} - %msg %n&lt;/pattern&gt;\n&quot; +
        &quot;    &lt;/encoder&gt;\n&quot; +
        &quot;  &lt;/appender&gt;\n&quot; +
        &quot;\n&quot; +
        &quot;  &lt;logger name=\&quot;foo.bar.include\&quot; level=\&quot;INFO\&quot;&gt;\n&quot; +
        &quot;       &lt;appender-ref ref=\&quot;FOOFILE\&quot; /&gt;\n&quot; +
        &quot;  &lt;/logger&gt;\n&quot; +
        &quot;\n&quot; +
        &quot;&lt;/included&gt;&quot;;

registration = context.registerService(String.class.getName(),config,props);
</code></pre>
<p>If the config needs to be updated just re-register the service so that changes are picked up.</p>
<h4><a href="#logback-config-fragments-as-configprovider-instances" name="logback-config-fragments-as-configprovider-instances">Logback config fragments as ConfigProvider instances</a></h4>
<p>Another way to provide config fragments is with services that implement the <code>org.apache.sling.commons.log.logback.ConfigProvider</code> interface.</p>
<pre><code>:<!-- TODO syntax marker (::java) disabled -->@Component
@Service
public class ConfigProviderExample implements ConfigProvider {
    public InputSource getConfigSource() {
        return new InputSource(getClass().getClassLoader().getResourceAsStream(&quot;foo-config.xml&quot;));
    }
}
</code></pre>
<p>If the config changes then sending an OSGi event with the <code>org/apache/sling/commons/log/RESET</code> topic resets the Logback runtime.</p>
<pre><code>:<!-- TODO syntax marker (::java) disabled -->eventAdmin.sendEvent(new Event(&quot;org/apache/sling/commons/log/RESET&quot;,new Properties()));
</code></pre>
<h3><a href="#external-config-file" name="external-config-file">External Config File</a></h3>
<p>Logback can be configured with an external file. The file name can be specified through</p>
<ol>
  <li>OSGi config - Look for a config with name <code>Apache Sling Logging Configuration</code> and specify the config file path.</li>
  <li>OSGi Framework Properties - Logback support also looks for a file named according to the OSGi framwork <code>org.apache.sling.commons.log.configurationFile</code> property.</li>
</ol>
<p>If you are providing an external config file then to support OSGi integration you need to add following action entry:</p>
<pre><code>:<!-- TODO syntax marker (::xml) disabled -->&lt;newRule pattern=&quot;*/configuration/osgi&quot;
         actionClass=&quot;org.apache.sling.commons.log.logback.OsgiAction&quot;/&gt;
&lt;newRule pattern=&quot;*/configuration/appender-ref-osgi&quot;
         actionClass=&quot;org.apache.sling.commons.log.logback.OsgiAppenderRefAction&quot;/&gt;
&lt;osgi/&gt;
</code></pre>
<p>The <code>osgi</code> element enables the OSGi integration support</p>
<h3><a href="#java-util-logging-jul-integration" name="java-util-logging-jul-integration">Java Util Logging (JUL) Integration</a></h3>
<p>The bundle also support <a href="http://www.slf4j.org/api/org/slf4j/bridge/SLF4JBridgeHandler.html">SLF4JBridgeHandler</a>. The two steps listed below enable the JUL integration. This allows for routing logging messages from JUL to the Logbback appenders.</p>
<ol>
  <li>Set the <code>org.apache.sling.commons.log.julenabled</code> framework property to true.</li>
</ol>
<p>If <code>org.apache.sling.commons.log.julenabled</code> is found to be true then <a href="http://logback.qos.ch/manual/configuration.html#LevelChangePropagator">LevelChangePropagator</a> would be registered automatically with Logback </p>
<h3><a name="config-override"></a>Configuring OSGi appenders in the Logback Config</h3>
<p>So far Sling used to configure the appenders based on OSGi config. This provides a very limited set of configuration options. To make use of other Logback features you can override the OSGi config from within the Logback config file. OSGi config based appenders are named based on the file name.</p>
<p>For example, for the following OSGi config</p>
<pre><code>org.apache.sling.commons.log.file=&quot;logs/error.log&quot;
org.apache.sling.commons.log.level=&quot;INFO&quot;
org.apache.sling.commons.log.file.size=&quot;&#39;.&#39;yyyy-MM-dd&quot;
org.apache.sling.commons.log.file.number=I&quot;7&quot;
org.apache.sling.commons.log.pattern=&quot;{0,date,dd.MM.yyyy HH:mm:ss.SSS} *{4}* [{2}] {3} {5}&quot;
</code></pre>
<p>The Logback appender would be named <code>logs/error.log</code>. To extend/override the config in a Logback config create an appender with the name <code>logs/error.log</code>:</p>
<pre><code>:<!-- TODO syntax marker (::xml) disabled -->&lt;appender name=&quot;/logs/error.log&quot; class=&quot;ch.qos.logback.core.FileAppender&quot;&gt;
  &lt;file&gt;${sling.home}/logs/error.log&lt;/file&gt;
  &lt;encoder&gt;
    &lt;pattern&gt;%d %-5level %X{sling.userId:-NA} [%thread] %logger{30} %marker- %msg %n&lt;/pattern&gt;
    &lt;immediateFlush&gt;true&lt;/immediateFlush&gt;
  &lt;/encoder&gt;
&lt;/appender&gt;
</code></pre>
<p>In this case the logging module creates an appender based on the Logback config instead of the OSGi config. This can be used to move the application from OSGi based configs to Logback based configs.</p>
<h2><a href="#using-slf4j-api-1-7" name="using-slf4j-api-1-7">Using Slf4j API 1.7</a></h2>
<p>With Slf4j API 1.7 onwards its possible to use logger methods with varargs i.e. log n arguments without constructing an object array e.g. <code>log.info(&quot;This is a test {} , {}, {}, {}&quot;,1,2,3,4)</code>. Without var args you need to construct an object array <code>log.info(&quot;This is a test {} , {}, {}, {}&quot;,new Object[] {1,2,3,4})</code>. To make use of this API and still be able to use your bundle on Sling systems which package older version of the API jar, follow the below steps. (See <a href="https://issues.apache.org/jira/browse/SLING-3243">SLING-3243</a>) for more details.</p>
<ol>
  <li>
    <p>Update the api version in the pom:</p>
    <pre><code>:<!-- TODO syntax marker (::xml) disabled -->&lt;dependencies&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
      &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
      &lt;version&gt;1.7.5&lt;/version&gt;
      &lt;scope&gt;provided&lt;/scope&gt;
    &lt;/dependency&gt;
   ...
&lt;/dependency&gt;
</code></pre>
  </li>
  <li>
    <p>Add an <code>Import-Package</code> instruction with a custom version range: </p>
    <pre><code>:<!-- TODO syntax marker (::xml) disabled -->&lt;build&gt;
    &lt;plugins&gt;
      &lt;plugin&gt;
        &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
        &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
        &lt;extensions&gt;true&lt;/extensions&gt;
        &lt;configuration&gt;
          &lt;instructions&gt;
            ...
            &lt;Import-Package&gt;
              org.slf4j;version=&quot;[1.5,2)&quot;,
              *
            &lt;/Import-Package&gt;
          &lt;/instructions&gt;
        &lt;/configuration&gt;
      &lt;/plugin&gt;
      ...
   &lt;/plugins&gt;
&lt;/build&gt;
</code></pre>
  </li>
</ol>
<p>The Slf4j API bundle 1.7.x is binary compatible with 1.6.x.</p>
<p>This setup allows your bundles to make use of the var args feature while making logging calls, but the bundles can still be deployed on older systems which provide only the 1.6.4 version of the slf4j api.</p>
<h2><a href="#log-tracer" name="log-tracer">Log Tracer</a></h2>
<p>Log Tracer provides support for enabling the logs for specific category at specific level and only for specific request. It provides a very fine level of control via config provided as part of HTTP request around how the logging should be performed for given category.</p>
<p>Refer to <a href="/documentation/bundles/log-tracers.html">Log Tracer Doc</a> for more details</p>
<h2><a href="#slf4j-mdc" name="slf4j-mdc">Slf4j MDC</a></h2>
<p>Sling MDC Inserting Filter exposes various request details as part of <a href="http://www.slf4j.org/manual.html#mdc">MDC</a>.</p>
<p>Currently it exposes following variables:</p>
<ol>
  <li><code>req.remoteHost</code> - Request remote host</li>
  <li><code>req.userAgent</code> - User Agent Header</li>
  <li><code>req.requestURI</code> - Request URI</li>
  <li><code>req.queryString</code> - Query String from request</li>
  <li><code>req.requestURL</code> -</li>
  <li><code>req.xForwardedFor</code> -</li>
  <li><code>sling.userId</code> - UserID associated with the request. Obtained from ResourceResolver</li>
  <li><code>jcr.sessionId</code> - Session ID of the JCR Session associated with current request.</li>
</ol>
<p>The filter also allow configuration to extract data from request cookie, header and parameters. Look for configuration with name 'Apache Sling Logging MDC Inserting Filter' for details on specifying header, cookie, param names.</p>
<p><img src="/documentation/bundles/mdc-filter-config.png" alt="MDC Filter Config" /></p>
<a name="mdc-pattern">
<h3><a href="#including-mdc-in-log-message" name="including-mdc-in-log-message">Including MDC in Log Message</a></h3>
<p>To include the MDC value in log message you MUST use the <a href="http://logback.qos.ch/manual/layouts.html#conversionWord">Logback pattern</a> based on Logback and not the old MessageFormat based pattern. </p>
<pre><code>%d{dd.MM.yyyy HH:mm:ss.SSS} *%p* [%X{req.remoteHost}] [%t] %c %msg%n
</code></pre>
<h3><a href="#installation" name="installation">Installation</a></h3>
<p>Download the bundle from <a href="http://sling.apache.org/downloads.cgi">here</a> or use following Maven dependency</p>
<pre><code><!-- TODO syntax marker (::xml) disabled -->&lt;dependency&gt;
    &lt;groupId&gt;org.apache.sling&lt;/groupId&gt;
    &lt;artifactId&gt;org.apache.sling.extensions.slf4j.mdc&lt;/artifactId&gt;
    &lt;version&gt;1.0.0&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h2><a href="#logback-groovy-fragment" name="logback-groovy-fragment">Logback Groovy Fragment</a></h2>
<p>This fragment is required to make use of Groovy based event evaluation support provided by Logback. This enables programatic filtering of the log messages and is useful to get desired logs without flooding the system. For example Oak logs the JCR operations being performed via a particular session. if this lo is enabled it would flood the log with messages from all the active session. However if you need logging only from session created in a particular thread then that can be done in following way</p>
<pre><code><!-- TODO syntax marker (::xml) disabled -->&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;configuration scan=&quot;true&quot; scanPeriod=&quot;1 second&quot;&gt;
  &lt;jmxConfigurator/&gt;
  &lt;newRule pattern=&quot;*/configuration/osgi&quot; actionClass=&quot;org.apache.sling.commons.log.logback.OsgiAction&quot;/&gt;
  &lt;newRule pattern=&quot;*/configuration/appender-ref-osgi&quot; actionClass=&quot;org.apache.sling.commons.log.logback.OsgiAppenderRefAction&quot;/&gt;
  &lt;osgi/&gt;

   &lt;appender name=&quot;OAK&quot; class=&quot;ch.qos.logback.core.FileAppender&quot;&gt;
    &lt;filter class=&quot;ch.qos.logback.core.filter.EvaluatorFilter&quot;&gt;      
      &lt;evaluator class=&quot;ch.qos.logback.classic.boolex.GEventEvaluator&quot;&gt; 
        &lt;expression&gt;&lt;![CDATA[
            return e.getThreadName().contains(&quot;JobHandler&quot;);
        ]]&gt;&lt;/expression&gt;
      &lt;/evaluator&gt;
      &lt;OnMismatch&gt;DENY&lt;/OnMismatch&gt;
      &lt;OnMatch&gt;ACCEPT&lt;/OnMatch&gt;
    &lt;/filter&gt;
    &lt;file&gt;${sling.home}/logs/oak.log&lt;/file&gt;
    &lt;encoder&gt;
      &lt;pattern&gt;%d %-5level [%thread] %marker- %msg %n&lt;/pattern&gt; 
      &lt;immediateFlush&gt;true&lt;/immediateFlush&gt;
    &lt;/encoder&gt;
  &lt;/appender&gt;

  &lt;logger name=&quot;org.apache.jackrabbit.oak.jcr.operations&quot; level=&quot;DEBUG&quot; additivity=&quot;false&quot;&gt;
      &lt;appender-ref ref=&quot;OAK&quot;/&gt;
  &lt;/logger&gt;
&lt;/configuration&gt;
</code></pre>
<p>Logback exposes a variable <code>e</code> which is of type <a href="http://logback.qos.ch/apidocs/ch/qos/logback/classic/spi/ILoggingEvent.html">ILoggingEvent</a>. It provides access to current logging event. Above logback config would route all log messages from <code>org.apache.jackrabbit.oak.jcr.operations</code> category to <code>${sling.home}/logs/oak.log</code>. Further only those log messages would be logged where the <code>threadName</code> contains <code>JobHandler</code>. Depending on the requirement the expression can be customised.</p>
<h3><a href="#installation" name="installation">Installation</a></h3>
<p>Currently the bundle is not released and has to be build from <a href="https://github.com/apache/sling-org-apache-sling-extensions-logback-groovy-fragment">here</a></p>
<pre><code><!-- TODO syntax marker (::xml) disabled -->&lt;dependency&gt;
    &lt;groupId&gt;org.apache.sling&lt;/groupId&gt;
    &lt;artifactId&gt;org.apache.sling.extensions.logback-groovy-fragment&lt;/artifactId&gt;
    &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<h2><a href="#faq" name="faq">FAQ</a></h2>
<h5><a href="#q-can-sling-commons-log-bundle-be-used-in-non-sling-environments" name="q-can-sling-commons-log-bundle-be-used-in-non-sling-environments">Q. Can Sling Commons Log bundle be used in non Sling environments</a></h5>
<p>This bundle does not depend on any other Sling bundle and can be easily used in any OSGi framework. To get complete log support working you need to deploy following bundles</p>
<ul>
  <li>Slf4j-Api - org.slf4j:slf4j-api</li>
  <li>Jcl over Slf4j - org.slf4j:jcl-over-slf4j</li>
  <li>Log4j over Slf4j - org.slf4j:log4j-over-slf4j</li>
  <li>Sling Log Service - org.apache.sling:org.apache.sling.commons.logservice:1.0.2</li>
  <li>Sling Commons Log - org.apache.sling:org.apache.sling.commons.log:4.0.0 or above</li>
  <li>Sling Log WebConsole - org.apache.sling.commons.log.webconsole:1.0.0 or above</li>
</ul>
<h5><a href="#q-how-to-start-sling-with-an-external-logback-xml-file" name="q-how-to-start-sling-with-an-external-logback-xml-file">Q. How to start Sling with an external logback.xml file</a></h5>
<p>You need to specify the location of logback.xml via <code>org.apache.sling.commons.log.configurationFile</code></p>
<pre><code>    java -jar org.apache.sling.starter-XXX-standalone.jar -Dorg.apache.sling.commons.log.configurationFile=/path/to/logback
</code></pre></section></div></div>            
            <div class="footer">
<div class="revisionInfo">
                    Last modified by <span class="author">Konrad Windszus</span> on <span class="comment">Fri Jul 13 11:08:10 2018 +0200</span>
                </div>                <p>
                    Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
                </p><p>
                    Copyright Â© 2007-2018 The Apache Software Foundation.
                </p>
            </div>
            
        </div>
    </body>
</html>