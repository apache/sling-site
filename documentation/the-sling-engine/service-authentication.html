<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: Service Authentication</title>
        <link rel="icon" href="/res/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <script src='https://www.apachecon.com/event-images/snippet.js'></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
    </head>    <body>
        <div class="section">
            <div class="level is-marginless">
<div class="logo">
                    <a href="https://sling.apache.org">
                        <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                    </a>
                </div><div class="header">
                    <a href="https://www.apache.org">
                        <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                    </a>
                </div>                
            </div><div class="columns is-gapless">
                <div class="column is-narrow sidemenu">
<div class="container">
                        <nav class="menu">
                            <ul class="menu-list box is-shadowless is-marginless">
                                <li>
                                    <p class="menu-label">
                                        <strong>Documentation</strong>
                                    </p><ul>
                                        <li><a href="/documentation.html">Overview</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>API Docs</strong>
                                    </p><ul>
                                        <li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Support</strong>
                                    </p><ul>
                                        <li><a href="https://s.apache.org/sling.wiki">Wiki</a></li><li><a href="https://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Sitemap</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Project Info</strong>
                                    </p><ul>
                                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="https://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Source</strong>
                                    </p><ul>
                                        <li><a href="/repolist.html">Repositories</a></li><li><a href="https://gitbox.apache.org/repos/asf?s=sling">Git at Apache</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Apache Software<br>Foundation</strong>
                                    </p><ul>
                                        <li><a href="https://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="https://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li>
                                    </ul>
                                </li><li>
                                    <a class="acevent" data-format="square" data-event="random"></a>
                                </li><li>
                                    <a href="https://apache.org/foundation/contributing.html" class="column">
                                        <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>                    
                </div><div class="column main">
                    <div class="box is-shadowless is-marginless">
                        <div class="level">
                            <div class="pagenav">
<div class="breadcrumb">
                                    <ul>
                                        <li>
                                            <a href="/">
                                                Home
                                            </a>
                                        </li><li>
                                            <a href="/documentation.html">
                                                Documentation
                                            </a>
                                        </li><li>
                                            <a href="/documentation/the-sling-engine.html">
                                                The Sling Engine
                                            </a>
                                        </li>
                                    </ul>
                                </div>                                
                            </div><div class="tags">
                                <span class="tag">
                                    <a href="/tags/authentication.html">
                                        authentication
                                    </a>
                                </span><span class="tag">
                                    <a href="/tags/serviceusers.html">
                                        serviceusers
                                    </a>
                                </span>
                            </div>
                        </div><h1 class="title">
                            Service Authentication
                        </h1><nav class="menu">
                            <ul class="menu-list box is-shadowless is-paddingless">
                                <li id="generatedToC">
                                    <p class="menu-label">
                                        <strong>Table of Contents</strong>
                                    </p>
                                </li>
                            </ul>
                        </nav><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=title],h2,h3','ulClass':'menu-list'}); } );</script><div class="content is-marginless">
<div class="row"><div><section><p><!-- TODO reactivate TOC once JBake moves to flexmark-java -->
</p>
<h2><a href="#problem" id="problem">Problem</a></h2>
<p>To access the data storage in the Resource Tree and/or the JCR Repository authentication is required to properly setup access control and guard sensitive data from unauthorized access. For regular request processing this authentication step is handled by the Sling <a href="/documentation/the-sling-engine/authentication.html">Authentication</a> subsystem.</p>
<p>On the other hand there are also some background tasks to be executed with access to the resources. Such tasks cannot in general be configured with user names and passwords: Neither hard coding the passwords in the code nor having the passwords in – more or less – plain text in some configuration is considered good practice.</p>
<p>To solve this problem for services to identify themselves and authenticate with special users properly configured to support those services.</p>
<p>The solution presented here serves the following goals:</p>
<ul>
<li>Prevent over-use and abuse of administrative ResourceResolvers and/or JCR Sessions</li>
<li>Allow services access to ResourceResolvers and/or JCR Sessions without requiring to hard-code or configure passwords</li>
<li>Allow services to use <em>service users</em> which have been specially configured for service level access (as is usually done on unixish systems)</li>
<li>Allow administrators to configure the assignment of service users to services</li>
</ul>
<h2><a href="#concept" id="concept">Concept</a></h2>
<p>A <em>Service</em> is a piece or collection of functionality. Examples of services are the Sling queuing system, Tenant Administration, or some Message Transfer System. Each service is identified by a unique <em>Service Name</em>. Since a service will  be implemented in an OSGi bundle (or a collection of OSGi bundles), services are named by the bundles providing them.</p>
<p>A Service may be comprised of multiple parts, so each part of the service may be further identified by a <em>Subservice Name</em>. This Subservice Name is optional, though. Examples of <em>Subservice Name</em> are names for subsystems in a Message Transfer System such as accepting messages, queueing messages, delivering messages.</p>
<p>Ultimately, the combination of the <em>Service Name</em> and <em>Subservice Name</em> defines the <em>Service ID</em>. It is the <em>Service ID</em> which is finally mapped to a Resource Resolver and/or JCR Repository user ID for authentication.</p>
<p>Thus the actual service identification (service ID) is defined as:</p>
<pre><code>service-id = service-name [ &quot;:&quot; subservice-name ] .
</code></pre>
<p>The <code>service-name</code> is the symbolic name of the bundle providing the service.</p>
<h3><a href="#example-tenant-administration" id="example-tenant-administration">Example: Tenant Administration</a></h3>
<p>Tenant Administration mostly deals with creating and managing groups and some other user administration tasks. Instead of just using an administrative session for Tenant administration this feature could define itself as being the <code>tenant-admin</code> service and leverage a properly configured Tenant Administration account.</p>
<h3><a href="#example-mail-transfer-system" id="example-mail-transfer-system">Example: Mail Transfer System</a></h3>
<p>Consider a Mail Transfer System which may be comprised of the following sub systems:</p>
<ul>
<li>Accepting mail for processing — for example the SMTP server daemon</li>
<li>Queing and processing the messages</li>
<li>Delivering messages to mailboxes</li>
</ul>
<p>You could conceive that all these functions serve different purposes and thus should have different access rights to the repository to persist messages while they are being processed.</p>
<p>Using the Service Authentication framework, the Mail Transfer System would be consituting the <code>mta</code> service. The sub systems would be called <code>smtp</code>, <code>queue</code>, and <code>deliver</code>.</p>
<p>Thus the SMTP server daemon would be represented by a user for the <code>mta:smtp</code> Service.  queueing with <code>mta:queue</code>, and delivery with <code>mta:deliver</code>.</p>
<h2><a href="#implementation" id="implementation">Implementation</a></h2>
<p>The implementation in Sling of the <em>Service Authentication</em> concept described above consists of three parts:</p>
<h3><a href="#serviceusermapper" id="serviceusermapper"><code>ServiceUserMapper</code></a></h3>
<p>The first part is a new OSGi Service <code>ServiceUserMapper</code>. The <code>ServiceUserMapper</code> service allows for mapping <em>Service IDs</em> comprised of the <em>Service Names</em> defined by the providing bundles and optional <em>Subservice Name</em> to ResourceResolver and/or JCR Repository principal names (<a href="https://issues.apache.org/jira/browse/SLING-6963">SLING-6963</a>) or user IDs (<a href="https://issues.apache.org/jira/browse/SLING-10321">SLING-10321</a>). This mapping is configurable such that system administrators are in full control of assigning users to services.</p>
<p>The <code>ServiceUserMapper</code> defines the following API:</p>
<pre><code><!-- TODO syntax marker (#!java) disabled -->Iterable&lt;String&gt; getServicePrincipalNames(Bundle bundle, String subServiceName);
</code></pre>
<p>The alternative API (getting service user ID as shown below) has been deprecated for security reasons and will be removed in future releases. See <a href="https://issues.apache.org/jira/browse/SLING-10321">SLING-10321</a> for details.</p>
<pre><code><!-- TODO syntax marker (#!java) disabled -->@Deprecated
String getServiceUserID(Bundle bundle, String subServiceName);
</code></pre>
<p>The implementation uses the following fallbacks in case no mapping can be found for the given subServiceName:</p>
<ol>
<li>Use user/principal mapping for the serviceName only (not considering subServiceName)</li>
<li>Use default user (if one is configured in the OSGi configuration for PID <code>org.apache.sling.serviceusermapping.impl.ServiceUserMapperImpl</code>).</li>
<li>Use default mapping (if it is enabled in the OSGi configuration for PID <code>org.apache.sling.serviceusermapping.impl.ServiceUserMapperImpl</code>) which looks up a user with id <code>serviceuser--&lt;bundleId&gt;[--&lt;subservice-name&gt;]</code> (since Service User Mapper 1.3.0, <a href="https://issues.apache.org/jira/browse/SLING-6772">SLING-6227</a>).</li>
</ol>
<p>In addition a service named <code>ServiceUserMapped</code> is registered for each bundle and subservice name for which a service user mapping is explicitly configured (<a href="https://issues.apache.org/jira/browse/SLING-4312">SLING-4312</a>).  By explicitly defining a (static) reference towards <code>ServiceUserMapped</code> one can defer starting the service until that service user mapping is available. Please note, that the two last default mappings are not represented as a ServiceUserMapped service and therefore the above mentioned reference does not work prior to version 1.4.4 (<a href="https://issues.apache.org/jira/browse/SLING-7930">SLING-7930</a>). Also since version 1.4.4 the <code>ServiceUserMapped</code> is only registered in case there is a valid user/principal found in the underlying repository which is given in the mapping (<a href="https://issues.apache.org/jira/browse/SLING-7930">SLING-7930</a>).</p>
<h4><a href="#validators-serviceprincipalsvalidator-and-serviceuservalidator" id="validators-serviceprincipalsvalidator-and-serviceuservalidator">Validators <code>ServicePrincipalsValidator</code> and <code>ServiceUserValidator</code></a></h4>
<p>The API defines two interfaces to validate principal names and user IDs defined in service user mappings each with a single method. The default <code>ServiceUserMapper</code> implementation allows to configure the set of required implementations that need to be consulted to verify the validity of a given mapping.</p>
<p><code>ServicePrincipalsValidator</code> validates mappings by principal names</p>
<pre><code> <!-- TODO syntax marker (#!java) disabled --> boolean isValid(Iterable&lt;String&gt; servicePrincipalNames, String serviceName, String subServiceName);
</code></pre>
<p><code>ServiceUserValidator</code> validates mappings by user ID</p>
<pre><code> <!-- TODO syntax marker (#!java) disabled --> boolean isValid(String serviceUserId, String serviceName, String subServiceName)
</code></pre>
<p>Module <em>sling-org-apache-sling-jcr-resource</em> defines <code>JcrSystemUserValidator</code> implementing both interfaces, which makes sure all mapped principal names or user IDs refer to an existing JCR system user.</p>
<h3><a href="#resourceresolverfactory" id="resourceresolverfactory"><code>ResourceResolverFactory</code></a></h3>
<p>The second part is support for service access to the Resource Tree. To this avail, the <code>ResourceResolverFactory</code> service is enhanced with a new factory method</p>
<pre><code><!-- TODO syntax marker (#!java) disabled -->ResourceResolver getServiceResourceResolver(Map&lt;String, Object&gt; authenticationInfo)
    throws LoginException;
</code></pre>
<p>This method allows for access to the resource tree for services where the service bundle is the bundle actually using the <code>ResourceResolverFactory</code> service. The optional Subservice Name may be provided as an entry in the <code>authenticationInfo</code> map.</p>
<p>In addition to having new API on the <code>ResourceResolverFactory</code> service to be used by services, the <code>ResourceProviderFactory</code> service is updated with support for Service Authentication: Now new API is required, though but additional properties are defined to convey the service to authenticate for.</p>
<p>The default implementation leverages <code>ServiceUserMapper.getServicePrincipalNames()</code> (and as fallback the deprecated <code>ServiceUserMapper.getServiceID()</code>) to resolve the principal names (fallback userID) and throws a <code>LoginException</code> in case no mapping has been setup (and none of the fallbacks described returned a valid user id either).</p>
<h3><a href="#slingrepository" id="slingrepository"><code>SlingRepository</code></a></h3>
<p>The third part is an extension to the <code>SlingRepository</code>service interface to support JCR Repository access for services:</p>
<pre><code><!-- TODO syntax marker (#!java) disabled -->Session loginService(String subServiceName, String workspace)
    throws LoginException, RepositoryException;
</code></pre>
<p>This method allows for access to the JCR Repository for services where the service bundle is the bundle actually using the <code>SlingRepository</code> service. The additional Subservice Name may be provided with the <code>subServiceName</code> parameter.</p>
<h2><a href="#configuration" id="configuration">Configuration</a></h2>
<h3><a href="#service-user-mappings" id="service-user-mappings">Service User Mappings</a></h3>
<p>For each service/subservice name combination an according mapping needs to be provided. The mapping binds a service name/subservice name to one or many principal names (since version 1.3.4, see <a href="https://issues.apache.org/jira/browse/SLING-6963">SLING-6963</a>). This is configured through an OSGi configuration for the factory configuration with PID <code>org.apache.sling.serviceusermapping.impl.ServiceUserMapperImpl.amended</code> (added in <a href="https://issues.apache.org/jira/browse/SLING-3578">SLING-3578</a>). There you can set one configuration property named <code>user.mapping</code> getting a String array as value where each entry must stick to the following format:</p>
<pre><code>&lt;service-name&gt;[:&lt;subservice-name&gt;]=&quot;[&quot;&lt;principal name of a JCR system user&gt;{&quot;,&quot;&lt;principal name of a JCR system user&gt;}&quot;]&quot;   
</code></pre>
<p>The alternative mapping by ID has been deprecated (see: <a href="https://issues.apache.org/jira/browse/SLING-10321">SLING-10321</a>) and will be disabled in the future.</p>
<pre><code>&lt;service-name&gt;[:&lt;subservice-name&gt;]=&lt;id of a JCR system user&gt;
</code></pre>
<p>The principal based mapping (enclosed in square brackets) is in general faster than the id based variant. It allows to directly reference multiple service user principals and avoids resolving group memberships. This provides full control over effective permissions granted to the service and prevents privilege escalations through changing group permissions.</p>
<p>The JCR system user whose principal name or ID is mapped must exist at the point in time where <code>ResourceResolverFactory.getServiceResourceResolver(...)</code> or <code>SlingRepository.loginService(...)</code> is called. If you rely on one of those methods in your <code>activate</code> method of an OSGi component you should make sure that you defer starting your OSGi component until the according service user mapping is in place. For that you can reference the OSGi service <code>ServiceUserMapped</code> (see Section <code>ServiceUserMapper</code> above for details), optionally with a target filter on property <code>subServiceName</code> (in case such a subservice name is used). The service <code>ServiceUserMapped</code> does not expose any methods but is only a marker interface exclusively used to defer starting of other OSGi components.</p>
<p>Example OSGi DS Component</p>
<pre><code><!-- TODO syntax marker (::java) disabled -->@Component(
    reference = {
        // this waits with the activation of this component until a service user mapping with the service name = current bundle's id and the sub service name 'my-subservice-name' is available.
        // you can leave out &quot;target&quot; if the sub service name is not used.
        // Please note that this only waits for the mapping to be available, it does not wait for the service user itself to be available!
        @Reference(name =&quot;scriptsServiceUser&quot;, target=&quot;(subServiceName=my-subservice-name)&quot;, service=ServiceUserMapped.class)
    }
)
class MyComponent {
}
</code></pre>
<h2><a href="#deprecation-of-administrative-authentication" id="deprecation-of-administrative-authentication">Deprecation of administrative authentication</a></h2>
<p>Originally the <code>ResourceResolverFactory.getAdministrativeResourceResolver</code> and <code>SlingRepository.loginAdministrative</code> methods have been defined to provide access to the resource tree and JCR Repository. These methods proved to be inappropriate because they allow for much too broad access.</p>
<p>Consequently these methods are being deprecated and will be removed in future releases of the service implementations.</p>
<p>The following methods are deprecated:</p>
<ul>
<li><code>ResourceResolverFactory.getAdministrativeResourceResolver</code></li>
<li><code>ResourceProviderFactory.getAdministrativeResourceProvider</code></li>
<li><code>SlingRepository.loginAdministrative</code></li>
</ul>
<p>The implementations we have in Sling's bundle will remain implemented in the near future. But there will be a configuration switch to disable support for these methods: If the method is disabled, a <code>LoginException</code> is always thrown from these methods. The JavaDoc of the methods is extended with this information.</p>
<h3><a href="#whitelisting-bundles-for-administrative-login" id="whitelisting-bundles-for-administrative-login">Whitelisting bundles for administrative login</a></h3>
<p>In order to be able to manage few (hopefully legit) uses of the above deprecated methods, a whitelisting mechanism was introduced with <a href="https://issues.apache.org/jira/browse/SLING-5135">SLING-5153</a> (<em>JCR Base 2.4.2</em>).</p>
<p>The recommended way to whitelist a bundle for administrative login is via a <em>whitelist fragment configuration</em>. It can be created as an OSGi factory configuration with the factoryPID <code>org.apache.sling.jcr.base.internal.LoginAdminWhitelist.fragment</code>. E.g. a typical configuration file might be called <code>org.apache.sling.jcr.base.internal.LoginAdminWhitelist.fragment-myapp.config</code> and could look as follows:</p>
<pre><code>whitelist.name=&quot;myapp&quot;
whitelist.bundles=[
    &quot;com.myapp.core&quot;,
    &quot;com.myapp.commons&quot;
]
</code></pre>
<table>
<thead>
<tr><th> Property            </th><th> Type     </th><th> Default     </th><th> Description </th></tr>
</thead>
<tbody>
<tr><td> <code>whitelist.name</code>    </td><td> String   </td><td> <code>[unnamed]</code> </td><td> Purely informational property that allows easy identification of different fragments. </td></tr>
<tr><td> <code>whitelist.bundles</code> </td><td> String[] </td><td> []          </td><td> An array of bundle symbolic names that should be allowed to make use of the administrative login functionality. </td></tr>
</tbody>
</table>
<p>All configured whitelist fragments are taken into account. This makes it easy to separate whitelists for different application layers and purposes.</p>
<p>For example, some Sling bundles need to be whitelisted, which could be done in a whitelist fragment named <code>sling</code>. In addition <code>myapp</code> adds a whitelist fragment called <code>myapp</code>. For integration tests and additional whitelist fragment <code>myapp-integration-testing</code> may be added.</p>
<p>Furthermore, there is a global configuration with PID <code>org.apache.sling.jcr.base.internal.LoginAdminWhitelist</code>, which should only be used in exceptional cases. It has a switch to turn administrative login on globally (<code>whitelist.bypass</code>) and it allows supplying a regular expression to whitelist matching bundle symbolic names (<code>whitelist.bundles.regexp</code>).</p>
<p>The regular expression is most useful for running PaxExam based tests, where bundle symbolic names follow a set pattern but have randomly generated parts.</p>
<p>Example: to whitelist all bundles generated by PaxExam a configuration file named <code>org.apache.sling.jcr.base.internal.LoginAdminWhitelist.config</code> might look as follows:</p>
<pre><code>whitelist.bypass=B&quot;false&quot;
whitelist.bundles.regexp=&quot;^PAXEXAM.*$&quot;
</code></pre>
<p>The configuration PID is <code>org.apache.sling.jcr.base.internal.LoginAdminWhitelist</code>. It supports the following configuration properties.</p>
<table>
<thead>
<tr><th> Property                   </th><th> Type     </th><th> Default     </th><th> Description </th></tr>
</thead>
<tbody>
<tr><td> <code>whitelist.bypass</code>         </td><td> Boolean  </td><td> false       </td><td> Allow all bundles to use administrative login. This is <strong>NOT</strong> recommended for production and warnings will be logged. </td></tr>
<tr><td> <code>whitelist.bundles.regexp</code> </td><td> String   </td><td> &quot;&quot;          </td><td> A regular expression that whitelists all matching bundle symbolic names. This is <strong>NOT</strong> recommended for production and warnings will be logged. </td></tr>
</tbody>
</table>
</section></div></div>                            
                        </div>
                    </div>
                </div>
            </div><footer class="footer">
                <div class="content has-text-centered is-small">
<div class="editpagelink">
                        This page can be edited on GitHub at <a href="https://github.com/apache/sling-site/edit/master/src/main/jbake/content/documentation/the-sling-engine/service-authentication.md">
                            content/documentation/the-sling-engine/service-authentication.md
                        </a>
                    </div>                    <div class="revisionInfo">
                        Last modified by <span class="author">angela</span> on <span class="comment">2021-04-21</span>
                    </div><p>
                        Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
                    </p><p>
                        Copyright © 2007-2021 The Apache Software Foundation.
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>