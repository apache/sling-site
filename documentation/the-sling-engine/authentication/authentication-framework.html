<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling on JBake</title>
        <link rel="icon" href="/ng/res/favicon.ico"/>
        <link rel="stylesheet" href="/ng/res/css/site.css"/>
        
    </head>    <body>
<div class="title">
            <div class="logo">
                <a href="http://sling.apache.org">
                    <img border="0" alt="Apache Sling" src="/ng/res/logos/sling.svg"/>
                </a>
            </div><div class="header">
                <a href="http://www.apache.org">
                    <img border="0" alt="Apache" src="/ng/res/logos/apache.png"/>
                </a>
            </div>
        </div><h1 class="draft">DRAFT 2017 WEBSITE - SLING-6955</h1><div class="menu">
            <p>
                <strong><a href="/ng/documentation.html">Documentation</a></strong><br/>
                <a href="/ng/documentation/getting-started.html">Getting Started</a><br/>
                <a href="/ng/documentation/the-sling-engine.html">The Sling Engine</a><br/>
                <a href="/ng/documentation/development.html">Development</a><br/>
                <a href="/ng/documentation/bundles.html">Bundles</a><br/>
                <a href="/ng/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a><br/>
                <a href="/ng/documentation/configuration.html">Configuration</a>
            </p><p>
                <a href="http://s.apache.org/sling.wiki">Wiki</a><br/>
                <a href="http://s.apache.org/sling.faq">FAQ</a><br/>
                
            </p><p>
                <strong>API Docs</strong><br/>
                <a href="/ng/apidocs/sling9/index.html">Sling 9</a><br/>
                <a href="/ng/apidocs/sling8/index.html">Sling 8</a><br/>
                <a href="/ng/apidocs/sling7/index.html">Sling 7</a><br/>
                <a href="/ng/apidocs/sling6/index.html">Sling 6</a><br/>
                <a href="/ng/apidocs/sling5/index.html">Sling 5</a><br/>
                <a href="/ng/javadoc-io.html">Archive at javadoc.io</a><br/>
                
            </p><p>
                <strong>Project info</strong><br/>
                <a href="/ng/downloads.cgi">Downloads</a><br/>
                <a href="http://www.apache.org/licenses/">License</a><br/>
                <a href="/ng/contributing.html">Contributing</a><br/>
                <a href="/ng/news.html">News</a><br/>
                <a href="/ng/links.html">Links</a><br/>
                <a href="/ng/project-information.html">Project Information</a><br/>
                <a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a><br/>
                <a href="/ng/project-information/security.html">Security</a><br/>
                
            </p><p>
                <strong>Source</strong><br/>
                <a href="http://svn.apache.org/viewvc/sling/trunk">Subversion</a><br/>
                <a href="git://git.apache.org/sling.git">Git</a><br/>
                <a href="https://github.com/apache/sling">Github Mirror</a><br/>
                
            </p><p>
                <strong>Sponsorship</strong><br/>
                <a href="http://www.apache.org/foundation/thanks.html">Thanks</a><br/>
                <a href="http://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a><br/>
                <a href="https://donate.apache.org/">Donate!</a><br/>
                <a href="http://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a><br/>
                
            </p><p>
                <strong><a href="/ng/sitemap.html">Site Map</a></strong>
            </p>
        </div>        <div class="main">
<div class="row"><div class="small-12 columns"><section class="wrap"><header><h1>Authentication - Framework</h1></header><p>Excerpt: The core piece of functionality with respect to authentication in Sling is contained in the Sling Auth Core bundle. This bundle provides the API for Sling and Sling applications to make use of authentication.</p>
<p>The core piece of functionality with respect to authentication in Sling is contained in the Sling Auth Core bundle. This bundle provides the API for Sling and Sling applications to make use of authentication.</p>
<p>This support encompasses three parts:</p>
<ul>
  <li>The <code>AuthenticationSupport</code> service provided by the <code>SlingAuthenticator</code> class. This service can be used by implementations of the OSGi <code>HttpContext</code> interface to delegate authentication.</li>
  <li>The <code>Authenticator</code> service also provided by the <code>SlingAuthenticator</code> class. This service may be used by Sling applications to help clients login and logout.</li>
  <li>The <code>AuthenticationHandler</code> service interface. These services may be implemented by extensions to support various ways for transporting credentials from clients to the Sling server.</li>
</ul>
<p>This page describes how the <code>SlingAuthenticator</code> class provides the <code>AuthenticationSupport</code> and <code>Authenticator</code> services. For a description of the <code>AuthenticationHandler</code> service interface and the interaction between the <code>SlingAuthenticator</code> and the <code>AuthenticationHandler</code> services refer to the <a href="/documentation/the-sling-engine/authentication/authentication-authenticationhandler.html">AuthenticationHandler</a> page.</p>
<p>The <code>SlingAuthenticator</code> class is an internal class of the <code>org.apache.sling.auth.core</code> bundle and implements the <code>Authenticator</code> and <code>AuthenticationSupport</code> services.</p>
<h2>AuthenticationSupport</h2>
<p>The <code>AuthenticationSupport</code> service interface defines a single method: <code>handleSecurity</code>. This method is intended to be called by the <code>handleSecurity</code> method of any <code>HttpContext</code> implementation wishing to make use of the Sling Authentication Framework.</p>
<p>The Sling Authenticator implementation selects an <code>AuthenticationHandler</code> service appropriate for the request and calls the <code>AuthenticationHandler.extractCredentials</code> method to extract the credentials from the request. If no credentials could be extracted, the Sling Authenticator either admits the request as an anonymous request or requests authentication from the client by calling its own <code>login</code> method.</p>
<p>The implementation follows this algorithm:</p>
<ol>
  <li>Select one or more <code>AuthenticationHandler</code> for the request according to the request URL's scheme and authorization part.</li>
  <li>Call the <code>extractCredentials</code> method of each authentication handler, where the order of handler call is defined by the length of the registered path: handlers registered with longer paths are called before handlers with shorter paths. The goal is to call the handlers in order from longest request path match to shortest match. Handlers not matching the request path at all are not called.</li>
  <li>The first handler returning a non-<code>null</code> <code>AuthenticationInfo</code> result "wins" and the result is used for authentication.</li>
  <li>If any <code>AuthenticationInfoPostProcessor</code> services are registered, the <code>AuthenticationInfo</code> object is passed to their <code>postProcess()</code> method.</li>
  <li>If no handler returns a non-<code>null</code> result, the request may be handled anonymously. In these cases, an empty <code>AuthenticationInfo</code> object is passed to any <code>AuthenticationInfoPostProcessor</code> services.</li>
  <li>(Try to) log into the repository either with the provided credentials or anonymously.</li>
  <li>If there were credentials provided and the login was successful, a login event is posted <em>if</em> the <code>AuthenticationInfo</code> object contains a non-null object with the key <code>$$auth.info.login$$</code> (<code>AuthConstants.AUTH_INFO_LOGIN</code>). This event is posted with the topic <code>org/apache/sling/auth/core/Authenticator/LOGIN</code>. (added in Sling Auth Core 1.1.0)</li>
  <li>Set request attributes listed below.</li>
</ol>
<p>Extracting the credentials and trying to login to the repository may yield the following results:</p>
<table>
  <thead>
    <tr>
      <th>Credentials </th>
      <th>Login </th>
      <th>Consequence </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>present </td>
      <td>successful </td>
      <td>Continue with an authenticated request </td>
    </tr>
    <tr>
      <td>present </td>
      <td>failed </td>
      <td>Select <code>AuthenticationHandler</code> and call <code>requestCredentials</code> method </td>
    </tr>
    <tr>
      <td>missing </td>
      <td>anonymous allowed </td>
      <td>Continue with a non authenticated request using anonymous access to the repository </td>
    </tr>
    <tr>
      <td>missing </td>
      <td>anonymous forbidden </td>
      <td>Select <code>AuthenticationHandler</code> and call <code>requestCredentials</code> method </td>
    </tr>
  </tbody>
</table>
<div class="note">
    Only one <code>AuthenticationHandler</code> is able to provide credentials for a given request. If the credentials provided by the handler cannot be used to login to the repository, authentication fails and no further <code>AuthenticationHandler</code> is consulted.
</div>
<h4>Request Attributes on Successful Login</h4>
<p>The <code>handleSecurity</code> method gets credentials from the <code>AuthenticationHandler</code> and logs into the JCR repository using those credentials. If the login is successful, the <code>SlingAuthenticator</code> sets the following request attributes:</p>
<table>
  <thead>
    <tr>
      <th>Attribute </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>org.osgi.service.http.authentication.remote.user</code> </td>
      <td>The user ID of the JCR Session. This attribute is used by the HTTP Service implementation to implement the <code>HttpServletRequest.getRemoteUser</code> method. </td>
    </tr>
    <tr>
      <td><code>org.osgi.service.http.authentication.type</code> </td>
      <td>The authentication type defined by the <code>AuthenticationHandler</code>. This attribute is used by the HTTP Service implementation to implement the <code>HttpServletRequest.getAuthType</code> method. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.auth.core.ResourceResolver</code> </td>
      <td>The <code>ResourceResolver</code> created from the credentials and the logged in JCR Session. This attribute may be used by servlets to access the repository. Namely the <code>SlingMainServlet</code> uses this request attribute to provide the <code>ResourceResolver</code> to handle the request. </td>
    </tr>
    <tr>
      <td><code>javax.jcr.Session</code> </td>
      <td>The JCR Session. This attribute is for backwards compatibility only. <em>Its use is deprecated and the attribute will be removed in future versions</em>. </td>
    </tr>
    <tr>
      <td><code>org.apache.sling.auth.core.spi.AuthenticationInfo</code> </td>
      <td>The <code>AuthenticationInfo</code> object produced from the <code>AuthenticationHandler</code>. </td>
    </tr>
  </tbody>
</table>
<p><strong>NOTE</strong>: Do <em>NOT</em> use the <code>javax.jcr.Session</code> request attribute in your Sling applications. This attribute must be considered implementation specific to convey the JCR Session to the <code>SlingMainServlet</code>. In future versions of the Sling Auth Core bundle, this request attribute will not be present anymore. To get the JCR Session for the current request adapt the request's resource resolver to a JCR Session:</p>
<pre><code>Session session = request.getResourceResolver().adaptTo(Session.class);
</code></pre>
<h4>Anonymous Login</h4>
<p>The <code>SlingAuthenticator</code> provides high level of control with respect to allowing anonymous requests or requiring authentication up front:</p>
<ul>
  <li>Global setting of whether anonymous requests are allowed or not. This is the boolean value of the <em>Allow Anonymous Access</em> (<code>auth.annonymous</code>) property of the <code>SlingAuthenticator</code> configuration. This property is supported for backwards compatibility and defaults to <code>true</code> (allowing anonymous access). Setting it to <code>true</code> is a shortcut for setting <code>sling.auth.requirements</code> to <code>-/</code>.</li>
  <li>Specific configuration per URL. The <em>Authentication Requirements</em> (<code>sling.auth.requirements</code>) property of the <code>SlingAuthenticator</code> configuration may provide a list of URLs for which authentication may be required or not: Any entry prefixed with a dash <code>-</code> defines a request path prefix for which authentication is not required. Any entry not prefixed with a dash or prefixed with a plus <code>+</code> defines a subtree for which authentication is required up front and thus anonymous access is not allowed. This list is empty by default.</li>
  <li>Any OSGi service may provide a <code>sling.auth.requirements</code> registration property which is used to dynamically extend the authentication requirements from the <em>Authentication Requirements</em> configuration. This may for example be set by <code>AuthenticationHandler</code> implementations providing a login form to ensure access to the login form does not require authentication. The value of this property is a single string, an array of strings or a Collection of strings and is formatted in the same way as the <em>Authentication Requirements</em> configuration property.</li>
</ul>
<p>The values set on the <em>Authentication Requirements</em> configuration property or the <code>sling.auth.requirements</code> service registration property can be absolute paths or URLs like the <code>path</code> service registration property of <code>AuthenticationHandler</code> services. This allows the limitation of this setup to certain requests by scheme and/or virtual host address. The requests path (<code>HttpServletRequest.getServletPath()</code> + <code>HttpServletRequest.getPathInfo()</code>) is afterwards matched against the given paths. It matches if it starts with one of the given paths.</p>
<p><strong>Examples</strong></p>
<ul>
  <li>The <code>LoginServlet</code> contained in the Sling Auth Core bundle registers itself with the service registration property <code>sling.auth.requirements = &quot;-/system/sling/login&quot;</code> to ensure the servlet can be accessed without requiring authentication (checks for <code>slash</code> or <code>dot</code> or <code>end of string</code>). The following request urls would work then without authentication:
    <ul>
      <li>/system/sling/login</li>
      <li>/system/sling/login.html</li>
      <li>/system/sling/login/somesuffix</li>
    </ul>
  </li>
</ul>
<p>While the following request will still require authentication </p>
<pre><code>* /system/sling/login-test 
</code></pre>
<ul>
  <li>An authentication handler may register itself with the service registration property <code>sling.auth.requirements = &quot;-/apps/sample/loginform&quot;</code> to ensure the login form can be rendered without requiring authentication.</li>
</ul>
<h2>Authenticator implementation</h2>
<p>The implementation of the <code>Authenticator</code> interface is similar for both methods:</p>
<p><strong><code>login</code></strong></p>
<ol>
  <li>Select one or more <code>AuthenticationHandler</code> for the request according to the request URL's scheme and authorization part.</li>
  <li>Call the <code>requestCredentials</code> method of each authentication handler, where the order of handler call is defined by the length of the registered path: handlers registered with longer paths are called before handlers with shorter paths. The goal is to call the handlers in order from longest request path match to shortest match. Handlers not matching the request path at all are not called.</li>
  <li>As soon as the first handlers returns <code>true</code>, the process ends and it is assumed credentials have been requested from the client.</li>
</ol>
<p>The <code>login</code> method has three possible exit states:</p>
<table>
  <thead>
    <tr>
      <th>Exit State </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Normal </td>
      <td>An <code>AuthenticationHandler</code> could be selected to which the login request could be forwarded. </td>
    </tr>
    <tr>
      <td><code>NoAuthenticationHandlerException</code> </td>
      <td>No <code>AuthenticationHandler</code> could be selected to forward the login request to. In this case, the caller can proceed as appropriate. For example a servlet, which should just login a user may send back a 403/FORBIDDEN status because login is not possible. Or a 404/NOT FOUND handler, which tried to login as a fallback, may continue and send back the regular 404/NOT FOUND response. </td>
    </tr>
    <tr>
      <td><code>IllegalStateException</code> </td>
      <td>The response has already been committed and the login request cannot be processed. Normally to request login, the current response must be reset and a new response has to be prepared. This is only possible if the request has not yet been committed. </td>
    </tr>
  </tbody>
</table>
<p><strong><code>logout</code></strong></p>
<ol>
  <li>Select one or more <code>AuthenticationHandler</code> for the request according to the request URL's scheme and authorization part.</li>
  <li>Call the <code>dropCredentials</code> method of each authentication handler, where the order of handler call is defined by the length of the registered path: handlers registered with longer paths are called before handlers with shorter paths. The goal is to call the handlers in order from longest request path match to shortest match. Handlers not matching the request path at all are not called.</li>
</ol>
<p>Unlike for the <code>login</code> method in the <code>logout</code> method case all <code>AuthenticationHandler</code> services selected in the first step are called. If none can be selected or none can actually handle the <code>dropCredentials</code> request, the <code>logout</code> silently returns.</p></section></div></div>            
<div class="footer">
                <div class="timestamp">
                    TODO display revision number here
                </div><div class="trademarkFooter">
                    Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
                </div>
            </div>            
            
        </div>
    </body>
</html>
