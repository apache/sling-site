<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: How to Create a Composite NodeStore with the Feature Model</title>
        <link rel="icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="/res/css/bulma.min.css"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <script src='https://www.apachecon.com/event-images/snippet.js'></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
	<!-- Matomo Web Analytics -->
	<script>
	var _paq = window._paq = window._paq || [];
	/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
	/* We explicitly disable cookie tracking to avoid privacy issues */
	_paq.push(['disableCookies']); 
	_paq.push(['trackPageView']);
	_paq.push(['enableLinkTracking']);
	(function() {
	  var u="https://matomo.privacy.apache.org/";
	  _paq.push(['setTrackerUrl', u+'matomo.php']);
	  _paq.push(['setSiteId', '6']);
	  var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
	  g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
	})();
	</script>
	<!-- End Matomo Code -->
	<link href='/pagefind/pagefind-ui.css' rel='stylesheet'><script src='/pagefind/pagefind-ui.js' type='text/javascript'></script>
	<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#searchbox" });
    });
	</script>
	
    </head>    <body>
        <div class="section">
            <div class="level is-marginless">
<div class="logo">
                    <a href="https://sling.apache.org">
                        <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                    </a>
                </div><div class="header asf-logo">
                    <a href="https://www.apache.org">
                        <img alt="Apache Software Foundation" src="https://apache.org/img/asf_logo.png"/>
                    </a>
                </div>                
            </div><section class="searchbox level is-marginless">
                <div id="searchbox"></div>
            </section><div class="columns is-gapless">
                <div class="column is-narrow sidemenu">
<div class="container">
                        <nav class="menu">
                            <ul class="menu-list box is-shadowless is-marginless">
                                <li>
                                    <p class="menu-label">
                                        <strong>Documentation</strong>
                                    </p><ul>
                                        <li><a href="/documentation.html">Overview</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>API Docs</strong>
                                    </p><ul>
                                        <li><a href="/apidocs/sling13/index.html">Sling 13</a></li><li><a href="/apidocs/sling12/index.html">Sling 12</a></li><li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Support</strong>
                                    </p><ul>
                                        <li><a href="https://s.apache.org/sling.wiki">Wiki</a></li><li><a href="https://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Sitemap</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Project Info</strong>
                                    </p><ul>
                                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="https://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Source</strong>
                                    </p><ul>
                                        <li><a href="/repolist.html">Repositories</a></li><li><a href="https://gitbox.apache.org/repos/asf#sling">Git at Apache</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Apache Software<br>Foundation</strong>
                                    </p><ul>
                                        <li><a href="https://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="https://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li>
                                    </ul>
                                </li><li>
                                    <a class="acevent" data-format="square" data-event="random"></a>
                                </li><li>
                                    <a href="https://apache.org/foundation/contributing.html" class="column">
                                        <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>                    
                </div><div class="column main">
                    <div class="box is-shadowless is-marginless">
                        <div class="level">
                            <div class="pagenav">
<div class="breadcrumb">
                                    <ul>
                                        <li>
                                            <a href="/">
                                                Home
                                            </a>
                                        </li><li>
                                            <a href="/documentation.html">
                                                Documentation
                                            </a>
                                        </li>
                                    </ul>
                                </div>                                
                            </div><div class="tags">
                                <span class="tag">
                                    <a href="/tags/featuremodel.html">
                                        featuremodel
                                    </a>
                                </span><span class="tag">
                                    <a href="/tags/sling.html">
                                        sling
                                    </a>
                                </span><span class="tag">
                                    <a href="/tags/kickstarter.html">
                                        kickstarter
                                    </a>
                                </span>
                            </div>
                        </div><h1 class="title">
                            How to Create a Composite NodeStore with the Feature Model
                        </h1><nav class="menu">
                            <ul class="menu-list box is-shadowless is-paddingless">
                                <li id="generatedToC">
                                    <p class="menu-label">
                                        <strong>Table of Contents</strong>
                                    </p>
                                </li>
                            </ul>
                        </nav><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=title],h2,h3','ulClass':'menu-list'}); } );</script><div class="content is-marginless">
<div class="row" data-pagefind-body="true"><div><section><h3><a href="#about-this-how-to" id="about-this-how-to">About this How-To</a></h3>
<div style="background: #cde0ea; padding: 14px; border-left: 10px solid #f9bb00;">
<h4><a href="#what-well-explore" id="what-well-explore">What we'll explore:</a></h4>
<ul>
<li>Create a Sling instance with a Composite NodeStore using the Feature Model</li>
<li>Learn why it's a good idea to segment your application from your content</li>
</ul>
<h4><a href="#what-you-should-know" id="what-you-should-know">What you should know:</a></h4>
<ul>
<li>Skill Level: Intermediate</li>
<li>Environment: Windows/Unix</li>
<li>Time: 20 minutes</li>
</ul>
</div>
<ul>
<li>Back To: <a href="/documentation/feature-model/howtos/sling-with-custom-project.html">How to Create a Custom Feature Model Project</a></li>
<li>Back to the: <a href="/documentation/feature-model/feature-model-howto.html">Feature Model How-To Guide</a></li>
</ul>
<h3><a href="#prerequisites" id="prerequisites">Prerequisites</a></h3>
<p>In order to follow this how-to you'll need the following on your computer:</p>
<ul>
<li>Java 8</li>
<li>Maven 3</li>
<li>Bash shell</li>
</ul>
<h3><a href="#whats-the-composite-nodestore" id="whats-the-composite-nodestore">What's the Composite NodeStore</a></h3>
<p>A Composite NodeStore is a repository composed of two or more nodestores. The nodestores work together to provide a single logical repository. Like a UNIX file system, each nodestore acts similar to file system mount points. For example, you can mount the <code>/content</code> node as read-write and the <code>/apps</code> and <code>/libs</code> nodes as read-only.</p>
<h3><a href="#why-use-a-composite-nodestore" id="why-use-a-composite-nodestore">Why use a Composite NodeStore</a></h3>
<p>The Composite NodeStore can be used to improve the stability of your site. In general, you can think of a Sling site as consisting of two parts: your content (which changes often) and your application (which changes periodically). Unless there's a scheduled application release, there's very little reason to allow a running Sling instance to be changed from a code/application perspective.</p>
<p>It provides a great way to ensure that application changes are not allowed without an official release, but still allow day-to-day editorial content changes. Some of the benefits of using the Composite NodeStore and separating your content and application concerns are:</p>
<ul>
<li>Improve site stability</li>
<li>Minimize downtime with blue-green deployments</li>
<li>Use CI/CD pipelines to release immutable versions of your application</li>
<li>Easily update/rollback your application without impacting your valuable content</li>
<li>Ensure your site is always up-to-date and current</li>
</ul>
<div style="background: #cde0ea; padding: 14px; border-left: 10px solid #f9bb00;">
<p>For those of you familiar with container orchestration platforms like Kubernetes (k8s), can you think of a reason why the Composite NodeStore may be useful for Sling applications in the container world?</p>
</div>
<h3><a href="#explanation-on-what-will-happen" id="explanation-on-what-will-happen">Explanation on what will happen</a></h3>
<p>Let's take a quick look at what will happen behind the scenes as we work through this tutorial.</p>
<ol>
<li>First, we'll start Sling using a regular nodestore. We'll call this our <em>seed</em> step as it'll allow us to bootstrap our instance with our application code. When we're done with the <em>seeding</em> process, we'll have our application fully populated in the <code>/apps</code> and <code>/libs</code> JCR nodes. These nodes will later become read-only.</li>
<li>Once Sling has started for the first time and completed the seeding process, we'll stop the instance.</li>
<li>Then, we'll designate the seeded repository as our read-only segment store.</li>
<li>Lastly, we'll start Sling in <em>composite mode</em>. When Sling comes up it will create another nodestore, called <em>global</em> that will function as our read-write portion of the repository. At this point, your application can't be changed while the Sling instance is running.</li>
</ol>
<h3><a href="#step-1-obtain-the-kickstarter-module" id="step-1-obtain-the-kickstarter-module">Step 1: Obtain the Kickstarter module</a></h3>
<div style="background: #fff3cd; padding: 14px; border-left: 10px solid #ffeeba;">
<p><strong>Note:</strong> These instructions will be updated to use the binary release once an official Sling Feature Model JSON file is released.</p>
</div>
<p>Build the Kickstarter and install it into your local Maven repository.</p>
<pre><code>$ git clone https://github.com/apache/sling-org-apache-sling-kickstart.git
$ cd sling-org-apache-sling-kickstart
$ mvn clean install
</code></pre>
<h3><a href="#step-2-initialize-seed-the-repository" id="step-2-initialize-seed-the-repository">Step 2: Initialize (seed) the repository</a></h3>
<p>Start Sling for the first time using the seed creation script.</p>
<pre><code>$ ./bin/create_seed_fm.sh
</code></pre>
<p>This script uses the Kickstarter to start Sling with two Feature Models:</p>
<ol>
<li><code>feature-sling12-two-headed.json</code> - Our main Feature Model. Sling Feature Model without a NodeStore</li>
<li><code>feature-two-headed-seed.json</code> - Additional Feature Model. Feature Model with a single NodeStore</li>
</ol>
<p>When you see the line below, Sling has been fully initialized and should be safely stopped by entering <code>&lt;CTRC&gt;+C</code>.</p>
<pre><code>ESAPI: SUCCESSFULLY LOADED validation.properties via the CLASSPATH from '/ (root)'...
</code></pre>
<div style="background: #fff3cd; padding: 14px; border-left: 10px solid #ffeeba;">
<p><strong>TODO:</strong> Add more detail on what happens during the seeding process.</p>
</div>
<h3><a href="#step-3-start-sling-using-the-composite-nodestore" id="step-3-start-sling-using-the-composite-nodestore">Step 3: Start Sling using the Composite NodeStore</a></h3>
<p>Now, let's start Sling a second time using the Composite NodeStore.</p>
<pre><code>$ ./bin/run_composite_fm.sh
</code></pre>
<div style="background: #fff3cd; padding: 14px; border-left: 10px solid #ffeeba;">
<p><strong>TODO:</strong> Add more detail on what happens during the composite startup process.</p>
</div>
<h3><a href="#step-4-verify-read-only-and-read-write-nodes" id="step-4-verify-read-only-and-read-write-nodes">Step 4: Verify read-only and read-write nodes</a></h3>
<div style="background: #cde0ea; padding: 14px; border-left: 10px solid #f9bb00;">
<p>The next set of steps uses the <em>SlingPostSevlet</em> and cURL to test the read-write and read-only portions of the repository. If you prefer not to use cURL, simply <a href="http://localhost:8080">log into Sling</a>, navigate to <a href="http://localhost:8080/bin/browser.html">Composum</a> and manipulate the nodes by hand.</p>
</div>
<p><strong>1.</strong> Let's start by making a post request and add a JCR property to the <code>/content</code> node.</p>
<pre><code>$ curl -s -v -u admin:admin -FtestProperty='I can write to the content node' \
      'http://localhost:8080/content/slingshot' &gt; /dev/null
...
&lt; HTTP/1.1 200 OK
...
</code></pre>
<p>Since this is a read-write repository path, you should receive an <em>HTTP 200 OK</em> response and be able to write to a property called <code>testProperty</code> with the value <code>I can write to the content node</code> on the <code>/content/slingshot</code> node.</p>
<p><strong>2.</strong> Now, let's try the same test, but let's attempt to write to a read-only node.</p>
<pre><code>$ curl -s -v -u admin:admin -FtestProperty='I cannot write to the apps node' \
      'http://localhost:8080/apps/slingshot' &gt; /dev/null
...
&lt; HTTP/1.1 500 Server Error
...
</code></pre>
<p>You should now receive an <em>HTTP 500 error</em> response. So, even as the admin user you can't write to the <code>/apps</code> section of the repository.</p>
<h2><a href="#mission-accomplished" id="mission-accomplished">Mission Accomplished</a></h2>
<div style="background: #cde0ea; padding: 14px; border-left: 10px solid #f9bb00; margin-bottom: 1em;">
<h4><a href="#what-we-learned" id="what-we-learned">What we learned:</a></h4>
<ul>
<li>The benefits of running a repository comprised of read-only and read-write nodes</li>
<li>How to run Sling using the Composite Nodestore</li>
<li>Even as the admin user, we can't make changes to read-only nodes</li>
</ul>
</div>
<p>If you stick with us, we'll show you how to convert an existing Provisioning Model to a Feature Model..</p>
<div style="background: #cde0ea; padding: 14px; border-left: 10px solid #f9bb00; margin-bottom: 1em;">
<ul>
<li>Next Up: <a href="/documentation/feature-model/howtos/create-sling-fm.html">How to Convert a Provisioning Model to a Feature Model</a></li>
<li>Back To: <a href="/documentation/feature-model/howtos/sling-with-custom-project.html">How to Create a Custom Feature Model Project</a></li>
</ul>
</div>
</section></div></div><div data-pagefind-body="true" data-pagefind-weight="7.0" style="display:none;"> - ( How to Create a Composite NodeStore with the Feature Model )</div>                            
                        </div>
                    </div>
                </div>
            </div><footer class="footer">
                <div class="content has-text-centered is-small">
<div class="editpagelink">
                        This page can be edited on GitHub at <a href="https://github.com/apache/sling-site/edit/master/src/main/jbake/content/documentation/feature-model/howtos/create-sling-composite.md">
                            content/documentation/feature-model/howtos/create-sling-composite.md
                        </a>
                    </div>                    <div class="revisionInfo">
                        Last modified by <span class="author">Bertrand Delacretaz</span> on <span class="comment">2020-06-18</span>
                    </div><p>
                        Apache Sling, Sling, Apache, the ASF logo, and the Apache Sling project
    logo are trademarks of The Apache Software Foundation. All other marks mentioned 
    may be trademarks or registered trademarks of their respective owners.
                    </p><p>
                        Copyright © 2007-2025<a href="https://www.apache.org/">
                            The Apache Software Foundation
                        </a>|<a href="https://privacy.apache.org/policies/privacy-policy-public.html">
                            Privacy Policy
                        </a>
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>