<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: HTL Scripting Engine</title>
        <link rel="icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="/res/css/bulma.min.css"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <script src='https://www.apachecon.com/event-images/snippet.js'></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
	<!-- Matomo Web Analytics -->
	<script>
	var _paq = window._paq = window._paq || [];
	/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
	/* We explicitly disable cookie tracking to avoid privacy issues */
	_paq.push(['disableCookies']); 
	_paq.push(['trackPageView']);
	_paq.push(['enableLinkTracking']);
	(function() {
	  var u="https://matomo.privacy.apache.org/";
	  _paq.push(['setTrackerUrl', u+'matomo.php']);
	  _paq.push(['setSiteId', '6']);
	  var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
	  g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
	})();
	</script>
	<!-- End Matomo Code -->
	<link href='/pagefind/pagefind-ui.css' rel='stylesheet'><script src='/pagefind/pagefind-ui.js' type='text/javascript'></script>
	<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#searchbox" });
    });
	</script>
	
    </head>    <body>
        <div class="section">
            <div class="level is-marginless">
<div class="logo">
                    <a href="https://sling.apache.org">
                        <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                    </a>
                </div><div class="header">
                    <a href="https://www.apache.org">
                        <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                    </a>
                </div>                
            </div><section class="searchbox level is-marginless">
                <div id="searchbox"></div>
            </section><div class="columns is-gapless">
                <div class="column is-narrow sidemenu">
<div class="container">
                        <nav class="menu">
                            <ul class="menu-list box is-shadowless is-marginless">
                                <li>
                                    <p class="menu-label">
                                        <strong>Documentation</strong>
                                    </p><ul>
                                        <li><a href="/documentation.html">Overview</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>API Docs</strong>
                                    </p><ul>
                                        <li><a href="/apidocs/sling13/index.html">Sling 13</a></li><li><a href="/apidocs/sling12/index.html">Sling 12</a></li><li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Support</strong>
                                    </p><ul>
                                        <li><a href="https://s.apache.org/sling.wiki">Wiki</a></li><li><a href="https://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Sitemap</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Project Info</strong>
                                    </p><ul>
                                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="https://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Source</strong>
                                    </p><ul>
                                        <li><a href="/repolist.html">Repositories</a></li><li><a href="https://gitbox.apache.org/repos/asf#sling">Git at Apache</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Apache Software<br>Foundation</strong>
                                    </p><ul>
                                        <li><a href="https://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="https://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li>
                                    </ul>
                                </li><li>
                                    <a class="acevent" data-format="square" data-event="random"></a>
                                </li><li>
                                    <a href="https://apache.org/foundation/contributing.html" class="column">
                                        <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>                    
                </div><div class="column main">
                    <div class="box is-shadowless is-marginless">
                        <div class="level">
                            <div class="pagenav">
<div class="breadcrumb">
                                    <ul>
                                        <li>
                                            <a href="/">
                                                Home
                                            </a>
                                        </li><li>
                                            <a href="/documentation.html">
                                                Documentation
                                            </a>
                                        </li><li>
                                            <a href="/documentation/bundles.html">
                                                Bundles
                                            </a>
                                        </li><li>
                                            <a href="/documentation/bundles/scripting.html">
                                                Sling Scripting
                                            </a>
                                        </li>
                                    </ul>
                                </div>                                
                            </div><div class="tags">
                                <span class="tag">
                                    <a href="/tags/scripts.html">
                                        scripts
                                    </a>
                                </span><span class="tag">
                                    <a href="/tags/htl.html">
                                        htl
                                    </a>
                                </span>
                            </div>
                        </div><h1 class="title">
                            HTL Scripting Engine
                        </h1><nav class="menu">
                            <ul class="menu-list box is-shadowless is-paddingless">
                                <li id="generatedToC">
                                    <p class="menu-label">
                                        <strong>Table of Contents</strong>
                                    </p>
                                </li>
                            </ul>
                        </nav><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=title],h2,h3','ulClass':'menu-list'}); } );</script><div class="content is-marginless">
<div class="row" data-pagefind-body="true"><div><section><p>The Apache Sling HTL Scripting Engine, <a href="https://issues.apache.org/jira/browse/SLING-6028">formerly known as Sightly</a>, is the reference implementation of the <a href="https://github.com/adobe/htl-spec">HTML Template Language 1.4</a>.</p>
<p><!-- TODO reactivate TOC once JBake moves to flexmark-java -->
</p>
<h1><a href="#modules" id="modules">Modules</a></h1>
<p>The Sling implementation is comprised of the following modules:</p>
<ol>
<li><a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-compiler"><code>org.apache.sling.scripting.sightly.compiler</code></a> - provides support for compiling HTML Template Language scripts into an Abstract Syntax Tree</li>
<li><a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-compiler-java"><code>org.apache.sling.scripting.sightly.compiler.java</code></a> - provides support for transpiling the Abstract Syntax Tree produced by the <code>org.apache.sling.scripting.sightly.compiler</code> module into Java source code</li>
<li><a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly"><code>org.apache.sling.scripting.sightly</code></a> - the HTL Scripting Engine bundle</li>
<li><a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-runtime"><code>org.apache.sling.scripting.sightly.runtime</code></a> - Java runtime support for the Java code generated by the <code>org.apache.sling.scripting.sightly.compiler.java</code> module</li>
<li><a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-js-provider"><code>org.apache.sling.scripting.sightly.js.provider</code></a> - the HTL JavaScript Use Provider, implementing support for the <code>use</code> JavaScript function</li>
<li><a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-repl"><code>org.apache.sling.scripting.sightly.repl</code></a> - HTL Read-Eval-Print Loop Environment (REPL), useful for quickly prototyping scripts</li>
<li><a href="https://github.com/apache/sling-htl-maven-plugin"><code>htl-maven-plugin</code></a> - M2Eclipse compatible HTL Maven Plugin that provides support for validating HTML Template Language scripts from projects during build time</li>
</ol>
<h1><a href="#the-use-api" id="the-use-api">The Use-API</a></h1>
<p>The <a href="https://github.com/adobe/htl-spec/blob/1.4/SPECIFICATION.md#4-use-api">HTML Template Language Specification</a> explicitly defines two ways of implementing support for business logic objects:</p>
<ol>
<li>
<p>Java Use-API, through POJOs, that may optionally implement an <code>init</code> method:</p>
<pre><code>/**
 * Initialises the Use bean.
 *
 * @param bindings All bindings available to the HTL scripts.
 **/
public void init(javax.script.Bindings bindings);
</code></pre>
</li>
<li>
<p>JavaScript Use-API, by using a standardised use function</p>
<pre><code>/**
 * In the following example '/libs/dep1.js' and 'dep2.js' are optional
 * dependencies needed for this script's execution. Dependencies can
 * be specified using an absolute path or a relative path to this
 * script's own path.
 *
 * If no dependencies are needed the dependencies array can be omitted.
 */
use(['dep1.js', 'dep2.js'], function (Dep1, Dep2) {
    // implement processing

    // define this Use object's behaviour
    return {
        propertyName: propertyValue
        functionName: function () {}
    }
});
</code></pre>
</li>
</ol>
<p>The HTL implementation from Sling provides the basic POJO support through the <a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-runtime/blob/master/src/main/java/org/apache/sling/scripting/sightly/pojo/Use.java"><code>org.apache.sling.scripting.sightly.pojo.Use</code></a> interface and the <a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly/blob/master/src/main/java/org/apache/sling/scripting/sightly/impl/engine/extension/use/JavaUseProvider.java"><code>JavaUseProvider</code></a>, whereas the <code>use</code> function is implemented by the <code>org.apache.sling.scripting.sightly.js.provider</code> bundle.</p>
<h1><a href="#type-conversions" id="type-conversions">Type conversions</a></h1>
<p>The HTL Specification talks about the following types which are supported to be used with native Java types. The conversion rules are outlined in the table below.</p>
<table>
<thead>
<tr><th>HTL Type </th><th> Conversion from Java Type </th><th> Code Link</th></tr>
</thead>
<tbody>
<tr><td><code>Boolean</code> </td><td> <code>java.lang.Boolean</code> (no conversion necessary). In addition it returns <code>true</code> for every other Java object except for <code>null</code>, <code>java.lang.Number</code> having value <code>0</code>, empty String, array, Collection, Map, Iterator or Iterable's iterator  </td><td> <a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-runtime/blob/org.apache.sling.scripting.sightly.runtime-1.2.4-1.4.0/src/main/java/org/apache/sling/scripting/sightly/render/ObjectModel.java#L151"><code>ObjectModel.toBoolean(Object)</code></a></td></tr>
<tr><td><code>String</code> </td><td> Almost every type via <code>Object.toString()</code>. <code>Collections</code> are handled differently, by joining their elements. All types supported since HTL Runtime 1.2.6-1.4.0 (<a href="https://issues.apache.org/jira/browse/SLING-9968">SLING-9968</a>).</td><td> <a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-runtime/blob/org.apache.sling.scripting.sightly.runtime-1.2.4-1.4.0/src/main/java/org/apache/sling/scripting/sightly/render/ObjectModel.java#L238"><code>ObjectModel.toString(Object)</code></a></td></tr>
<tr><td><code>Date</code> </td><td> <code>java.util.Date</code>, <code>java.util.Calendar</code>, <code>java.time.Instant</code> (<a href="https://issues.apache.org/jira/browse/SLING-10651">SLING-10651</a>) </td><td> <a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-runtime/blob/6bcc04f159290aac39f0f6fa725da0a87f59076b/src/main/java/org/apache/sling/scripting/sightly/render/AbstractRuntimeObjectModel.java#L91"><code>AbstractRuntimeObjectModel.toDate(Object)</code></a></td></tr>
<tr><td><code>Number</code> </td><td> <code>java.lang.Number</code>, every other type first converted to <code>java.lang.String</code> and then converted to Number via <a href="https://commons.apache.org/proper/commons-lang/apidocs/org/apache/commons/lang3/math/NumberUtils.html#createNumber-java.lang.String-"><code>NumberUtils.createNumber(String)</code></a>. </td><td> <a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-runtime/blob/org.apache.sling.scripting.sightly.runtime-1.2.4-1.4.0/src/main/java/org/apache/sling/scripting/sightly/render/ObjectModel.java#L204"><code>ObjectModel.toNumber(Object)</code></a></td></tr>
<tr><td><code>Collection</code> </td><td> <code>java.util.Collection</code>, <code>java.util.Iterator</code>, <code>java.lang.Iterable</code>, <code>java.util.Enumeration</code> and arrays return the underlying list or collection. <code>java.lang.String</code> or <code>java.lang.Number</code> are converted to a list containing the object as single item. For <code>java.util.Map</code> the key set is used. Everything else returns an empty list till HTL Runtime 1.2.4-1.4.0, newer versions return a single item list containing the object (<a href="https://issues.apache.org/jira/browse/SLING-10679">SLING-10679</a>) </td><td> <a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-runtime/blob/org.apache.sling.scripting.sightly.runtime-1.2.4-1.4.0/src/main/java/org/apache/sling/scripting/sightly/render/ObjectModel.java#L277"><code>ObjectModel.toCollection(Object)</code></a></td></tr>
</tbody>
</table>
<h2><a href="#support-for-optional" id="support-for-optional">Support for Optional</a></h2>
<p>Starting with <a href="https://issues.apache.org/jira/browse/SLING-8228">SLING-8228</a>, <code>java.util.Optional</code> objects are expanded before being passed to the conversion methods provided by the <a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-runtime/blob/org.apache.sling.scripting.sightly.runtime-1.2.4-1.4.0/src/main/java/org/apache/sling/scripting/sightly/render/ObjectModel.java"><code>org.apache.sling.scripting.sightly.render.ObjectModel</code></a>.</p>
<h2><a href="#javascript" id="javascript">JavaScript</a></h2>
<p>As the HTL Engine in Sling is a Java implementation even the objects provided by the JS Use Provider are first converted into native Java types. The type conversion from JS to Java is done with <a href="https://github.com/mozilla/rhino">Rhino</a>, afterwards the semantics from the table above are used.</p>
<h1><a href="#extensions-of-the-htl-specification" id="extensions-of-the-htl-specification">Extensions of the HTL Specification</a></h1>
<p>The Sling HTL Scripting engine fully complies with the <a href="https://github.com/adobe/htl-spec/blob/1.4/SPECIFICATION.md">HTML Template Language Specification 1.4</a>. In addition it adds some extensions which are not part of the specification.</p>
<h2><a href="#block-elements" id="block-elements">Block Elements</a></h2>
<h3><a href="#data-sly-resource" id="data-sly-resource"><code>data-sly-resource</code></a></h3>
<p>In Apache Sling, in addition to path strings, the <code>data-sly-resource</code> block element can be passed a <code>Resource</code> object. This behaviour has been added in <a href="https://issues.apache.org/jira/browse/SLING-5811">SLING-5811</a>.</p>
<p>The <a href="https://issues.apache.org/jira/browse/SLING-5812"><code>requestAttributes</code> option</a> can be used to pass a <code>Map</code> with objects to the request attributes.</p>
<h3><a href="#data-sly-include" id="data-sly-include"><code>data-sly-include</code></a></h3>
<p>The <a href="https://issues.apache.org/jira/browse/SLING-5812"><code>requestAttributes</code> option</a> can be used to pass a <code>Map</code> with objects to the request attributes.</p>
<h2><a href="#expression-options" id="expression-options">Expression Options</a></h2>
<h3><a href="#display-context-supported-since-htl-engine-1422-140" id="display-context-supported-since-htl-engine-1422-140">Display Context (supported since HTL Engine 1.4.22-1.4.0)</a></h3>
<p>In addition to the contexts defined in <a href="https://github.com/adobe/htl-spec/blob/1.4/SPECIFICATION.md#121-display-context">HTL Spec 1.2.1</a> a context with name <code>jsonString</code> is supported which escapes a text according to the JSON string grammar defined by <a href="https://www.ecma-international.org/wp-content/uploads/ECMA-404_2nd_edition_december_2017.pdf">ECMA-404</a> in chapter 9 (<a href="https://issues.apache.org/jira/browse/SLING-11538">SLING-11538</a>).</p>
<h3><a href="#i18n" id="i18n">I18n</a></h3>
<p>In addition to the options defined for <a href="https://github.com/adobe/htl-spec/blob/1.4/SPECIFICATION.md#123-i18n">i18n</a> the <code>basename</code> option can be used to set the basename of the used <a href="../internationalization-support-i18n.html#resourcebundle-with-base-names">Sling i18n Resource bundle</a> (<a href="https://issues.apache.org/jira/browse/SLING-5314">SLING-5314</a>).</p>
<h3><a href="#format-date" id="format-date">Format Date</a></h3>
<p>In addition to the regular patterns defined for <a href="https://github.com/adobe/htl-spec/blob/1.4/SPECIFICATION.md#1222-dates">date formatting</a>, the following special formatting patterns are supported (<a href="https://issues.apache.org/jira/browse/SLING-9983">SLING-9983</a>) for formatting dates only (disregarding time) in a decent format for the used locale. <em>The resulting format depends on the JDK version though, as it changed fundamentally with <a href="https://openjdk.java.net/jeps/252">JDK 8</a>, and even afterwards the different <a href="http://cldr.unicode.org/index/downloads">CLDR releases</a> implemented in the different JDK versions differ quite substantially.</em></p>
<table>
<thead>
<tr><th>Pattern </th><th> Description </th><th> Example (for Locale en_US)</th></tr>
</thead>
<tbody>
<tr><td><code>short</code> </td><td> A short representation of the date (disregarding time), typically numeric </td><td> 10/26/85</td></tr>
<tr><td><code>medium</code> </td><td> A medium representation of the date (disregarding time), with some detail </td><td> Oct 26, 1985</td></tr>
<tr><td><code>long</code> </td><td> A long representation of the date (disregarding time), with lots of detail </td><td> October 26, 1985</td></tr>
<tr><td><code>full</code> </td><td> The full represenation of the date (disregarding time), with the most detail </td><td> Saturday, October 26, 1985</td></tr>
<tr><td><code>default</code> </td><td> Is equal to <code>medium</code> </td><td> Oct 26, 1985</td></tr>
</tbody>
</table>
<p>Those pattern values are case-insensitive.</p>
<p>The implementation uses <a href="https://docs.oracle.com/javase/8/docs/api/java/time/format/DateTimeFormatter.html#ofLocalizedDate-java.time.format.FormatStyle-"><code>DateTimeFormatter.ofLocalizedDate(FormatStyle)</code></a> for formatting those dates.</p>
<h3><a href="#format-string-supported-since-htl-engine-1422-140" id="format-string-supported-since-htl-engine-1422-140">Format String (supported since HTL Engine 1.4.22-1.4.0)</a></h3>
<p>In addition to the variable-element placeholder replacement as given by the examples in the <a href="https://github.com/adobe/htl-spec/blob/1.4/SPECIFICATION.md#examples">HTL Spec 1.4</a>, <a href="https://issues.apache.org/jira/browse/SLING-10654">SLING-10654</a> adds optional support for complex argument types using <a href="https://unicode-org.github.io/icu/userguide/format_parse/messages/">ICU Message Formatting</a>.</p>
<p>When the <a href="https://github.com/unicode-org/icu/releases">icu4j bundle</a> is available at runtime, pattterns that contain complex argument types will automatically be formatted using the icu4j <a href="https://unicode-org.github.io/icu-docs/apidoc/dev/icu4j/com/ibm/icu/text/MessageFormat.html"><code>MessageFormat</code></a>. This adds for example support for select and plural formats:</p>
<pre><code>${ '{0, plural, one{# result} other{# results}}' @format=properties.result }
${ '{0, plural, one{# výsledek} few{# výsledky} other{# výsledků}}' @format=properties.result }
</code></pre>
<p>Other than for the regular variable-element placeholder replacement, parameters passed to the format option are not converted to any other type. If they do not match the pattern an <code>IllegalArgumentException</code> may be throw.</p>
<p>If the icu4j bundle is not available at runtime, only simple variable-element placeholders will be replaced and expessions that use complex argument types will be removed.</p>
<h2><a href="#use-api-extensions" id="use-api-extensions">Use-API Extensions</a></h2>
<p>The Sling implementation provides a few extensions to the Use-API.</p>
<p>A full HTL installation provides the following Use Providers, in the order of their priority (the higher the service ranking value, the higher the priority):</p>
<table>
<thead>
<tr><th>Service Ranking  </th><th> Use Provider    </th><th> Bundle                 </th><th> Functionality     </th><th>Observations</th></tr>
</thead>
<tbody>
<tr><td>100</td><td><a href="https://github.com/apache/sling/blob/trunk/bundles/scripting/sightly/engine/src/main/java/org/apache/sling/scripting/sightly/impl/engine/extension/use/RenderUnitProvider.java"><code>RenderUnitProvider</code></a></td><td><code>org.apache.sling.scripting.sightly</code></td><td colspan="2">support for loading HTL templates through <code>data-sly-use</code></td></tr>
<tr><td>90</td><td><a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly/blob/master/src/main/java/org/apache/sling/scripting/sightly/impl/engine/extension/use/JavaUseProvider.java"><code>JavaUseProvider</code></a></td><td><code>org.apache.sling.scripting.sightly</code></td><td>support for loading Java objects such as: <ol><li><a href="https://sling.apache.org/documentation/bundles/models.html">Sling Models</a></li><li>OSGi services</li><li>POJOs adaptable from <code>SlingHttpServletRequest</code> or <code>Resource</code></li><li>POJOs that implement <code>Use</code></li></ol></td><td>The POJOs can be exported by bundles or can be backed by <code>Resources</code>. In the latter case the POJOs' package names should correspond to the backing resource's path; invalid Java characters which are valid path elements should be replaced by an underscore - <code>_</code>.</td></tr>
<tr><td>80</td><td><a href="https://github.com/apache/sling/blob/trunk/bundles/scripting/sightly/js-use-provider/src/main/java/org/apache/sling/scripting/sightly/js/impl/JsUseProvider.java"><code>JsUseProvider</code></a></td><td><code>org.apache.sling.scripting.sightly.js.provider</code></td><td>support for loading objects defined through the JavaScript <code>use</code> function</td><td>The <code>org.apache.sling.scripting.sightly.js.provider</code> also provides a trimmed down <a href="https://github.com/apache/sling/tree/trunk/bundles/scripting/sightly/js-use-provider/src/main/resources/SLING-INF/libs/sling/sightly/js">asynchronous implementation</a> of the <code>Resource</code> API. However this was deprecated in <a href="https://issues.apache.org/jira/browse/SLING-4964">SLING-4964</a> (version 1.0.8 of the bundle) in favour of the synchronous API provided by the <code>org.apache.sling.scripting.javascript</code> bundle.</td></tr>
<tr><td>0  </td><td><a href="https://github.com/apache/sling/blob/trunk/bundles/scripting/sightly/engine/src/main/java/org/apache/sling/scripting/sightly/impl/engine/extension/use/ScriptUseProvider.java"><code>ScriptUseProvider</code></a></td><td><code>org.apache.sling.scripting.sightly</code></td><td colspan="2">support for loading objects returned by scripts interpreted by other Script Engines available on the platform</td></tr>
<tr><td>-10</td><td><a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly/blob/master/src/main/java/org/apache/sling/scripting/sightly/impl/engine/extension/use/ResourceUseProvider.java"><code>ResourceUseProvider</code></a></td><td><code>org.apache.sling.scripting.sightly</code></td><td colspan="2">support for loading <code>Resources</code> by path using the request's resource resolver - <a href="https://issues.apache.org/jira/browse/SLING-5813">SLING-5813</a></td></tr>
</tbody>
</table>
<p>The <code>service.ranking</code> value of each Use Provider is configurable, allowing for fine tuning of the order in which the providers are queried when <code>data-sly-use</code> is called. However, in order to not affect core functionality the <code>RenderUnitProvider</code> should always have the highest ranking. If you need to configure the providers' service ranking head over to the configuration console at <a href="http://localhost:8080/system/console/configMgr">http://localhost:8080/system/console/configMgr</a>.</p>
<h3><a href="#global-objects" id="global-objects">Global Objects</a></h3>
<p>The following global objects are available to all Use objects, either as a request attribute or as a property made available in the <code>javax.script.Bindings</code> map or attached to the <code>this</code> context of the <code>use</code> function:</p>
<pre><code>    currentNode         // javax.jcr.Node
    currentSession      // javax.jcr.Session
    log                 // org.slf4j.Logger
    out                 // java.io.PrintWriter
    properties          // org.apache.sling.api.resource.ValueMap
    reader              // java.io.BufferedReader
    request             // org.apache.sling.api.SlingHttpServletRequest
    resolver            // org.apache.sling.api.resource.ResourceResolver
    resource            // org.apache.sling.api.resource.Resource
    response            // org.apache.sling.api.SlingHttpServletResponse
    sling               // org.apache.sling.api.scripting.SlingScriptHelper
</code></pre>
<h3><a href="#java-use-provider" id="java-use-provider">Java Use Provider</a></h3>
<p>The Java Use Provider can be used to load <a href="https://sling.apache.org/documentation/bundles/models.html">Sling Models</a>, OSGi services, objects exported by bundles or backed by a <code>Resource</code>.</p>
<h4><a href="#sling-models-or-java-use-objects" id="sling-models-or-java-use-objects">Sling Models or Java Use-objects</a></h4>
<p>Loading a Sling Model or a bundled Java Use-object can be done with the following code:</p>
<pre><code>    &lt;div data-sly-use.model3=&quot;org.example.models.Model3&quot;&gt;
        ${model3.shine}
    &lt;/div&gt;
</code></pre>
<p>Depending on the implementation the above code would either load the implementation with the highest service ranking of <code>org.example.models.Model3</code> if <code>Model3</code> is an interface, or would load the Sling Model/Java Use-object <code>org.example.models.Model3</code> if this is a concrete implementation.</p>
<p>Use-objects that are adaptable from <code>SlingHttpServletRequest</code> or <code>Resource</code> are adapted automatically. If the Use-object cannot be adapted from either of the two, the adaptable can be passed to the <code>data-sly-use</code> block element using the <code>adaptable</code> option:</p>
<pre><code>    &lt;div data-sly-use.model3=&quot;${'org.example.models.Model3' @ adaptable=anAdaptableObjectInScope }&quot;&gt;
        ${model3.shine}
    &lt;/div&gt;
</code></pre>
<h4><a href="#resource-backed-java-classes" id="resource-backed-java-classes">Resource-backed Java classes</a></h4>
<p>When objects are backed by <code>Resources</code> the Java Use Provider will automatically handle the compilation of these classes. The classes' package names should correspond to the path of the backing resource, making sure to replace illegal Java characters with underscores - <code>_</code>.</p>
<p><strong>Example:</strong> Assuming the following content structure:</p>
<pre><code>    └── apps
        └── my-project
            └── components
                └── page
                    ├── PageBean.java
                    └── page.html
</code></pre>
<p><code>page.html</code> could load <code>PageBean</code> either like:</p>
<pre><code>    &lt;!DOCTYPE html&gt;
    &lt;html data-sly-use.page=&quot;apps.my_project.components.page.PageBean&quot;&gt;
    ...
    &lt;/html&gt;
</code></pre>
<p>or like:</p>
<pre><code>    &lt;!DOCTYPE html&gt;
    &lt;html data-sly-use.page=&quot;PageBean&quot;&gt;
    ...
    &lt;/html&gt;
</code></pre>
<p>The advantage of loading a bean using just the simple class name (e.g. <code>data-sly-use.page=&quot;PageBean&quot;</code>) is that an inheriting component can overlay the <code>PageBean.java</code> file and provide a different logic. In this case the package name of the <code>PageBean</code> class will automatically be derived from the calling script's parent path (e.g. <code>apps.my_project.components.page</code>) - the bean doesn't even have to specify it. However, keep in mind that loading a bean this way is slower than providing the fully qualified class name, since the provider has to check if there is a backing resource. At the same time, loading an object using its fully qualified class name will not allow overriding it by inheriting components.</p>
<h4><a href="#passing-parameters-to-java-use-objects" id="passing-parameters-to-java-use-objects">Passing parameters to Java Use-objects</a></h4>
<p>Passed parameters will be made available to the Use object as request attributes and, if the object implements the <a href="https://github.com/apache/sling-org-apache-sling-scripting-sightly-compiler-java/blob/master/src/main/java/org/apache/sling/scripting/sightly/pojo/Use.java"><code>org.apache.sling.scripting.sightly.pojo.Use</code></a> interface, through the <code>javax.script.Bindings</code> passed to the <code>init</code> method. Assuming the following markup:</p>
<pre><code>    &lt;div data-sly-use.useObject=&quot;${'org.example.use.MyUseObject' @ colour='red', year=2016}&quot;&gt;
        ${useObject.shine}
    &lt;/div&gt;
</code></pre>
<p>a Sling Model could read these values like in the following example:</p>
<pre><code>    @Model(adaptables=SlingHttpServletRequest.class)
    public class MyUseObject {

        @Inject
        private String colour;

        @Inject
        private String year;
    }
</code></pre>
<p>whereas an object implementing <code>Use</code> would be able to retrieve the parameters using the following constructs:</p>
<pre><code>    package org.example.use.MyUseObject;

    import javax.script.Bindings;

    import org.apache.sling.commons.osgi.PropertiesUtil;
    import org.apache.sling.scripting.sightly.pojo.Use;

    public class MyUseObject implements Use {

        private String colour;
        private Integer year;

        public void init(Bindings bindings) {
            colour = PropertiesUtil.toString(bindings.get(&quot;colour&quot;), &quot;&quot;);
            year = PropertiesUtil.toInteger(bindings.get(&quot;year&quot;), Calendar.getInstance().get(Calendar.YEAR));
        }
    }
</code></pre>
<p>or, if the object is adaptable from a <code>SlingHttpServletRequest</code>, through its <code>AdapterFactory</code>:</p>
<pre><code>package org.example.use;

import org.apache.felix.scr.annotations.Component;
import org.apache.felix.scr.annotations.Properties;
import org.apache.felix.scr.annotations.Property;
import org.apache.felix.scr.annotations.Service;
import org.apache.sling.api.SlingHttpServletRequest;
import org.apache.sling.api.adapter.AdapterFactory;

@Component
@Service
@Properties({
        @Property(
                name = AdapterFactory.ADAPTABLE_CLASSES,
                value = {
                        &quot;org.apache.sling.api.SlingHttpServletRequest&quot;
                }
        ),
        @Property(
                name = AdapterFactory.ADAPTER_CLASSES,
                value = {
                        &quot;org.example.use.MyUseObject&quot;
                }
        )
})
public class RequestAdapterFactory implements AdapterFactory {

    @Override
    public &lt;AdapterType&gt; AdapterType getAdapter(Object adaptable, Class&lt;AdapterType&gt; type) {
        if (type == MyUseObject.class &amp;&amp; adaptable instanceof SlingHttpServletRequest) {
            SlingHttpServletRequest request = (SlingHttpServletRequest) adaptable;
            String colour = PropertiesUtil.toString(request.getAttribute(&quot;colour&quot;), &quot;&quot;);
            Integer year = PropertiesUtil.toInteger(request.getAttribute(&quot;year&quot;), Calendar.getInstance().get(Calendar.YEAR));
            /*
             * for the sake of this example we assume that MyUseObject has this constructor
             */
            return (AdapterType) new MyUseObject(colour, year);
        }
        return null;
    }
}
</code></pre>
<h3><a href="#javascript-use-provider" id="javascript-use-provider">JavaScript Use Provider</a></h3>
<p>The JavaScript Use Provider allows loading objects created through the <code>use</code> function, by evaluating scripts passed to <code>data-sly-use</code>. The JavaScript files are evaluated server-side by the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino">Rhino</a> scripting engine, through the <code>org.apache.sling.scripting.javascript</code> implementation bundle. This allows you to mix JavaScript API with the Java API exported by the platform. For more details about how you can access Java APIs from within JavaScript please check the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/Rhino/Scripting_Java#Accessing_Java_Packages_and_Classes">Rhino Java Scripting guide</a>.</p>
<p><strong>Example:</strong> Assuming the following content structure:</p>
<pre><code>    └── apps
        └── my-project
            └── components
                └── page
                    ├── page.html
                    └── page.js
</code></pre>
<p><code>page.html</code> could load <code>page.js</code> either like:</p>
<pre><code>    &lt;!DOCTYPE html&gt;
    &lt;html data-sly-use.page=&quot;/apps/my-project/components/page/page.js&quot;&gt;
    ...
    &lt;/html&gt;
</code></pre>
<p>or like:</p>
<pre><code>    &lt;!DOCTYPE html&gt;
    &lt;html data-sly-use.page=&quot;page.js&quot;&gt;
    ...
    &lt;/html&gt;
</code></pre>
<p>Similar to the Java Use Provider, loading the script using a relative path allows inheriting components to overlay just the Use script, without having to also overlay the calling HTL script.</p>
<h4><a href="#global-objects" id="global-objects">Global Objects</a></h4>
<p>Besides the global objects available to all Use Providers, the JavaScript Use Provider also provides the following global objects available in the context of the <code>use</code> function:</p>
<pre><code>console         // basic wrapper on top of log, but without formatting / throwable support
exports         // basic Java implementation of CommonJS - http://requirejs.org/docs/commonjs.html
module          // basic Java implementation of CommonJS - http://requirejs.org/docs/commonjs.html
setImmediate    // Java implementation of the Node.js setImmediate function
setTimeout      // Java implementation of the Node.js setTimeout function
sightly         // the namespace object under which the asynchronous Resource-API implemented by
                // org.apache.sling.scripting.sightly.js.provider is made available to consumers
use             // the use function
</code></pre>
<p>With the exception of the <code>console</code> and <code>use</code> objects, all the other global objects implemented by the JavaScript Use Provider are present in order to support the asynchronous Resource-API implemented by <code>org.apache.sling.scripting.sightly.js.provider</code>. However, this was deprecated starting with version 1.0.8 - see <a href="https://issues.apache.org/jira/browse/SLING-4964">SLING-4964</a>.</p>
<h4><a href="#passing-parameters-to-javascript-use-objects" id="passing-parameters-to-javascript-use-objects">Passing parameters to JavaScript Use-objects</a></h4>
<p>Passed parameters will be made available to the Use object as properties of <code>this</code>. Assuming the following markup:</p>
<pre><code>    &lt;div data-sly-use.logic=&quot;${'logic.js' @ colour='red', year=2017}&quot;&gt;
        My colour is ${logic.colour ? logic.colour : 'not important'} and I'm from ${logic.year}
    &lt;/div&gt;
</code></pre>
<p>the object would be able to access the parameters like:</p>
<pre><code>    use(function() {
        'use strict';

        var colour = this.colour || '';
        var year = this.year || new Date().getFullYear();

        return {
            colour: colour,
            year: year
        }
    });
</code></pre>
<h4><a href="#caveats" id="caveats">Caveats</a></h4>
<p>Since these scripts are evaluated server-side, by compiling JavaScript to Java, you need to pay attention when comparing primitive objects using the strict equal operator (<code>===</code>) since comparisons between JavaScript and Java objects with the same apparent value will return <code>false</code> (this also applies to the strict not-equal operator - <code>!==</code>).</p>
<p>Assuming the following HTL script:</p>
<pre><code>    &lt;ol data-sly-use.obj=&quot;logic.js&quot; data-sly-list=&quot;${obj}&quot;&gt;
        &lt;li&gt;
           Code &lt;code&gt;${item.code}&lt;/code&gt; evaluates to &lt;code&gt;${item.result}&lt;/code&gt;
        &lt;/li&gt;
    &lt;/ol&gt;
</code></pre>
<p>and the following JavaScript file:</p>
<pre><code>    use(function() {

        return [
            {
                code: 'new java.lang.String(&quot;apples&quot;) === &quot;apples&quot;',
                result: new java.lang.String(&quot;apples&quot;) === &quot;apples&quot;
            },
            {
                code: 'new java.lang.String(&quot;apples&quot;) == &quot;apples&quot;',
                result: new java.lang.String(&quot;apples&quot;) == &quot;apples&quot;
            },
            {
                code: 'new java.lang.String(&quot;apples&quot;) !== &quot;apples&quot;',
                result: new java.lang.String(&quot;apples&quot;) !== &quot;apples&quot;
            },
            {
                code: 'new java.lang.String(&quot;apples&quot;) != &quot;apples&quot;',
                result: new java.lang.String(&quot;apples&quot;) != &quot;apples&quot;
            },
            {
                code: 'new java.lang.Integer(1) === 1',
                result: new java.lang.Integer(1) === 1
            },
            {
                code: 'new java.lang.Integer(1) == 1',
                result: new java.lang.Integer(1) == 1
            },
            {
                code: 'new java.lang.Integer(1) !== 1',
                result: new java.lang.Integer(1) !== 1
            },
            {
                code: 'new java.lang.Integer(1) != 1',
                result: new java.lang.Integer(1) != 1
            },
            {
                code: 'java.lang.Boolean.TRUE === true',
                result: java.lang.Boolean.TRUE === true
            },
            {
                code: 'java.lang.Boolean.TRUE == true',
                result: java.lang.Boolean.TRUE == true
            },
            {
                code: 'java.lang.Boolean.TRUE !== true',
                result: java.lang.Boolean.TRUE !== true
            },
            {
                code: 'java.lang.Boolean.TRUE != true',
                result: java.lang.Boolean.TRUE != true
            }
        ];
    });
</code></pre>
<p>the output would be:</p>
<pre><code>     1. Code new java.lang.String(&quot;apples&quot;) === &quot;apples&quot; evaluates to false
     2. Code new java.lang.String(&quot;apples&quot;) == &quot;apples&quot; evaluates to true
     3. Code new java.lang.String(&quot;apples&quot;) !== &quot;apples&quot; evaluates to true
     4. Code new java.lang.String(&quot;apples&quot;) != &quot;apples&quot; evaluates to false
     5. Code new java.lang.Integer(1) === 1 evaluates to false
     6. Code new java.lang.Integer(1) == 1 evaluates to true
     7. Code new java.lang.Integer(1) !== 1 evaluates to true
     8. Code new java.lang.Integer(1) != 1 evaluates to false
     9. Code java.lang.Boolean.TRUE === true evaluates to false
    10. Code java.lang.Boolean.TRUE == true evaluates to true
    11. Code java.lang.Boolean.TRUE !== true evaluates to true
    12. Code java.lang.Boolean.TRUE != true evaluates to false
</code></pre>
<p>Evaluations of Java objects in JavaScript constructs where the operand is automatically type coerced will work, but Rhino might complain about the Java objects not correctly calling the Rhino helper function <code>Context.javaToJS()</code>. In order to avoid these warnings it's better to explicitly perform your comparisons like in the following example:</p>
<pre><code>    if (myObject) {
        ...
    }
    // should be replaced by
    if (myObject != null) {
       ...
    }

    myObject ? 'this' : 'that'
    //should be replaced by
    myObject != null ? 'this' : 'that'
</code></pre>
<h3><a href="#script-use-provider" id="script-use-provider">Script Use Provider</a></h3>
<p>The Script Use Provider allows loading objects evaluated by other script engines available on the platform. The same loading considerations as for the Java and JavaScript Use Providers apply.</p>
<h3><a href="#picking-the-best-use-provider-for-a-project" id="picking-the-best-use-provider-for-a-project">Picking the best Use Provider for a project</a></h3>
<p>The following table summarises the pros and cons for each Use Provider, with the obvious exception of the Render Unit Use Provider.</p>
<table>
  <tr>
   <th>Use Provider</th>
   <th>Advantages</th>
   <th>Disadvantages</th>
  </tr>
  <tr>
    <td>Java Use Provider</td>
    <td>
      <p>Use-objects provided through bundles:</p>
      <ul>
        <li>easy to extend from other similar Use-objects</li>
        <li>simple setup for unit testing</li>
      </ul>
      <p>Use-objects backed by <code>Resources</code>:</p>
      <ul>
        <li>easy to override from inheriting components through search path overlay or by using the <code>sling:resourceSuperType</code> property, allowing for greater flexibility</li>
        <li>business logic for components sits next to the HTL scripts where the objects are used</li>
      </ul>
    </td>
    <td>
      <p>Use-objects provided through bundles:</p>
      <ul>
        <li>lacks flexibility in terms of component overlaying, unless the HTL script works with <a href="#sling-models-or-java-use-objects">interfaces</a></li>
      </ul>
      <p>Use-objects backed by <code>Resources</code>:</p>
      <ul>
        <li>cannot extend other Java objects</li>
        <li>the Java project might need a different setup to allow running unit tests, since the objects will be deployed like content</li>
      </ul>
    </td>
  </tr>
  <tr>
  <td>JavaScript Use Provider</td>
  <td>
    <ul>
      <li>allows JavaScript developers to develop component logic</li>
      <li>can be reused through the dependency mechanism provided by the <code>use</code> function</li>
    </ul>
  </td>
  <td>
    <ul>
      <li>harder to test and debug, relying mostly on end-to-end testing and console logging</li>
      <li>slower to execute than both Sling Models and Java Use-API objects</li>
    </ul>
  </td>
  </tr>
  <tr>
    <td>Script Use Provider</td>
    <td>
      <ul>
        <li>allows the usage of Use objects evaluated by other Script Engines available in the platform</li>
      </ul>
    </td>
    <td>
      <ul>
        <li>like in the case of the JavaScript Use Provider, the performance is influenced by the Script Engine's implementation</li>
      </ul>
    </td>
  </tr>
</table>
</section></div></div><div data-pagefind-body="true" data-pagefind-weight="7.0" style="display:none;"> - ( HTL Scripting Engine )</div>                            
                        </div>
                    </div>
                </div>
            </div><footer class="footer">
                <div class="content has-text-centered is-small">
<div class="editpagelink">
                        This page can be edited on GitHub at <a href="https://github.com/apache/sling-site/edit/master/src/main/jbake/content/documentation/bundles/scripting/scripting-htl.md">
                            content/documentation/bundles/scripting/scripting-htl.md
                        </a>
                    </div>                    <div class="revisionInfo">
                        Last modified by <span class="author">Paulo Chang</span> on <span class="comment">2024-05-27</span>
                    </div><p>
                        Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project
    logo are trademarks of The Apache Software Foundation. All other marks mentioned 
    may be trademarks or registered trademarks of their respective owners.
                    </p><p>
                        Copyright © 2007-2025<a href="https://www.apache.org/">
                            The Apache Software Foundation
                        </a>|<a href="https://privacy.apache.org/policies/privacy-policy-public.html">
                            Privacy Policy
                        </a>
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>