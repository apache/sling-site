<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: Sling Servlet Helpers and Internal Requests</title>
        <link rel="icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <script src='https://www.apachecon.com/event-images/snippet.js'></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
	<!-- Matomo Web Analytics -->
	<script>
	var _paq = window._paq = window._paq || [];
	/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
	/* We explicitly disable cookie tracking to avoid privacy issues */
	_paq.push(['disableCookies']); 
	_paq.push(['trackPageView']);
	_paq.push(['enableLinkTracking']);
	(function() {
	  var u="https://matomo.privacy.apache.org/";
	  _paq.push(['setTrackerUrl', u+'matomo.php']);
	  _paq.push(['setSiteId', '6']);
	  var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
	  g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
	})();
	</script>
	<!-- End Matomo Code -->
	<link href='/pagefind/pagefind-ui.css' rel='stylesheet'><script src='/pagefind/pagefind-ui.js' type='text/javascript'></script>
	<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#searchbox" });
    });
	</script>
	
    </head>    <body>
        <div class="section">
            <div class="level is-marginless">
<div class="logo">
                    <a href="https://sling.apache.org">
                        <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                    </a>
                </div><div class="header">
                    <a href="https://www.apache.org">
                        <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                    </a>
                </div>                
            </div><section class="searchbox level is-marginless">
                <div id="searchbox"></div>
            </section><div class="columns is-gapless">
                <div class="column is-narrow sidemenu">
<div class="container">
                        <nav class="menu">
                            <ul class="menu-list box is-shadowless is-marginless">
                                <li>
                                    <p class="menu-label">
                                        <strong>Documentation</strong>
                                    </p><ul>
                                        <li><a href="/documentation.html">Overview</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>API Docs</strong>
                                    </p><ul>
                                        <li><a href="/apidocs/sling12/index.html">Sling 12</a></li><li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Support</strong>
                                    </p><ul>
                                        <li><a href="https://s.apache.org/sling.wiki">Wiki</a></li><li><a href="https://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Sitemap</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Project Info</strong>
                                    </p><ul>
                                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="https://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Source</strong>
                                    </p><ul>
                                        <li><a href="/repolist.html">Repositories</a></li><li><a href="https://gitbox.apache.org/repos/asf?s=sling">Git at Apache</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Apache Software<br>Foundation</strong>
                                    </p><ul>
                                        <li><a href="https://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="https://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li>
                                    </ul>
                                </li><li>
                                    <a class="acevent" data-format="square" data-event="random"></a>
                                </li><li>
                                    <a href="https://apache.org/foundation/contributing.html" class="column">
                                        <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>                    
                </div><div class="column main">
                    <div class="box is-shadowless is-marginless">
                        <div class="level">
                            <div class="pagenav">
<div class="breadcrumb">
                                    <ul>
                                        <li>
                                            <a href="/">
                                                Home
                                            </a>
                                        </li><li>
                                            <a href="/documentation.html">
                                                Documentation
                                            </a>
                                        </li><li>
                                            <a href="/documentation/bundles.html">
                                                Bundles
                                            </a>
                                        </li>
                                    </ul>
                                </div>                                
                            </div><div class="tags">
                                <span class="tag">
                                    <a href="/tags/servlets.html">
                                        servlets
                                    </a>
                                </span><span class="tag">
                                    <a href="/tags/requests.html">
                                        requests
                                    </a>
                                </span><span class="tag">
                                    <a href="/tags/scripts.html">
                                        scripts
                                    </a>
                                </span><span class="tag">
                                    <a href="/tags/servletresolver.html">
                                        servletresolver
                                    </a>
                                </span>
                            </div>
                        </div><h1 class="title">
                            Sling Servlet Helpers and Internal Requests
                        </h1><nav class="menu">
                            <ul class="menu-list box is-shadowless is-paddingless">
                                <li id="generatedToC">
                                    <p class="menu-label">
                                        <strong>Table of Contents</strong>
                                    </p>
                                </li>
                            </ul>
                        </nav><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=title],h2,h3','ulClass':'menu-list'}); } );</script><div class="content is-marginless">
<div class="row" data-pagefind-body="true"><div><section><p>The <a href="https://github.com/apache/sling-org-apache-sling-servlet-helpers">Sling Servlet Helpers</a> bundle provides mock implementations of the <code>SlingHttpServletRequest</code>, <code>SlingHttpServletResponse</code> and related classes, along with fluent <code>SlingInternalRequest</code> and <code>ServletInternalRequest</code> helpers for internal requests.</p>
<p>The mock request/response implementations are meant to be used in tests and also with services like the <code>SlingRequestProcessor</code> when making requests to that service outside of an HTTP request processing context.</p>
<p>They are used under the hood by the <code>SlingInternalRequest</code> and <code>ServletInternalRequest</code> helpers to provide a simple and foolproof way of executing internal Sling requests.</p>
<p>The <a href="https://github.com/apache/sling-org-apache-sling-graphql-core/">GraphQL Core</a> module, for example, uses them for internal requests that retrieve a GraphQL schema dynamically, taking into account the current Resource and request selectors.</p>
<p>See the <a href="https://github.com/apache/sling-org-apache-sling-servlet-helpers">automated tests</a> of the <code>servlet-helpers</code> module for more info, besides the general descriptions found below.</p>
<h2><a href="#internalrequest-helpers" id="internalrequest-helpers">InternalRequest helpers</a></h2>
<p>The internal request helpers use either a <code>SlingRequestProcessor</code> to execute internal requests using the full Sling request processing pipeline, or a <code>ServletResolver</code> to resolve and call a Servlet or Script directly. The necessary &quot;mocking&quot; of requests are responses happens under the hood which leads to much simpler code than using the mock request/response classes directly.</p>
<p>The latter direct-to-servlet (or script) mode is more efficient but less faithful to the way HTTP requests are processed, as it bypasses all Servlet Filters, in particular.</p>
<p>Here's an example using the <code>SlingInternalRequest</code> helper - see the test code for more. The <code>ServletInternalRequest</code> API is very similar but takes a <code>ServletResolver</code> and an actual <code>Resource</code> as its starting points.</p>
<pre><code>OutputStream os = new SlingInternalRequest(resourceResolver, slingRequestProcessor, path)
  .withResourceType(&quot;website/article/news&quot;)
  .withResourceSuperType(&quot;website/article&quot;)
  .withSelectors(&quot;print&quot;, &quot;a4&quot;)
  .withExtension(&quot;pdf&quot;)
  .execute()
  .checkStatus(200)
  .checkResponseContentType(&quot;application/pdf&quot;)
  .getResponse()
  .getOutputStream()
</code></pre>
<p>Not all servlets and scripts are suitable to be called by the <code>ServletInternalRequest</code>, depending on their &quot;environmental&quot; requirements like <code>Request</code> attributes for example.</p>
<p>In case of doubt you can start with the <code>SlingInternalRequest</code> helper which uses the <code>SlingRequestProcessor</code> so that servlets or scripts should see no difference compared to HTTP requests. And once that works you can try the more efficient <code>ServletInternalRequest</code> helper to check if your scripts and servlets support that mode.</p>
<p>In both cases, the standard <a href="/documentation/the-sling-engine/servlets.html">Sling Servlet/Script resolution mechanism</a> is used, which can be useful to execute scripts that are resolved based on the current resource type, for non-HTTP operations. Inventing HTTP method names for this is fine and allows for reusing this powerful resolution mechanism in other contexts.</p>
<h3><a href="#troubleshooting-internal-requests" id="troubleshooting-internal-requests">Troubleshooting internal requests</a></h3>
<p>To help map log messages to internal requests, as several of those might be used to handle a single HTTP request, the <code>InternalRequest</code> parent class of the helpers discussed above sets a log4j <em>Mapped Diagnostic Context</em> (MDC) value with the <code>sling.InternalRequest</code>key.</p>
<p>The value of that key provides the essential attributes of the current request, so that using a log formatting pattern that displays it, like:</p>
<pre><code>%-5level [%-50logger{50}] %message ## %mdc{sling.InternalRequest} %n
</code></pre>
<p>Causes the internal request information to be logged, like in this example (lines folded for readability):</p>
<pre><code>DEBUG [o.a.s.s.internalrequests.SlingInternalRequest     ]
   Executing request using the SlingRequestProcessor
   ## GET P=/content/tags/monitor+array S=null EXT=json RT=samples/tag(null)
WARN  [org.apache.sling.engine.impl.request.RequestData  ]
  SlingRequestProgressTracker not found in request attributes
  ## GET P=/content/tags/monitor+array S=null EXT=json RT=samples/tag(null)
DEBUG [o.a.s.s.resolver.internal.SlingServletResolver    ]
  Using cached servlet /apps/samples/tag/json.gql
  ## GET P=/content/tags/monitor+array S=null EXT=json RT=samples/tag(null)
</code></pre>
<p>In these log messages, <code>GET P=/content/tags/monitor+array S=null EXT=json RT=samples/tag(null)</code> points to the current internal request, showing its method, path, selectors, extension, resource type and resource supertype.</p>
<h2><a href="#mock-requestresponse-classes" id="mock-requestresponse-classes">Mock Request/Response classes</a></h2>
<p>These are useful for testing or if you need to do something that the internal request helpers do not support.</p>
<h3><a href="#slinghttpservletrequest" id="slinghttpservletrequest">SlingHttpServletRequest</a></h3>
<p>Example for preparing a sling request with custom request data:</p>
<pre><code><!-- TODO syntax marker (#!java) disabled -->// prepare sling request
MockSlingHttpServletRequest request = new MockSlingHttpServletRequest(resourceResolver);

// simulate query string
request.setQueryString(&quot;param1=aaa&amp;param2=bbb&quot;);

// alternative - set query parameters as map
request.setParameterMap(ImmutableMap.&lt;String,Object&gt;builder()
    .put(&quot;param1&quot;, &quot;aaa&quot;)
    .put(&quot;param2&quot;, &quot;bbb&quot;)
    .build());

// set current resource
request.setResource(resourceResolver.getResource(&quot;/content/sample&quot;));

// set sling request path info properties
MockRequestPathInfo requestPathInfo = (MockRequestPathInfo)request.getRequestPathInfo();
requestPathInfo.setSelectorString(&quot;selector1.selector2&quot;);
requestPathInfo.setExtension(&quot;html&quot;);

// set method
request.setMethod(HttpConstants.METHOD_POST);

// set attributes
request.setAttribute(&quot;attr1&quot;, &quot;value1&quot;);

// set headers
request.addHeader(&quot;header1&quot;, &quot;value1&quot;);

// set cookies
request.addCookie(new Cookie(&quot;cookie1&quot;, &quot;value1&quot;));
</code></pre>
<h3><a href="#slinghttpservletresponse" id="slinghttpservletresponse">SlingHttpServletResponse</a></h3>
<p>Example for preparing a sling response which can collect the data that was written to it:</p>
<pre><code><!-- TODO syntax marker (#!java) disabled -->// prepare sling response
MockSlingHttpServletResponse response = new MockSlingHttpServletResponse();

// execute the code that writes to the response...

// validate status code
assertEquals(HttpServletResponse.SC_OK, response.getStatus());

// validate content type and content length
assertEquals(&quot;text/plain;charset=UTF-8&quot;, response.getContentType());
assertEquals(CharEncoding.UTF_8, response.getCharacterEncoding());
assertEquals(55, response.getContentLength());

// validate headers
assertTrue(response.containsHeader(&quot;header1&quot;));
assertEquals(&quot;5&quot;, response.getHeader(&quot;header2&quot;));

// validate response body as string
assertEquals(TEST_CONTENT, response.getOutputAsString());

// validate response body as binary data
assertArrayEquals(TEST_DATA, response.getOutput());
</code></pre>
</section></div></div><div data-pagefind-body="true" data-pagefind-weight="7.0" style="display:none;"> - ( Sling Servlet Helpers and Internal Requests )</div>                            
                        </div>
                    </div>
                </div>
            </div><footer class="footer">
                <div class="content has-text-centered is-small">
<div class="editpagelink">
                        This page can be edited on GitHub at <a href="https://github.com/apache/sling-site/edit/master/src/main/jbake/content/documentation/bundles/servlet-helpers.md">
                            content/documentation/bundles/servlet-helpers.md
                        </a>
                    </div>                    <div class="revisionInfo">
                        Last modified by <span class="author">Bertrand Delacretaz</span> on <span class="comment">2020-06-16</span>
                    </div><p>
                        Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project
    logo are trademarks of The Apache Software Foundation. All other marks mentioned 
    may be trademarks or registered trademarks of their respective owners.
                    </p><p>
                        Copyright © 2007-2024<a href="https://www.apache.org/">
                            The Apache Software Foundation
                        </a>|<a href="https://privacy.apache.org/policies/privacy-policy-public.html">
                            Privacy Policy
                        </a>
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>