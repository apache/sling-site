<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: JCR Installer Provider</title>
        <link rel="icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <script src='https://www.apachecon.com/event-images/snippet.js'></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
	<!-- Matomo Web Analytics -->
	<script>
	var _paq = window._paq = window._paq || [];
	/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
	/* We explicitly disable cookie tracking to avoid privacy issues */
	_paq.push(['disableCookies']); 
	_paq.push(['trackPageView']);
	_paq.push(['enableLinkTracking']);
	(function() {
	  var u="https://matomo.privacy.apache.org/";
	  _paq.push(['setTrackerUrl', u+'matomo.php']);
	  _paq.push(['setSiteId', '6']);
	  var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
	  g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
	})();
	</script>
	<!-- End Matomo Code -->
	<link href='/pagefind/pagefind-ui.css' rel='stylesheet'><script src='/pagefind/pagefind-ui.js' type='text/javascript'></script>
	<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#searchbox" });
    });
	</script>
	
    </head>    <body>
        <div class="section">
            <div class="level is-marginless">
<div class="logo">
                    <a href="https://sling.apache.org">
                        <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                    </a>
                </div><div class="header">
                    <a href="https://www.apache.org">
                        <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                    </a>
                </div>                
            </div><section class="searchbox level is-marginless">
                <div id="searchbox"></div>
            </section><div class="columns is-gapless">
                <div class="column is-narrow sidemenu">
<div class="container">
                        <nav class="menu">
                            <ul class="menu-list box is-shadowless is-marginless">
                                <li>
                                    <p class="menu-label">
                                        <strong>Documentation</strong>
                                    </p><ul>
                                        <li><a href="/documentation.html">Overview</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>API Docs</strong>
                                    </p><ul>
                                        <li><a href="/apidocs/sling12/index.html">Sling 12</a></li><li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Support</strong>
                                    </p><ul>
                                        <li><a href="https://s.apache.org/sling.wiki">Wiki</a></li><li><a href="https://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Sitemap</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Project Info</strong>
                                    </p><ul>
                                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="https://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Source</strong>
                                    </p><ul>
                                        <li><a href="/repolist.html">Repositories</a></li><li><a href="https://gitbox.apache.org/repos/asf?s=sling">Git at Apache</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Apache Software<br>Foundation</strong>
                                    </p><ul>
                                        <li><a href="https://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="https://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li>
                                    </ul>
                                </li><li>
                                    <a class="acevent" data-format="square" data-event="random"></a>
                                </li><li>
                                    <a href="https://apache.org/foundation/contributing.html" class="column">
                                        <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>                    
                </div><div class="column main">
                    <div class="box is-shadowless is-marginless">
                        <div class="level">
                            <div class="pagenav">
<div class="breadcrumb">
                                    <ul>
                                        <li>
                                            <a href="/">
                                                Home
                                            </a>
                                        </li><li>
                                            <a href="/documentation.html">
                                                Documentation
                                            </a>
                                        </li><li>
                                            <a href="/documentation/bundles.html">
                                                Bundles
                                            </a>
                                        </li>
                                    </ul>
                                </div>                                
                            </div><div class="tags">
                                <span class="tag">
                                    <a href="/tags/installer.html">
                                        installer
                                    </a>
                                </span>
                            </div>
                        </div><h1 class="title">
                            JCR Installer Provider
                        </h1><nav class="menu">
                            <ul class="menu-list box is-shadowless is-paddingless">
                                <li id="generatedToC">
                                    <p class="menu-label">
                                        <strong>Table of Contents</strong>
                                    </p>
                                </li>
                            </ul>
                        </nav><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=title],h2,h3','ulClass':'menu-list'}); } );</script><div class="content is-marginless">
<div class="row" data-pagefind-body="true"><div><section><p>The JCR installer provider scans the JCR repository for artifacts and provides them to the <a href="/documentation/bundles/osgi-installer.html">OSGI installer</a>.</p>
<h1><a href="#configuration-and-scanning" id="configuration-and-scanning">Configuration and Scanning</a></h1>
<p>The JCR installer provider can be configured with weighted paths which are scanned. By default, the installer scans in <code>/apps</code> and <code>/libs</code> where artifacts found in <code>/apps</code> get a higher priority. The installer does a deep scan and uses a regular expression to detect folders containing artifacts to be installed. By default, artifacts from within a folder named <code>install</code> are provided to the OSGi installer.</p>
<p>If such an install folder contains a binary artifact (e.g. a bundle or a config file as described in <a href="/documentation/bundles/configuration-installer-factory.html">Configuration Installer Factory</a>) this is provided to the OSGi installer.</p>
<p>In addition every node of type <code>sling:OsgiConfig</code> is provided as a configuration to the installer. This has the advantage of leveraging the JCR structure better than binary files, but has the known limitations outlined in <a href="https://issues.apache.org/jira/browse/SLING-4183">SLING-4183</a> and <a href="https://issues.apache.org/jira/browse/SLING-2477">SLING-2477</a>, therefore it is recommended to stick to one of the binary formats described in <a href="/documentation/bundles/configuration-installer-factory.html">Configuration Installer Factory</a>.</p>
<p>The JCR installer provider does not check or scan the artifacts itself, the detection and installation is deferred to the OSGi installer.</p>
<h2><a href="#run-mode-support" id="run-mode-support">Run Mode Support</a></h2>
<p>The JCR installer supports <a href="sling-settings-org-apache-sling-settings.html">run modes</a> for installing artifacts. By default folders named <code>install</code> are checked for artifacts. If Apache Sling is started with one (or more run modes), all folders named <code>install.[RUNMODE]</code> are scanned as well. To be precise, the folder name can be followed by any number of run modes separated by dot (<code>.</code>). For example, if started with run modes <code>dev</code>, <code>a1</code>, and <code>public</code>, folders like <code>install.dev</code>, <code>install.a1</code>, <code>install.public</code> are searched as well as <code>install.dev.a1</code>, or <code>install.a1.dev</code>.</p>
<p>Since version 3.3.0 of the JCR Installer bundle (<a href="https://issues.apache.org/jira/browse/SLING-9031">SLING-9031</a> and <a href="https://issues.apache.org/jira/browse/SLING-8548">SLING-8548</a>) advanced run mode support has been added, so that folder names in the form <code>install.[RUNMODESPEC]</code> are supported. <code>RUNMODESPEC</code> is defined in <a href="/documentation/bundles/sling-settings-org-apache-sling-settings.html#decisions-based-on-run-modes">Sling Settings</a>.</p>
<p>Artifacts from folders with a run mode get a higher priority. For example by default, an <code>install</code> folder underneath <code>/libs</code> gets the priority <code>50</code>. For each matching run mode in the folder name, this priority is increased by <code>1</code>, so <code>install.dev</code> has <code>51</code> and <code>install.a1.dev</code> has <code>52</code>.</p>
<h2><a href="#start-level-support" id="start-level-support">Start Level Support</a></h2>
<p>If the parent folder of a bundle has a name which is a number, this is used as the start level (when installing the bundle for the first time, compare with <a href="https://issues.apache.org/jira/browse/SLING-2011">SLING-2011</a>). So e.g. a bundle in the path <code>/libs/sling/install/15/somebundle.jar</code> is having the start level <code>15</code>.</p>
<h2><a href="#write-back-support" id="write-back-support">Write Back Support</a></h2>
<p>The JCR installer supports writing back of configurations which are changed by some other ways, e.g by using the Apache Felix web console. If this is a new configuration which was not originally stored in the repository, a new configuration is stored under <code>/apps/sling/install</code>. The highest search path is used together with a configurable folder (<code>sling/install</code> in this case). If a configuration is changed which already exists in the repository, then it depends where the original configuration is stored. If its under <code>/libs</code> a new configuration at the same path under <code>/apps</code> is created. Otherwise the configuration is directly modified. As JCR properties do not support all Java primitive types like Integer, the write back does not generate a node of type <code>sling:OsgiConfig</code> in the repository but a .config file as described in <a href="/documentation/bundles/configuration-installer-factory.html">Configuration Installer Factory</a>.</p>
<p>Write back can be turned off by configuration.</p>
<h2><a href="#pausing-the-provider" id="pausing-the-provider">Pausing the provider</a></h2>
<p>In version 3.1.8 (<a href="https://issues.apache.org/jira/browse/SLING-3747">SLING-3747</a>) a mechanism has been added which pauses the scanning of artifacts. Whenever there is at least one child node below <code>/system/sling/installer/jcr/pauseInstallation</code> (path configurable), the provider will be paused i.e. not provide any artifacts to the OSGi installer. This is reasonable to do while executing operations which rely on certain services not being restarted. Every deployment of new bundles and configurations might potentially lead to restarts of existing services, e.g. due to new bundles being picked up by the <a href="https://lists.apache.org/thread.html/57d56e31da3c1cb743cf524e0c85e46959f3af9ed946f2c4a41d33c0@%3Cdev.sling.apache.org%3E">Dynamic Class Loader Provider</a> or new OSGi configurations leading to restarts of (transitively) bound services).</p>
<h1><a href="#example" id="example">Example</a></h1>
<p>Here's a quick walkthrough of the JCR installer functionality.</p>
<h2><a href="#installation" id="installation">Installation</a></h2>
<p>Run the <a href="https://github.com/apache/sling-org-apache-sling-starter">Sling Starter</a>.</p>
<p>To watch the logs produced by these modules, you can filter <code>sling/logs/error.log</code> using <code>egrep 'jcrinstall|osgi.installer'</code>.</p>
<h2><a href="#install-and-remove-a-bundle" id="install-and-remove-a-bundle">Install and remove a bundle</a></h2>
<p>We'll use the <a href="http://www.knopflerfish.org/releases/2.0.5/jars/desktop_awt/desktop_awt_all-2.0.0.jar">Knopflerfish Desktop</a> bundle for this example, it is convenient as it displays a graphical user interface when started.</p>
<p>We use <code>curl</code> to create content, to make it easy to reproduce the example by copying and pasting the <code>curl</code> commands. Any other way to create content in the repository will work, of course.</p>
<p>By default, JCRInstall picks up bundles found in folders named <em>install</em> under <code>/libs</code> and <code>/apps</code>, so we start by creating such a folder:</p>
<pre><code>curl -X MKCOL  http://admin:admin@localhost:8080/apps/jcrtest
curl -X MKCOL  http://admin:admin@localhost:8080/apps/jcrtest/install
</code></pre>
<p>And we copy the bundle to install in that folder (a backslash in command lines means <em>continued on next line</em>):</p>
<pre><code>curl -T desktop_awt_all-2.0.0.jar \
  http://admin:admin@localhost:8080/apps/jcrtest/install/desktop_awt_all-2.0.0.jar
</code></pre>
<p>That's it. After 2-3 seconds, the bundle should be picked up by JCRInstall, installed and started. If this works you'll see a small <em>Knopflerfish Desktop</em> window on your desktop, and Sling's OSGi console can of course be used to check the details.</p>
<p>Removing the bundle from the repository will cause it to be uninstalled, so:</p>
<pre><code>curl -X DELETE \
  http://admin:admin@localhost:8080/apps/jcrtest/install/desktop_awt_all-2.0.0.jar
</code></pre>
<p>Should cause the <em>Knopflerfish Desktop</em> window to disappear as the bundle is uninstalled.</p>
<h2><a href="#install-modify-and-remove-a-configuration" id="install-modify-and-remove-a-configuration">Install, modify and remove a configuration</a></h2>
<p>JCRInstall installs OSGi configurations from nodes having the <em>sling:OsgiConfig</em> node type, found in folders named <em>install</em> under the installation roots (/apps and /libs).</p>
<p>Let's try this feature by creating a configuration with two properties:</p>
<pre><code>curl \
  -F &quot;jcr:primaryType=sling:OsgiConfig&quot; \
  -F foo=bar -F works=yes \
  http://admin:admin@localhost:8080/apps/jcrtest/install/some.config.pid
</code></pre>
<p>And verify the contents of our config node:</p>
<pre><code>curl \
  http://admin:admin@localhost:8080/apps/jcrtest/install/some.config.pid.json
</code></pre>
<p>Which should display something like</p>
<pre><code>{&quot;foo&quot;:&quot;bar&quot;,
&quot;jcr:created&quot;:&quot;Wed Aug 26 2009 17:06:40GMT+0200&quot;,
&quot;jcr:primaryType&quot;:&quot;sling:OsgiConfig&quot;,&quot;works&quot;:&quot;yes&quot;}
</code></pre>
<p>At this point, JCRInstall should have picked up our new config and installed it. The logs would confirm that, but we can also use the OSGi console's config status page (http://localhost:8080/system/console/config) to check it. That page should now contain:</p>
<pre><code>PID=some.config.pid
  BundleLocation=Unbound
  _jcr_config_path=jcrinstall:/apps/jcrtest/install/some.config.pid
  foo=bars
  service.pid=some.config.pid
  works=yes
</code></pre>
<p>Indicating that the configuration has been installed.</p>
<p>Let's try modifying the configuration parameters:</p>
<pre><code>curl \
  -F works=updated -F even=more \
  http://admin:admin@localhost:8080/apps/jcrtest/install/some.config.pid
</code></pre>
<p>And check the changes in the console page:</p>
<pre><code>PID=some.config.pid
  BundleLocation=Unbound
  _jcr_config_path=jcrinstall:/apps/jcrtest/install/some.config.pid
  even=more
  foo=bars
  service.pid=some.config.pid
  works=updated
</code></pre>
<p>We can now delete the configuration node:</p>
<pre><code>curl -X DELETE \
  http://admin:admin@localhost:8080/apps/jcrtest/install/some.config.pid
</code></pre>
<p>And verify that the corresponding configuration is gone in the console page (after 1-2 seconds, like for all other JCRInstall operations).</p>
<p>A node named like <code>o.a.s.foo.bar-a</code> uses <em>o.a.s.foo.bar</em> as its factory PID creating a configuration with an automatically generated PID. The value of <em>a</em> is stored as an alias in the OSGi installer to correlate the configuration object with the repository node.</p>
<h1><a href="#automated-tests" id="automated-tests">Automated Tests</a></h1>
<p>The following modules contain lots of automated tests (under <code>src/test</code>, as usual):</p>
<ul>
<li>OSGi installer integration tests (<a href="https://github.com/apache/sling-org-apache-sling-installer-it">org.apache.sling.installer.it</a>)</li>
<li>JCR installer service (<a href="https://github.com/apache/sling-org-apache-sling-installer-provider-jcr">org.apache.sling.installer.providers.jcr</a>)</li>
</ul>
<p>Many of these tests are fairly readable, and can be used to find out in more detail how these modules work.</p>
<h1><a href="#project-info" id="project-info">Project Info</a></h1>
<ul>
<li>JCR installer provider (<a href="https://github.com/apache/sling-org-apache-sling-installer-provider-jcr">org.apache.sling.installer.provider.jcr</a>)</li>
</ul>
</section></div></div><div data-pagefind-body="true" data-pagefind-weight="7.0" style="display:none;"> - ( JCR Installer Provider )</div>                            
                        </div>
                    </div>
                </div>
            </div><footer class="footer">
                <div class="content has-text-centered is-small">
<div class="editpagelink">
                        This page can be edited on GitHub at <a href="https://github.com/apache/sling-site/edit/master/src/main/jbake/content/documentation/bundles/jcr-installer-provider.md">
                            content/documentation/bundles/jcr-installer-provider.md
                        </a>
                    </div>                    <div class="revisionInfo">
                        Last modified by <span class="author">Konrad Windszus</span> on <span class="comment">2020-09-18</span>
                    </div><p>
                        Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project
    logo are trademarks of The Apache Software Foundation. All other marks mentioned 
    may be trademarks or registered trademarks of their respective owners.
                    </p><p>
                        Copyright Â© 2007-2023<a href="https://www.apache.org/">
                            The Apache Software Foundation
                        </a>|<a href="https://privacy.apache.org/policies/privacy-policy-public.html">
                            Privacy Policy
                        </a>
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>