<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: Resource Filter</title>
        <link rel="icon" href="/res/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
    </head>    <body>
        <div class="section">
            <div class="level is-marginless">
<div class="logo">
                    <a href="https://sling.apache.org">
                        <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                    </a>
                </div><div class="header">
                    <a href="https://www.apache.org">
                        <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                    </a>
                </div>                
            </div><div class="columns is-gapless">
                <div class="column is-narrow sidemenu">
<div class="container">
                        <nav class="menu">
                            <ul class="menu-list box is-shadowless is-marginless">
                                <li>
                                    <p class="menu-label">
                                        <strong>Documentation</strong>
                                    </p><ul>
                                        <li><a href="/documentation.html">Overview</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>API Docs</strong>
                                    </p><ul>
                                        <li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Support</strong>
                                    </p><ul>
                                        <li><a href="https://s.apache.org/sling.wiki">Wiki</a></li><li><a href="https://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Site Map</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Project Info</strong>
                                    </p><ul>
                                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="https://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Source</strong>
                                    </p><ul>
                                        <li><a href="https://github.com/apache/?utf8=%E2%9C%93&q=sling">GitHub</a></li><li><a href="https://gitbox.apache.org/repos/asf?s=sling">Git at Apache</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Apache Software<br>Foundation</strong>
                                    </p><ul>
                                        <li><a href="https://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="https://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li>
                                    </ul>
                                </li><li>
                                    <a href="https://www.apache.org/events/current-event.html" class="column">
                                        <img border="0" alt="Current ASF Events" src="https://www.apache.org/events/current-event-125x125.png" width="125"/>
                                    </a>
                                </li><li>
                                    <a href="https://apache.org/foundation/contributing.html" class="column">
                                        <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>                    
                </div><div class="column main">
                    <div class="box is-shadowless is-marginless">
                        <div class="level">
                            <div class="pagenav">
<div class="breadcrumb">
                                    <ul>
                                        <li>
                                            <a href="/">
                                                Home
                                            </a>
                                        </li><li>
                                            <a href="/documentation.html">
                                                Documentation
                                            </a>
                                        </li><li>
                                            <a href="/documentation/bundles.html">
                                                Bundles
                                            </a>
                                        </li>
                                    </ul>
                                </div>                                
                            </div><div class="tags">
                                <span class="tag">
                                    <a href="/tags/requests.html">
                                        requests
                                    </a>
                                </span>
                            </div>
                        </div><h1 class="title">
                            Resource Filter
                        </h1><nav class="menu">
                            <ul class="menu-list box is-shadowless is-paddingless">
                                <li id="generatedToC">
                                    <p class="menu-label">
                                        <strong>Table of Contents</strong>
                                    </p>
                                </li>
                            </ul>
                        </nav><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=title],h2,h3','ulClass':'menu-list'}); } );</script><div class="content is-marginless">
<div class="row"><div><section><p><!-- TODO reactivate TOC once JBake moves to flexmark-java -->
</p>
<h2><a href="#introduction" name="introduction">Introduction</a></h2>
<p>Resource Filter bundle provides a number of services and utilities to identify and filter resources in a resource tree.</p>
<h2><a href="#resource-stream" name="resource-stream">Resource Stream</a></h2>
<p><code>ResourceStream</code> is a general utility. It provides two functions. The first is access to a <code>Stream&lt;Resource&gt;</code> which traverses a resource and it's subtree. The function takes a <code>Predicate&lt;Resource&gt;</code> object which is used to select the child nodes to be part of the traversal.</p>
<pre><code>ResourceStream rs = new ResourceStream(resource);
</code></pre>
<p>In addition there is a <code>getChildren(Predicate)</code> method which returns a filtered list of children of the given resource.</p>
<h2><a href="#resource-predicate-service" name="resource-predicate-service">Resource Predicate Service</a></h2>
<p><code>ResourcePredicate</code> is a service that allows you to convert a string that defines a simple matching requirements into a <code>Predicate&lt;Resource&gt;</code> for use with the Collections and the Streams Java API. In addition it also allows you to add parameters to the underlying context that the script will use.</p>
<pre><code>@Reference
ResourcePredicates rp;

Predicate&lt;Resource&gt; predicate = rp.parse(&quot;[jcr:content/created] &lt; 2013-08-08T16:32&quot;);
resourceCollection.stream().filter(predicate).forEach(
    resource -&gt; System.out.println(resource.getPath())
);
</code></pre>
<h2><a href="#resource-filter-stream" name="resource-filter-stream">Resource Filter Stream</a></h2>
<p><code>ResourceFilterStream</code> combines the <code>ResourceStream</code> functionality with the <code>ResourcePredicates</code> service to provide an ability to define a <code>Stream&lt;Resource&gt;</code> that follows specific child pages and looks for specific Resources as defined by the resources filter script. The ResourceStreamFilter is access by adaption.</p>
<pre><code>ResourceFilterStream rfs = resource.adaptTo(ResourceFilterStream.class);

rfs
  .setBranchSelector(&quot;[jcr:primaryType] == &#39;cq:Page&#39;&quot;)
  .setChildSelector(&quot;[jcr:content/sling:resourceType] != &#39;apps/components/page/folder&#39;&quot;)
  .stream()
  .collect(Collections.toList());
</code></pre>
<h2><a href="#resourcefilter-scripting" name="resourcefilter-scripting">ResourceFilter Scripting</a></h2>
<p>To ease the creation of a <code>Predicate&lt;Resource&gt;</code> a scripting implementation was developed that was designed to be visually similar to JCRSQL use of property identification where a property is compared to one or more values.</p>
<h3><a href="#operators" name="operators">Operators</a></h3>
<table>
  <thead>
    <tr>
      <th>Name </th>
      <th>Comparison Type </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>and </td>
      <td>NA </td>
      <td>Logical AND </td>
    </tr>
    <tr>
      <td>&amp;&amp; </td>
      <td>NA </td>
      <td>Logical AND </td>
    </tr>
    <tr>
      <td>or </td>
      <td>NA </td>
      <td>Logical OR </td>
    </tr>
    <tr>
      <td>&#124;&#124; </td>
      <td>NA </td>
      <td>Logical OR </td>
    </tr>
    <tr>
      <td>== </td>
      <td>String </td>
      <td>Equal operator for Strings </td>
    </tr>
    <tr>
      <td>&lt; </td>
      <td>Number </td>
      <td>Less than operator for Numbers </td>
    </tr>
    <tr>
      <td>&lt;= </td>
      <td>Number </td>
      <td>Less than or equal operator for Numbers </td>
    </tr>
    <tr>
      <td>&gt; </td>
      <td>Number </td>
      <td>Greater than operator for Numbers </td>
    </tr>
    <tr>
      <td>&gt;= </td>
      <td>Number </td>
      <td>Greater than or equal operator for Numbers </td>
    </tr>
    <tr>
      <td>!= </td>
      <td>String </td>
      <td>Is not equal to for Strings </td>
    </tr>
    <tr>
      <td>~= </td>
      <td>String - Regex </td>
      <td>Regex match against String </td>
    </tr>
    <tr>
      <td>less than </td>
      <td>Number </td>
      <td>less than operator for Numbers </td>
    </tr>
    <tr>
      <td>greater than </td>
      <td>Number </td>
      <td>greater than operator for Numbers </td>
    </tr>
    <tr>
      <td>is </td>
      <td>String </td>
      <td>Equal operator for Strings </td>
    </tr>
    <tr>
      <td>is not </td>
      <td>String </td>
      <td>Is not equal operator for Strings </td>
    </tr>
    <tr>
      <td>like </td>
      <td>String - Regex </td>
      <td>Regex match against String </td>
    </tr>
    <tr>
      <td>is like </td>
      <td>String - Regex </td>
      <td>Regex match against String </td>
    </tr>
    <tr>
      <td>not like </td>
      <td>String - Regex </td>
      <td>Regex does not match String </td>
    </tr>
    <tr>
      <td>contains </td>
      <td>String[] </td>
      <td>String[] contains all of items </td>
    </tr>
    <tr>
      <td>contains not </td>
      <td>String[] </td>
      <td>String[] does not contain all of the items </td>
    </tr>
    <tr>
      <td>contains any </td>
      <td>String[] </td>
      <td>String[] contains at least one of items </td>
    </tr>
    <tr>
      <td>contains not any </td>
      <td>String[] </td>
      <td>String[] does not contain any of the items </td>
    </tr>
  </tbody>
</table>
<h3><a href="#logical-operators" name="logical-operators">Logical Operators</a></h3>
<p>The 'and' and 'or' operators are logical operators that string together conditions. 'And' operators take precedence. 'Or' operators evaluate from left to right</p>
<h3><a href="#values" name="values">Values</a></h3>
<p>Values for comparison are obtained through multiple methods</p>
<table>
  <thead>
    <tr>
      <th>Method </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Literal </td>
      <td>Single(') or double (") quoted text in the query will be interpreted as a String. Boolean values of <em>true</em> and <em>false</em> will be translated to a String. </td>
    </tr>
    <tr>
      <td>Property </td>
      <td>A String between square brackets '[',']'s will be interpreted as a property value and will be retrieved from the Resource using the get method </td>
    </tr>
    <tr>
      <td>Function </td>
      <td>A string followed by parens containing an optional comma separated list of values. </td>
    </tr>
  </tbody>
</table>
<h3><a href="#types" name="types">Types</a></h3>
<p>All types are converted to either a String or a Number. For direct equivalence the comparison is done as a String. For relational comparisons the object will be adapted to a number.</p>
<h3><a href="#dates-instants" name="dates-instants">Dates/Instants</a></h3>
<p>Dates are special, there are multiple ways to enter a date.</p>
<p>In line, as part of the query, a date can be identified as a string that conforms to a standard ISO-8601 date time.</p>
<blockquote>
  <p>'2013-08-08T16:32:59.000'</p>
  <p>'2013-08-08T16:32:59'</p>
  <p>'2013-08-08T16:32'</p>
</blockquote>
<p>Are all valid date representations that are defaulting to the UTC timezone.</p>
<p>For a ISO8601 date with timezone offset use the date function.</p>
<blockquote>
  <p>date('2013-08-08T16:32:59.000+02:00')</p>
</blockquote>
<p>If you need a different date format then the date function can accommodate that</p>
<blockquote>
  <p>date('2013-08-08','yyyy-MM-dd')</p>
</blockquote>
<p>Or you can add your own custom Function </p>
<p>Dates are transitionally represented as a java.util.Instant which is then converted to a String in ISO-8601 format or as a Long number based on the type of comparison. The number representing the time in milliseconds since the EPOCH UTC region</p>
<h3><a href="#functions" name="functions">Functions</a></h3>
<p>Functions provide additional functionality to the Filter language. A Function is written in the format</p>
<blockquote>
  <p>string '(' comma, separated, list() ')'</p>
</blockquote>
<p>OOTB Functions are:</p>
<table>
  <thead>
    <tr>
      <th>Name </th>
      <th>Arguments </th>
      <th>Returns </th>
      <th>Description </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>name </td>
      <td>none </td>
      <td>String </td>
      <td>Provides the name of the resource </td>
    </tr>
    <tr>
      <td>date </td>
      <td>0 - 2 </td>
      <td>Instant </td>
      <td>First argument is string representation of the date, second argument is a standard Java DateFormat representation of the value. No argument returns the current time. </td>
    </tr>
    <tr>
      <td>path </td>
      <td>none </td>
      <td>String </td>
      <td>path of the tested resource </td>
    </tr>
  </tbody>
</table>
<h3><a href="#parameters" name="parameters">Parameters</a></h3>
<p>The ResourceFilter and ResourceFilteStream can have key value pairs added so that the values may be used as part of the script resolution. Parameters are accessed by using the dollar sign '$'</p>
<pre><code>rfs.setBranchSelector(&quot;[jcr:content/sling:resourceType] != $type&quot;).addParam(&quot;type&quot;,&quot;apps/components/page/folder&quot;);
</code></pre>
<h2><a href="#optimizing-traversals" name="optimizing-traversals">Optimizing Traversals</a></h2>
<p>Similar to indexing in a query there are strategies that you can do within a tree traversal so that traversals can be done in an efficient manner across a large number of resources. The following strategies will assist in traversal optimization.</p>
<h3><a href="#limit-traversal-paths" name="limit-traversal-paths">Limit traversal paths</a></h3>
<p>In a naive implementation of a tree traversal the traversal occurs across all nodes in the tree regardless of the ability of the tree structure to support the nodes that are being looked for. An example of this is a tree of Page resources that have have a child node of jcr:content which contains a subtree of data to define the page structure. If the jcr:content node is not capable of having a child resource of type Page and the goal of the traversal is to identify Page resources that match a specific criteria then the traversal of the jcr:content node can not lead to additional matches. Using this knowledge of the resource structure, you can improve performance by adding a branch selector that prevents the traversal from proceeding down a non productive path</p>
<h3><a href="#limit-memory-consumption" name="limit-memory-consumption">Limit memory consumption</a></h3>
<p>The instantiation of a Resource object from the underlying ResourceResolver is a non trivial consumption of memory. When the focus of a tree traversal is obtaining information from thousands of Resources, an effective method is to extract the information as part of the stream processing or utilizing the forEach method of the ResourceStream object which allows the resource to be garbage collected in an efficient manner. </p></section></div></div>                            
                        </div>
                    </div>
                </div>
            </div><footer class="footer">
                <div class="content has-text-centered is-small">
<div class="revisionInfo">
                        Last modified by <span class="author">Jason E Bailey</span> on <span class="comment">Sat Jul 13 21:50:24 2019 -0400</span>
                    </div>                    <p>
                        Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
                    </p><p>
                        Copyright Â© 2007-2020 The Apache Software Foundation.
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>