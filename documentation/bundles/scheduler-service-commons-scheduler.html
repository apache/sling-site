<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: Scheduler Service (commons scheduler)</title>
        <link rel="icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <script src='https://www.apachecon.com/event-images/snippet.js'></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
	<!-- Matomo Web Analytics -->
	<script>
	var _paq = window._paq = window._paq || [];
	/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
	/* We explicitly disable cookie tracking to avoid privacy issues */
	_paq.push(['disableCookies']); 
	_paq.push(['trackPageView']);
	_paq.push(['enableLinkTracking']);
	(function() {
	  var u="https://matomo.privacy.apache.org/";
	  _paq.push(['setTrackerUrl', u+'matomo.php']);
	  _paq.push(['setSiteId', '6']);
	  var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
	  g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
	})();
	</script>
	<!-- End Matomo Code -->
	<link href='/pagefind/pagefind-ui.css' rel='stylesheet'><script src='/pagefind/pagefind-ui.js' type='text/javascript'></script>
	<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#searchbox" });
    });
	</script>
	
    </head>    <body>
        <div class="section">
            <div class="level is-marginless">
<div class="logo">
                    <a href="https://sling.apache.org">
                        <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                    </a>
                </div><div class="header">
                    <a href="https://www.apache.org">
                        <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                    </a>
                </div>                
            </div><section class="searchbox level is-marginless">
                <div id="searchbox"></div>
            </section><div class="columns is-gapless">
                <div class="column is-narrow sidemenu">
<div class="container">
                        <nav class="menu">
                            <ul class="menu-list box is-shadowless is-marginless">
                                <li>
                                    <p class="menu-label">
                                        <strong>Documentation</strong>
                                    </p><ul>
                                        <li><a href="/documentation.html">Overview</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>API Docs</strong>
                                    </p><ul>
                                        <li><a href="/apidocs/sling12/index.html">Sling 12</a></li><li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Support</strong>
                                    </p><ul>
                                        <li><a href="https://s.apache.org/sling.wiki">Wiki</a></li><li><a href="https://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Sitemap</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Project Info</strong>
                                    </p><ul>
                                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="https://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Source</strong>
                                    </p><ul>
                                        <li><a href="/repolist.html">Repositories</a></li><li><a href="https://gitbox.apache.org/repos/asf?s=sling">Git at Apache</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Apache Software<br>Foundation</strong>
                                    </p><ul>
                                        <li><a href="https://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="https://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li>
                                    </ul>
                                </li><li>
                                    <a class="acevent" data-format="square" data-event="random"></a>
                                </li><li>
                                    <a href="https://apache.org/foundation/contributing.html" class="column">
                                        <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>                    
                </div><div class="column main">
                    <div class="box is-shadowless is-marginless">
                        <div class="level">
                            <div class="pagenav">
<div class="breadcrumb">
                                    <ul>
                                        <li>
                                            <a href="/">
                                                Home
                                            </a>
                                        </li><li>
                                            <a href="/documentation.html">
                                                Documentation
                                            </a>
                                        </li><li>
                                            <a href="/documentation/bundles.html">
                                                Bundles
                                            </a>
                                        </li>
                                    </ul>
                                </div>                                
                            </div><div class="tags">
                                <span class="tag">
                                    <a href="/tags/scheduling.html">
                                        scheduling
                                    </a>
                                </span>
                            </div>
                        </div><h1 class="title">
                            Scheduler Service (commons scheduler)
                        </h1><nav class="menu">
                            <ul class="menu-list box is-shadowless is-paddingless">
                                <li id="generatedToC">
                                    <p class="menu-label">
                                        <strong>Table of Contents</strong>
                                    </p>
                                </li>
                            </ul>
                        </nav><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=title],h2,h3','ulClass':'menu-list'}); } );</script><div class="content is-marginless">
<div class="row" data-pagefind-body="true"><div><section><p>The scheduler is a service for scheduling other services/jobs (it uses the <a href="https://www.quartz-scheduler.org/">open source Quartz library</a>). The scheduler can be used in two ways, by registering the job through the scheduler API and by leveraging the whiteboard pattern that is supported by the scheduler. In most cases the whiteboard pattern is preferred.</p>
<div class="note">
The notion of Job used in this context is a different one than the one used for <a href="/documentation/bundles/apache-sling-eventing-and-job-handling.html">Sling Jobs</a>. The main difference is that a scheduler's job is not persisted.
</div>
<h2><a href="#examples-of-jobs-that-are-scheduled-by-leveraging-the-whiteboard-pattern" id="examples-of-jobs-that-are-scheduled-by-leveraging-the-whiteboard-pattern">Examples of jobs that are scheduled by leveraging the whiteboard pattern</a></h2>
<p>The following examples show you how to define and schedule a job by leveraging the whiteboard pattern.</p>
<h3><a href="#scheduling-with-a-cron-expression" id="scheduling-with-a-cron-expression">Scheduling with a cron expression</a></h3>
<p>The cron expression format is described in the <a href="https://www.quartz-scheduler.org/documentation/quartz-2.3.0/tutorials/tutorial-lesson-06.html">Quartz Cron Documentation</a> and requires either 6 or 7 fields separated by white space. The first field always indicates the second (not the minute).</p>
<p>The following job is executed every minute by setting <em>scheduler.expression</em> to the cron expression <code>0 * * * * ?</code>:</p>
<pre><code>package sling.docu.examples;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.apache.felix.scr.annotations.Component;
import org.apache.felix.scr.annotations.Service;
import org.apache.felix.scr.annotations.Property;

@Component
@Service(value = Runnable.class)
@Property( name = &quot;scheduler.expression&quot;, value = &quot;0 * * * * ?&quot;)
public class ScheduledCronJob implements Runnable {

	/** Default log. */
    protected final Logger log = LoggerFactory.getLogger(this.getClass());

    public void run() {
    	log.info(&quot;Executing a cron job (job#1) through the whiteboard pattern&quot;);
    }
//
}
</code></pre>
<h3><a href="#scheduling-at-periodic-times" id="scheduling-at-periodic-times">Scheduling at periodic times</a></h3>
<p>The following job is executed every ten seconds by setting <em>scheduler.period</em> to <em>10</em>:</p>
<pre><code>package sling.docu.examples;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.apache.felix.scr.annotations.Component;
import org.apache.felix.scr.annotations.Service;
import org.apache.felix.scr.annotations.Property;

@Component
@Service(value = Runnable.class)
@Property( name = &quot;scheduler.period&quot;, longValue = 10)
public class ScheduledPeriodicJob implements Runnable {

	/** Default log. */
    protected final Logger log = LoggerFactory.getLogger(this.getClass());

    public void run() {
    	log.info(&quot;Executing a perodic job (job#2) through the whiteboard pattern&quot;);
    }
//
}
</code></pre>
<h3><a href="#preventing-concurrent-execution" id="preventing-concurrent-execution">Preventing concurrent execution</a></h3>
<p>By default, jobs can be concurrently executed. To prevent this, set the <em>scheduler.concurrent</em> property to <em>false</em>:</p>
<pre><code>@Property(name=&quot;scheduler.concurrent&quot;, boolValue=false)
</code></pre>
<h3><a href="#scheduling-the-job-just-once-in-a-cluster" id="scheduling-the-job-just-once-in-a-cluster">Scheduling the job just once in a cluster</a></h3>
<p>If the same code/same services is executed on multiple nodes within a cluster, the same job might be scheduled on each instance. If this is not desired, the job can either be bound to the leader of the topology or a single instance (which one this is, is not further defined):</p>
<pre><code>@Property(name=&quot;scheduler.runOn&quot;, value=&quot;LEADER&quot;);
</code></pre>
<p>or</p>
<pre><code>@Property(name=&quot;scheduler.runOn&quot;, value=&quot;SINGLE&quot;);
</code></pre>
<p>Since in contrast to <a href="/documentation/bundles/apache-sling-eventing-and-job-handling.html">Sling Jobs</a> the scheduler queue is only held in memory, there will be no distribution of jobs. So if job '1' was scheduled on instance 'a' with the option to run on the leader only, but the leader is instance 'b', which hasn't the job in the queue, the job will never be executed by any instance!</p>
<h2><a href="#the-scheduler-api" id="the-scheduler-api">The Scheduler API</a></h2>
<p>The scheduler has methods to execute jobs periodically, based on a cron expression or at a given time. For more details please refer to the <a href="http://sling.apache.org/apidocs/sling6/org/apache/sling/commons/scheduler/Scheduler.html">javadocs</a>.</p>
<h2><a href="#examples-of-scheduled-jobs-registered-through-the-scheduler-api" id="examples-of-scheduled-jobs-registered-through-the-scheduler-api">Examples of scheduled jobs registered through the scheduler API</a></h2>
<p>The following examples show you how to define and schedule a job that is registered through the scheduler api.</p>
<h3><a href="#defining-the-job" id="defining-the-job">Defining the job</a></h3>
<p>The following code sample defines a <em>job</em> object that writes a message in the logs:</p>
<pre><code>final Runnable job = new Runnable() {
	public void run() {
		log.info(&quot;Executing the job&quot;);
	}
};
</code></pre>
<h3><a href="#scheduling-with-a-cron-expression" id="scheduling-with-a-cron-expression">Scheduling with a cron expression</a></h3>
<p>To execute the job as defined above at 10:15am every Monday, Tuesday, Wednesday, Thursday and Friday, you can use the <em>addJob()</em> method with the following parameters:</p>
<pre><code>String schedulingExpression = &quot;0 15 10 ? * MON-FRI&quot;;
this.scheduler.addJob(&quot;myJob&quot;, job, null, schedulingExpression, true);
</code></pre>
<p>Refer to http://www.docjar.com/docs/api/org/quartz/CronTrigger.html to define more scheduling expressions.</p>
<h3><a href="#scheduling-at-periodic-times" id="scheduling-at-periodic-times">Scheduling at periodic times</a></h3>
<p>To execute the job as defined above every 3 minutes (180 seconds), you can use the <em>addPeriodicJob()</em> method with the following parameters:</p>
<pre><code>long period = 3*60; //the period is expressed in seconds
this.scheduler.addPeriodicJob(&quot;myJob&quot;, job, null, period, true);
</code></pre>
<h3><a href="#scheduling-at-a-given-time" id="scheduling-at-a-given-time">Scheduling at a given time</a></h3>
<p>To execute the job as defined above at a specific date (on January 10th 2020), you can use the <em>fireJobAt()</em> method with the following parameters:</p>
<pre><code>SimpleDateFormat formatter = new SimpleDateFormat(&quot;yyyy/MM/dd&quot;);
String date = &quot;2020/01/10&quot;;
java.util.Date fireDate = formatter.parse(date);
this.scheduler.fireJobAt(&quot;myJob&quot;, job, null, fireDate);
</code></pre>
<h3><a href="#a-service-scheduling-the-job-based-on-3-different-kinds-of-scheduling" id="a-service-scheduling-the-job-based-on-3-different-kinds-of-scheduling">A service scheduling the job based on 3 different kinds of scheduling</a></h3>
<p>The code implementing a service that simultaneously executes the job based on 3 different kinds of scheduling can look as follows:</p>
<pre><code>package sling.docu.examples;

import java.io.Serializable;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

import org.apache.sling.commons.scheduler.Scheduler;
import org.osgi.service.component.ComponentContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.apache.felix.scr.annotations.Component;
import org.apache.felix.scr.annotations.Reference;

/**
 *  This service executes scheduled jobs
 *
 */
@Component
public class HelloWorldScheduledService {

    /** Default log. */
    protected final Logger log = LoggerFactory.getLogger(this.getClass());

    /** The scheduler for rescheduling jobs. */
    @Reference
    private Scheduler scheduler;


    protected void activate(ComponentContext componentContext) throws Exception {
        //case 1: with addJob() method: executes the job every minute
    	String schedulingExpression = &quot;0 * * * * ?&quot;;
    	String jobName1 = &quot;case1&quot;;
    	Map&lt;String, Serializable&gt; config1 = new HashMap&lt;String, Serializable&gt;();
    	boolean canRunConcurrently = true;
        final Runnable job1 = new Runnable() {
            public void run() {
            	log.info(&quot;Executing job1&quot;);
            }
        };
        try {
        	this.scheduler.addJob(jobName1, job1, config1, schedulingExpression, canRunConcurrently);
        } catch (Exception e) {
            job1.run();
        }

        //case 2: with addPeriodicJob(): executes the job every 3 minutes
        String jobName2 = &quot;case2&quot;;
    	long period = 180;
    	Map&lt;String, Serializable&gt; config2 = new HashMap&lt;String, Serializable&gt;();
        final Runnable job2 = new Runnable() {
            public void run() {
            	log.info(&quot;Executing job2&quot;);
            }
        };
        try {
        	this.scheduler.addPeriodicJob(jobName2, job2, config2, period, canRunConcurrently);
        } catch (Exception e) {
            job2.run();
        }

        //case 3: with fireJobAt(): executes the job at a specific date (date of deployment + delay of 30 seconds)
        String jobName3 = &quot;case3&quot;;
    	final long delay = 30*1000;
    	final Date fireDate = new Date();
        fireDate.setTime(System.currentTimeMillis() + delay);
    	Map&lt;String, Serializable&gt; config3 = new HashMap&lt;String, Serializable&gt;();
        final Runnable job3 = new Runnable() {
            public void run() {
            	log.info(&quot;Executing job3 at date: {} with a delay of: {} seconds&quot;, fireDate, delay/1000);
            }
        };
        try {
        	this.scheduler.fireJobAt(jobName3, job3, config3, fireDate);
        } catch (Exception e) {
            job3.run();
        }
    }

    protected void deactivate(ComponentContext componentContext) {
        log.info(&quot;Deactivated, goodbye!&quot;);
    }

}
</code></pre>
<h2><a href="#using-dedicated-thread-pools" id="using-dedicated-thread-pools">Using dedicated thread pools</a></h2>
<p>By default all scheduled jobs use the default thread pool of Sling (as provided by <a href="/documentation/bundles/apache-sling-commons-thread-pool.html">Apache Sling Commons Thread Pool</a>). But it is possible to define that a different thread pool to be used. This requires 2 steps: The thread pool must be explicitly allowed to be used and then the job must be configured accordingly. An optional 3rd step is to configure the thread pool.</p>
<h3><a href="#allow-a-thread-pool-to-be-used-by-the-scheduler" id="allow-a-thread-pool-to-be-used-by-the-scheduler">Allow a thread pool to be used by the scheduler</a></h3>
<p>You need to add the name of the threadpool to the OSGI property <code>allowedPoolNames</code> of the &quot;Apache Sling Scheduler&quot; service (pid: <code>org.apache.sling.commons.scheduler.impl.QuartzScheduler</code>).</p>
<h3><a href="#specify-the-name-of-the-thread-pool-when-scheduling-a-job" id="specify-the-name-of-the-thread-pool-when-scheduling-a-job">Specify the name of the thread pool when scheduling a job</a></h3>
<p>The way how you configure the thread pool to use depends on the way you schedule the job.</p>
<p>If you use the whiteboard pattern, just add an additional property to the definition:</p>
<pre><code>@Property(name=Scheduler.PROPERTY_SCHEDULER_THREAD_POOL,value=&quot;my-thread-pool&quot;)
</code></pre>
<p>If you use the scheduler API, you can specify the thread pool name via <a href="https://sling.apache.org/apidocs/sling11/org/apache/sling/commons/scheduler/ScheduleOptions.html#threadPoolName-java.lang.String-">SchedulingOptions.threadPoolName()</a>.</p>
<h3><a href="#configure-the-thread-pool" id="configure-the-thread-pool">Configure the thread pool</a></h3>
<p>By default the Scheduler will create <a href="/documentation/bundles/apache-sling-commons-thread-pool.html">Thread Pools</a> with default settings (5 threads at maximum). But you can also configure them explicitly and adjust them to your needs; for this you need to instantiate the &quot;Apache Sling Thread Pool Configuration&quot; service factory and provide the name of the threadpool as value of the OSGI property <code>name</code>.</p>
</section></div></div><div data-pagefind-body="true" data-pagefind-weight="7.0" style="display:none;"> - ( Scheduler Service (commons scheduler) )</div>                            
                        </div>
                    </div>
                </div>
            </div><footer class="footer">
                <div class="content has-text-centered is-small">
<div class="editpagelink">
                        This page can be edited on GitHub at <a href="https://github.com/apache/sling-site/edit/master/src/main/jbake/content/documentation/bundles/scheduler-service-commons-scheduler.md">
                            content/documentation/bundles/scheduler-service-commons-scheduler.md
                        </a>
                    </div>                    <div class="revisionInfo">
                        Last modified by <span class="author">Jörg Hoh</span> on <span class="comment">2022-01-04</span>
                    </div><p>
                        Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project
    logo are trademarks of The Apache Software Foundation. All other marks mentioned 
    may be trademarks or registered trademarks of their respective owners.
                    </p><p>
                        Copyright © 2007-2024<a href="https://www.apache.org/">
                            The Apache Software Foundation
                        </a>|<a href="https://privacy.apache.org/policies/privacy-policy-public.html">
                            Privacy Policy
                        </a>
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>