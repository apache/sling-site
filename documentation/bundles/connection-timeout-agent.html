<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: Connection Timeout Agent</title>
        <link rel="icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <script src='https://www.apachecon.com/event-images/snippet.js'></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
    </head>    <body>
        <div class="section">
            <div class="level is-marginless">
<div class="logo">
                    <a href="https://sling.apache.org">
                        <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                    </a>
                </div><div class="header">
                    <a href="https://www.apache.org">
                        <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                    </a>
                </div>                
            </div><div class="columns is-gapless">
                <div class="column is-narrow sidemenu">
<div class="container">
                        <nav class="menu">
                            <ul class="menu-list box is-shadowless is-marginless">
                                <li>
                                    <p class="menu-label">
                                        <strong>Documentation</strong>
                                    </p><ul>
                                        <li><a href="/documentation.html">Overview</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>API Docs</strong>
                                    </p><ul>
                                        <li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Support</strong>
                                    </p><ul>
                                        <li><a href="https://s.apache.org/sling.wiki">Wiki</a></li><li><a href="https://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Sitemap</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Project Info</strong>
                                    </p><ul>
                                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="https://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Source</strong>
                                    </p><ul>
                                        <li><a href="/repolist.html">Repositories</a></li><li><a href="https://gitbox.apache.org/repos/asf?s=sling">Git at Apache</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Apache Software<br>Foundation</strong>
                                    </p><ul>
                                        <li><a href="https://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="https://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li>
                                    </ul>
                                </li><li>
                                    <a class="acevent" data-format="square" data-event="random"></a>
                                </li><li>
                                    <a href="https://apache.org/foundation/contributing.html" class="column">
                                        <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>                    
                </div><div class="column main">
                    <div class="box is-shadowless is-marginless">
                        <div class="level">
                            <div class="pagenav">
<div class="breadcrumb">
                                    <ul>
                                        <li>
                                            <a href="/">
                                                Home
                                            </a>
                                        </li><li>
                                            <a href="/documentation.html">
                                                Documentation
                                            </a>
                                        </li><li>
                                            <a href="/documentation/bundles.html">
                                                Bundles
                                            </a>
                                        </li>
                                    </ul>
                                </div>                                
                            </div><div class="tags">
                                
                            </div>
                        </div><h1 class="title">
                            Connection Timeout Agent
                        </h1><nav class="menu">
                            <ul class="menu-list box is-shadowless is-paddingless">
                                <li id="generatedToC">
                                    <p class="menu-label">
                                        <strong>Table of Contents</strong>
                                    </p>
                                </li>
                            </ul>
                        </nav><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=title],h2,h3','ulClass':'menu-list'}); } );</script><div class="content is-marginless">
<div class="row"><div><section><p><!-- TODO reactivate TOC once JBake moves to flexmark-java -->
</p>
<h2><a href="#connection-timeout-agent" id="connection-timeout-agent">Connection Timeout Agent</a></h2>
<p>This module provides a java agent that uses the <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/package-summary.html">instrumentation API</a> to add connect and read timeouts to connections made via HTTP or HTTPs. It only applies these timeouts if none were set explicitly.</p>
<p>The agent is intended as an additional layer of control to use when running untrusted client code that may make calls without explicitly setting timeouts. It is always recommended to set timeouts in client code, rather than relying on this agent.</p>
<p>It currently supports setting timeouts for HTTP connections done using:</p>
<ul>
<li><a href="https://docs.oracle.com/javase/7/docs/api/java/net/URL.html">java.net.URL</a> and/or <a href="https://docs.oracle.com/javase/7/docs/api/java/net/URLConnection.html">java.net.URLConnection</a></li>
<li><a href="https://hc.apache.org/httpclient-3.x/">Apache Commons HttpClient 3.x</a></li>
<li><a href="https://hc.apache.org/httpcomponents-client-ga/">Apache HttpComponents Client 4.x</a></li>
<li><a href="https://square.github.io/okhttp/">OK Http</a></li>
</ul>
<h2><a href="#usage" id="usage">Usage</a></h2>
<p>The agent can be loaded using the standard Java CLI invocation, by using the <code>-javaagent:...</code> argument.</p>
<pre><code>java -javaagent:org.apache.sling.connection-timeout-agent-jar-with-dependencies.jar=&lt;agent-connect-timeout&gt;,&lt;agent-read-timeout&gt;[,&lt;logspec&gt;] -jar org.apache.sling.starter-11.jar
</code></pre>
<p>It support two mandatory arguments and an optional one:</p>
<ul>
<li><code>&lt;agent-connect-timeout&gt;</code> - connection timeout in milliseconds to apply via the agent</li>
<li><code>&lt;agent-read-timeout&gt;</code>- read timeout in milliseconds to apply via the agent</li>
<li><code>&lt;logspec&gt;</code> - if set to <code>v</code>, it will enter verbose mode and print additional information to <code>System.out</code></li>
</ul>
<p>If started in verbose mode, output similar to the following will be printed</p>
<pre><code>[AGENT] Preparing to install URL transformers. Configured timeouts - connectTimeout : 1000, readTimeout: 1000 
[AGENT] All transformers installed 
[AGENT] JavaNetTimeoutTransformer asked to transform sun/net/www/protocol/https/AbstractDelegateHttpsURLConnection 
[AGENT] Transformation of sun/net/www/protocol/https/AbstractDelegateHttpsURLConnection complete 
[AGENT] JavaNetTimeoutTransformer asked to transform sun/net/www/protocol/http/HttpURLConnection 
[AGENT] Transformation of sun/net/www/protocol/http/HttpURLConnection complete 
</code></pre>
<p>Note that classes will be transformed when they are loaded. It is expected for a transformer for class <em>A</em> to be active but the class not to be transformed until it is actually used.</p>
<h2><a href="#jmx" id="jmx">JMX</a></h2>
<p>Various runtime information is exposed through a JMX MBean registered at <code>org.apache.sling.cta;ObjectType=Agent</code>.</p>
<p><img src="/documentation/bundles/connection-timeout-agent/jmx-mbeans.png" alt="JMX MBeans" /></p>
<h2><a href="#alternatives" id="alternatives">Alternatives</a></h2>
<p>It is always recommended to set timeouts in the client code directly. The agent carries some risks, namely:</p>
<ul>
<li>it is not transparent why and where timeouts are set and can lead to hard-to-debug scenarios</li>
<li>it only sets one timeout for the whole JVM, whereas various services may need different timeouts</li>
</ul>
<p>All HTTP client libraries offer a way of setting connect and read timeouts, and it strongly recommended to do so. Alternatively, various bundles offer a way of centrally defining timeouts, amongst them:</p>
<ul>
<li><a href="https://github.com/code-distillery/httpclient-configuration-support">Code Distillery - OSGi Configuration Support for Apache HttpComponents Client</a></li>
<li><a href="https://caravan.wcm.io/commons/httpclient/">WCM.io Caravan - Commons HTTP Client</a></li>
</ul>
<h2><a href="#tested-platforms" id="tested-platforms">Tested platforms</a></h2>
<ul>
<li>openjdk version &quot;1.8.0_212&quot;</li>
<li>openjdk version &quot;11.0.2&quot; 2019-01-15</li>
<li>commons-httpclient 3.1</li>
<li>httpclient 4.5.4</li>
<li>okhttp 3.14.2</li>
</ul>
</section></div></div>                            
                        </div>
                    </div>
                </div>
            </div><footer class="footer">
                <div class="content has-text-centered is-small">
<div class="editpagelink">
                        This page can be edited on GitHub at <a href="https://github.com/apache/sling-site/edit/master/src/main/jbake/content/documentation/bundles/connection-timeout-agent.md">
                            content/documentation/bundles/connection-timeout-agent.md
                        </a>
                    </div>                    <div class="revisionInfo">
                        Last modified by <span class="author">Robert Munteanu</span> on <span class="comment">2019-06-27</span>
                    </div><p>
                        Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project logo are trademarks of The Apache Software Foundation. All other marks mentioned may be trademarks or registered trademarks of their respective owners.
                    </p><p>
                        Copyright Â© 2007-2022 The Apache Software Foundation.
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>