<!DOCTYPE html><html lang="en">
<head>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
        <title>Apache Sling :: Repository Initialization (repoinit)</title>
        <link rel="icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css"/>
        <link rel="stylesheet" href="/res/css/site.css"/>
        <script src='https://www.apachecon.com/event-images/snippet.js'></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js'></script><script>
            hljs.initHighlightingOnLoad();
        </script>
        
	<!-- Matomo Web Analytics -->
	<script>
	var _paq = window._paq = window._paq || [];
	/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
	/* We explicitly disable cookie tracking to avoid privacy issues */
	_paq.push(['disableCookies']); 
	_paq.push(['trackPageView']);
	_paq.push(['enableLinkTracking']);
	(function() {
	  var u="https://matomo.privacy.apache.org/";
	  _paq.push(['setTrackerUrl', u+'matomo.php']);
	  _paq.push(['setSiteId', '6']);
	  var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
	  g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
	})();
	</script>
	<!-- End Matomo Code -->
	<link href='/pagefind/pagefind-ui.css' rel='stylesheet'><script src='/pagefind/pagefind-ui.js' type='text/javascript'></script>
	<script>
    window.addEventListener('DOMContentLoaded', (event) => {
        new PagefindUI({ element: "#searchbox" });
    });
	</script>
	
    </head>    <body>
        <div class="section">
            <div class="level is-marginless">
<div class="logo">
                    <a href="https://sling.apache.org">
                        <img border="0" alt="Apache Sling" src="/res/logos/sling.svg"/>
                    </a>
                </div><div class="header">
                    <a href="https://www.apache.org">
                        <img border="0" alt="Apache" src="/res/logos/apache.png"/>
                    </a>
                </div>                
            </div><section class="searchbox level is-marginless">
                <div id="searchbox"></div>
            </section><div class="columns is-gapless">
                <div class="column is-narrow sidemenu">
<div class="container">
                        <nav class="menu">
                            <ul class="menu-list box is-shadowless is-marginless">
                                <li>
                                    <p class="menu-label">
                                        <strong>Documentation</strong>
                                    </p><ul>
                                        <li><a href="/documentation.html">Overview</a></li><li><a href="/documentation/getting-started.html">Getting Started</a></li><li><a href="/documentation/the-sling-engine.html">The Sling Engine</a></li><li><a href="/documentation/development.html">Development</a></li><li><a href="/documentation/bundles.html">Bundles</a></li><li><a href="/documentation/tutorials-how-tos.html">Tutorials &amp; How-Tos</a></li><li><a href="/components/">Maven Plugins</a></li><li><a href="/documentation/configuration.html">Configuration</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>API Docs</strong>
                                    </p><ul>
                                        <li><a href="/apidocs/sling12/index.html">Sling 12</a></li><li><a href="/apidocs/sling11/index.html">Sling 11</a></li><li><a href="/apidocs/sling10/index.html">Sling 10</a></li><li><a href="/apidocs/sling9/index.html">Sling 9</a></li><li><a href="/documentation/apidocs.html">All versions</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Support</strong>
                                    </p><ul>
                                        <li><a href="https://s.apache.org/sling.wiki">Wiki</a></li><li><a href="https://s.apache.org/sling.faq">FAQ</a></li><li><a href="/sitemap.html">Sitemap</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Project Info</strong>
                                    </p><ul>
                                        <li><a href="/downloads.cgi">Downloads</a></li><li><a href="https://www.apache.org/licenses/">License</a></li><li><a href="/news.html">News</a></li><li><a href="/releases.html">Releases</a></li><li><a href="https://issues.apache.org/jira/browse/SLING">Issue Tracker</a></li><li><a href="/links.html">Links</a></li><li><a href="/contributing.html">Contributing</a></li><li><a href="/project-information.html">Project Information</a></li><li><a href="/project-information/security.html">Security</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Source</strong>
                                    </p><ul>
                                        <li><a href="/repolist.html">Repositories</a></li><li><a href="https://gitbox.apache.org/repos/asf?s=sling">Git at Apache</a></li>
                                    </ul>
                                </li><li>
                                    <p class="menu-label">
                                        <strong>Apache Software<br>Foundation</strong>
                                    </p><ul>
                                        <li><a href="https://www.apache.org/foundation/thanks.html">Thanks!</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html">Become a Sponsor</a></li><li><a href="https://www.apache.org/foundation/buy_stuff.html">Buy Stuff</a></li>
                                    </ul>
                                </li><li>
                                    <a class="acevent" data-format="square" data-event="random"></a>
                                </li><li>
                                    <a href="https://apache.org/foundation/contributing.html" class="column">
                                        <img border="0" alt="Support the Apache Software Foundation!" src="/res/images/SupportApache-small.png" width="125"/>
                                    </a>
                                </li>
                            </ul>
                        </nav>
                    </div>                    
                </div><div class="column main">
                    <div class="box is-shadowless is-marginless">
                        <div class="level">
                            <div class="pagenav">
<div class="breadcrumb">
                                    <ul>
                                        <li>
                                            <a href="/">
                                                Home
                                            </a>
                                        </li><li>
                                            <a href="/documentation.html">
                                                Documentation
                                            </a>
                                        </li><li>
                                            <a href="/documentation/bundles.html">
                                                Bundles
                                            </a>
                                        </li>
                                    </ul>
                                </div>                                
                            </div><div class="tags">
                                <span class="tag">
                                    <a href="/tags/repoinit.html">
                                        repoinit
                                    </a>
                                </span><span class="tag">
                                    <a href="/tags/jcr.html">
                                        jcr
                                    </a>
                                </span><span class="tag">
                                    <a href="/tags/repository.html">
                                        repository
                                    </a>
                                </span>
                            </div>
                        </div><h1 class="title">
                            Repository Initialization (repoinit)
                        </h1><nav class="menu">
                            <ul class="menu-list box is-shadowless is-paddingless">
                                <li id="generatedToC">
                                    <p class="menu-label">
                                        <strong>Table of Contents</strong>
                                    </p>
                                </li>
                            </ul>
                        </nav><script src='/res/jquery-3.2.1.min.js' type='text/javascript'></script><script src='/res/tocjs-1-1-2.js' type='text/javascript'></script><script type='text/javascript'>$(document).ready(function() { $('#generatedToC').toc({'selector':'h1[class!=title],h2,h3','ulClass':'menu-list'}); } );</script><div class="content is-marginless">
<div class="row" data-pagefind-body="true"><div><section><p>The <code>SlingRepositoryInitializer</code> mechanism (short: repoinit) allows for running code before the <code>SlingRepository</code> service is registered. This is useful for initialization and content migration purposes.</p>
<p>The code (in form of statements) being executed through repoinit ensures that the repository has a certain state. In case the repository cannot be set up as being mandated through the repoinit statements the startup of the repository <strong>fails</strong>. This may happen in case the existing parent nodes have node type restrictions which don't allow for the new repository state or in general when the existing node/property state is conflicting with the target one.</p>
<p>For historical reasons two statements deviate from that by not failing in case the desired repository state cannot be achieved:</p>
<ol>
<li><code>create path</code> will not touch/modify existing nodes (i.e. does neither adjust primary nor mixin types if they differ), therefore it has been deprecated and replaced by <code>ensure nodes</code> <a href="https://issues.apache.org/jira/browse/SLING-11736">SLING-11736</a></li>
<li><code>set principal ACL</code> will not fail in case the principal ACL cannot be applied for whatever reason, therefore it has been deprecated and replaced by <code>ensure principal ACL</code> <a href="https://issues.apache.org/jira/browse/SLING-10281">SLING-10281</a></li>
</ol>
<p>Starting with version 1.1.40 of the bundle <code>org.apache.sling.jcr.repoinit</code> repoinit scripts are safely executed also in environments with a shared repository; this is implemented by a retry-mechanism with randomized delays.</p>
<h2><a href="#slingrepositoryinitializer" id="slingrepositoryinitializer">SlingRepositoryInitializer</a></h2>
<p>The <code>SlingRepositoryInitializer</code> is a very simple service interface, available from version 2.4.0 of the <code>org.apache.sling.jcr.api</code> and <code>org.apache.sling.jcr.base</code> bundles.</p>
<pre><code>public interface SlingRepositoryInitializer {
    public void processRepository(SlingRepository repo) throws Exception;
}
</code></pre>
<p>Services that implement this interface are called when setting up the JCR-based <code>SlingRepository</code> service, before registering it as an OSGi service.</p>
<p>They are called in increasing order of their <code>service.ranking</code> service property, which needs to be an <code>Integer</code> as usual.</p>
<p>If any of them throws an Exception, the <code>SlingRepository</code> service is not registered.</p>
<p>This mechanism is used under the hood by repoinit.</p>
<h2><a href="#the-repoinit-repository-initialization-language" id="the-repoinit-repository-initialization-language">The 'repoinit' Repository Initialization Language</a></h2>
<p>The <code>org.apache.sling.repoinit.parser</code> implements a mini-language meant to create nodes, properties, service users and manage access control in a content repository, as well as registering JCR namespaces, node types and privileges. Defining access control content consists of setting and deleting policies of type access control lists (ACL) for which individual access control entries (ACE) can be added and removed.</p>
<p>The source code consists of <a href="https://github.com/apache?utf8=%E2%9C%93&amp;q=sling+repoinit">two modules</a>: the parser and the JCR repoinit adapter module.</p>
<p>The language grammar is defined (using the JavaCC compiler-compiler, which has no runtime dependencies) in the <code>RepoInitGrammar.jjt</code> file in that module, and the automated tests provide a number of <a href="https://github.com/apache/sling-org-apache-sling-repoinit-parser/tree/master/src/test/resources/testcases">test cases</a> which demonstrate various features.</p>
<p>The companion <code>org.apache.sling.jcr.repoinit</code> module implements those operations on an Oak JCR repository, using a <code>SlingRepositoryInitializer</code> registered by default with a service ranking of 100. It also provides a <code>JcrRepoInitOpsProcessor</code> service to explicitly apply the output of the repoinit parser to a JCR repository.</p>
<p>The language is mostly self-explaining, the test suite listed below in Appendix A exposes all language constructs and options.</p>
<p>When a repoinit script is applied with the <code>org.apache.sling.jcr.repoinit</code> module, the execution order of the individual statements is slightly different from their order within the script. Namely, all statements creating namespaces are executed before any other statements. Next, all statements registering nodetypes or privileges are executed. And finally, all other statements are executed in the order they are defined. This reordering is intended to avoid issues due to missing namespaces, nodetypes or privileges when content is created.</p>
<h2><a href="#executing-repoinit-statements-outside-of-the-startup-sequence" id="executing-repoinit-statements-outside-of-the-startup-sequence">Executing repoinit statements outside of the startup sequence</a></h2>
<p>As demonstrated by the <a href="https://github.com/apache/sling-org-apache-sling-jcr-repoinit/blob/master/src/test/java/org/apache/sling/jcr/repoinit/it/MinimalRepoInitIT.java#L43">MinimalRepoInitIT</a> test, the <code>RepoInitParser</code> and <code>JcrRepoInitOpsProcessor</code>services allow for parsing and executing repoinit statements independently of the repository startup sequence.</p>
<h2><a href="#validating-repoinit-statements" id="validating-repoinit-statements">Validating repoinit statements</a></h2>
<p>There are multiple means to validate the syntax of repoinit statements (only leveraging the parser, but not the actual JCR Repoinit implementation) outlined below.</p>
<h3><a href="#filevault-validator" id="filevault-validator">FileVault Validator</a></h3>
<p>There is a <a href="https://jackrabbit.apache.org/filevault/validation.html">FileVault validator</a> for repoinit OSGi configurations (contained in FileVault Content Packages) in repository <a href="https://github.com/apache/sling-org-apache-sling-repoinit-filevault-validator">sling-org-apache-sling-repoinit-filevault-validator</a>. Further details on how to use it can be found in its <a href="https://github.com/apache/sling-org-apache-sling-repoinit-filevault-validator/blob/master/README.md">readme file</a>.</p>
<h3><a href="#jbang-script" id="jbang-script">JBang Script</a></h3>
<p>A <a href="https://github.com/apache/sling-whiteboard/blob/master/jbang/RepoinitValidator.java">jbang script in the Sling whiteboard repository</a> can be used to test the syntax of repoinit statements by running a specific version of the repoinit parser on them.</p>
<h3><a href="#web-console-plugin" id="web-console-plugin">Web Console Plugin</a></h3>
<p>There is a <a href="https://github.com/apache/sling-whiteboard/tree/master/org.apache.sling.repoinit.webconsole">Felix Web Console Plugin in the Sling whiteboard repository</a> which allows to validate and optionally also execute repoinit statements.</p>
<h2><a href="#providing-repoinit-statements-from-osgi-factory-configurations" id="providing-repoinit-statements-from-osgi-factory-configurations">Providing repoinit statements from OSGi factory configurations</a></h2>
<p>From version 1.1.6 of the <code>org.apache.sling.jcr.repoinit</code> bundle, repoinit statements can also be provided by OSGi factory configurations which use the <code>org.apache.sling.jcr.repoinit.RepositoryInitializer</code> factory PID.</p>
<p>Such configurations have two optional fields:</p>
<ul>
<li>A multi-value <code>references</code> field with each value providing the URL (as a String) of raw repoinit statements.</li>
<li>A multi-value <code>scripts</code> field with each value providing repoinit statements as plain text in a String.</li>
</ul>
<p>Any of the serialization formats for OSGi configurations can be used, but it is important to consider the escaping rules outlined at <a href="/documentation/bundles/configuration-installer-factory.html#configuration-serialization-formats">OSGi Configurations Serialization Formats</a>.</p>
<h2><a href="#providing-repoinit-statements-from-the-sling-provisioning-model-or-other-urls" id="providing-repoinit-statements-from-the-sling-provisioning-model-or-other-urls">Providing repoinit statements from the Sling provisioning model or other URLs</a></h2>
<p>All bundles required for this feature need to be active before the <code>SlingRepository</code> service starts.</p>
<p>From version 1.0.2 of the <code>org.apache.sling.jcr.repoinit</code> bundle, the <code>o.a.s.jcr.repoinit.RepositoryInitializer</code> component uses an OSGi configuration as shown in this example to define where to read repoinit statements:</p>
<pre class="language-no-highlight">
  org.apache.sling.jcr.repoinit.impl.RepositoryInitializer
    references=["model:context:/resources/provisioning/model.txt","model@repoinitTwo:context:/resources/provisioning/model.txt"]
</pre>
<p>This example defines two <em>references</em> to URLs that supply repoinit statements. Their syntax is described below.</p>
<p>By default the <code>RepositoryInitializer</code> uses the first URL shown in the above example, which points to the provisioning model that's embedded by default in the Sling Launchpad runnable jar.</p>
<p>Note that previous versions of the <code>org.apache.sling.jcr.repoinit</code> bundle used different configuration parameters. From version 1.0.2 on, warnings are logged if those old parameters (<em>text.url,text.format,model.section.name</em>) are used.</p>
<h3><a href="#references-to-sling-provisioning-model-additional-sections" id="references-to-sling-provisioning-model-additional-sections">References to Sling Provisioning Model additional sections</a></h3>
<p>The <code>slingstart-maven-plugin</code>, from V1.4.2 on, allows for embedding so-called &quot;additional sections&quot; in the Sling provisioning model by starting their name with a colon.</p>
<p>At runtime this requires the <code>org.apache.sling.provisioning.model</code> bundle, version 1.4.2 or later.</p>
<p>The <code>o.a.s.jcr.repoinit</code> bundle can use this feature to execute <code>repoinit</code> statements provided by Sling provisioning models, as in this provisioning model example fragment:</p>
<pre class="language-no-highlight">
  [:repoinit]
  create path /repoinit/provisioningModelTest
<p>create service user provisioningModelUser</p>
</pre>
<p>To read repoinit statements from such an additional provisioning model section, the <code>RepositoryInitializer</code> configuration shown above uses references like</p>
<pre class="language-no-highlight">
  model@repoinitTwo:context:/resources/provisioning/model.txt
</pre>
<p>Where <em>model</em> means &quot;use the provisioning model format&quot;, <em>repoinitTwo</em> is the name of the additional section to read statements from in the provisioning model (without the leading colon) and <em>context:/resources/...</em> is the URL to use to retrieve the provisioning model.</p>
<p>In this example the URL uses the <em>context</em> scheme defined by the Sling Launchpad, but any scheme can be used provided a suitable URL handler is active.</p>
<p>The section name in that reference is optional and defaults to <em>repoinit</em>. If it's not specified the <code>@</code> should be omitted as well.</p>
<h3><a href="#references-to-urls-providing-raw-repoinit-statements" id="references-to-urls-providing-raw-repoinit-statements">References to URLs providing raw repoinit statements</a></h3>
<p>Using a <code>RepositoryInitializer</code> reference like in this example, with the <em>raw</em> prefix, means that its content is passed as is to the repoinit parser:</p>
<pre class="language-no-highlight">
  raw:classpath://some-repoinit-file.txt
</pre>
<p>Which points to a <code>classpath:</code> URL to provide the raw repoinit statements in this example, but again any valid URL scheme can be used.</p>
<h1><a href="#appendix" id="appendix">Appendix</a></h1>
<h2><a href="#appendix-a-repoinit-syntax-parser-test-scenarios" id="appendix-a-repoinit-syntax-parser-test-scenarios">Appendix A: repoinit syntax: parser test scenarios</a></h2>
<p>A concatenation of all test scenarios from the <a href="https://github.com/apache/sling-org-apache-sling-repoinit-parser/tree/master/src/test/resources/testcases">repoinit parser module</a> follows.</p>
<p>Assuming that test suite is complete, this exposes all the language constructs and options, with descriptive comments where needed. If something's unclear, please ask or provide patches for these tests to make them easier to understand.</p>
<p>The following output is generated by the <a href="https://github.com/apache/sling-org-apache-sling-repoinit-parser/tree/master/concatenate-test-scenarios.sh">concatenate-test-scenarios.sh</a> script found in the repoinit parser repository.</p>
<h3><a href="#repoinit-parser-test-scenarios" id="repoinit-parser-test-scenarios">Repoinit parser test scenarios</a></h3>
<pre><code># test-1.txt

create service user bob,alice, tom21
create service user lonesome
create service user pathA with path some/relative/path
create service user pathA with path /some/absolute/path

# test-2.txt

create service user Mark-21
delete service user Leonardo,Winston_32

# test-3.txt

#
# single-word
# We're testing the comments now
# This is A COMMENT with other things like 12, 34
# And now for a tag, &lt;ok&gt; ?
# And some punctuation: .,;-_[]+&quot;*ç%&amp;/()=?^`&quot;
   # Also with leading whitespace.

# blank lines work, of course   
create service user comments_test_passed

# test-4.txt

# trailing comments test
create service user comments_test_passed
# something

# test-5.txt

# trailing comments test without following blank lines
create service user comments_test_passed
# something

# test-10.txt

# Set ACL example from SLING-5355
# Without the &quot;with glob&quot; option, we're not planning to support
# that at this time. 
set ACL on /libs,/apps, /, /content/example.com/some-other_path
    remove * for user1,user2
    allow jcr:read for user1,user2
    allow privilege_without_namespace for user4

    deny jcr:write,something:else,another:one for user2
    deny jcr:lockManagement for user1
    deny jcr:modifyProperties for user2 restriction(rep:itemNames,prop1,prop2)
end

set ACL on /no-indentation
allow jcr:read for userA,userB
end

# test-11.txt

# Test multiple remove lines
# Although the repoinit language includes a remove statement,
# it is not generally supported by the current version of the
# o.a.s.jcr.repoinit module. Only the &quot;remove *&quot; variant is
# supported starting with o.a.s.jcr.repoinit V1.1.34
set ACL on /libs,/apps
    remove * for user1,user2
    allow jcr:read for user1,user2

    remove * for another
    allow x:y for another

    remove jcr:ACL for userTestingSpecificRemove
end

# test-12.txt

# Test path-centric Set Acl with options (SLING-6423)
set ACL on /libs,/apps (ACLOptions=merge)
    remove * for user1,user2
    allow jcr:read for user1,user2

    remove * for another
    allow x:y for another
end

# Multiple options
set ACL on /libs,/apps (ACLOptions=mergePreserve,someOtherOption,someOther123,namespaced:option)
    remove * for user1,user2
    allow jcr:read for user1,user2

    remove * for another
    allow x:y for another
end

# test-13.txt

# Test for repository-level ACL (SLING-7061), requires
# o.a.s.repoinit.parser 1.2.0, o.a.s.jcr.repoinit 1.1.6
set repository ACL for user1,user2
    remove *
    allow jcr:read,jcr:lockManagement
    deny jcr:write
end

# test-14.txt

# Test allowed path characters, see SLING-6774
set ACL on /one:name,/two+name,/three@name
    remove * for user1
    allow jcr:read for user1
end

# test-15.txt

# Mixing paths and repo-level ACL
set ACL on /content,:repository
    allow jcr:all for user1
end

# test-20.txt

# Various &quot;ensure nodes&quot; tests (SLING-11736)
# requires
# o.a.s.repoinit.parser 1.9.0 and
# o.a.s.jcr.repoinit 1.1.44

# Nodetypes:
# A nodetype in brackets right after &quot;ensure nodes&quot;, like
# sling:Folder below, sets the default type for all path
# segments of this statement.
# A nodetype in brackets at the end of a path segment, like
# nt:unstructured below, applies just to that path segment.
# If no specific nodetype is set, the repository uses its
# default based on node type definitions.

ensure nodes (sling:Folder) /var/discovery(nt:unstructured)/somefolder

# more tests and examples
ensure nodes /one/two/three
ensure nodes /three/four(nt:folk)/five(nt:jazz)/six
ensure nodes (nt:x) /seven/eight/nine
ensure nodes /one(mixin nt:art)/step(mixin nt:dance)/two/steps
ensure nodes (nt:foxtrot) /one/step(mixin nt:dance)/two/steps
ensure nodes /one/step(mixin nt:dance,nt:art)/two/steps
ensure nodes /one/step(nt:foxtrot mixin nt:dance)/two/steps
ensure nodes /one/step(nt:foxtrot mixin nt:dance,nt:art)/two/steps
ensure nodes /one:and/step/two:and/steps
ensure nodes /one@home/step/two@home/steps
ensure nodes /one+tap/step/two+tap/steps

# this is to cover an edge case: SLING-11384 (create root node with primary type)
ensure nodes /(nt:x)

# SLING-10740 - Repoinit ensure nodes statement with properties
ensure nodes (sling:Folder) /var/discovery(nt:unstructured)/somefolder2 with properties
  set sling:ResourceType{String} to /x/y/z
  set cq:allowedTemplates to /d/e/f/*, m/n/*
  default someInteger{Long} to 42
end

# test-30.txt

# Test the principal-centered ACL syntax

set ACL for user1,u2
    remove * on /libs,/apps
    allow jcr:read on /content

    deny jcr:write on /apps
    
    # Optional nodetypes clause
    deny jcr:lockManagement on /apps, /content nodetypes sling:Folder, nt:unstructured
    # nodetypes clause with restriction clause
    deny jcr:modifyProperties on /apps, /content nodetypes sling:Folder, nt:unstructured restriction(rep:itemNames,prop1,prop2)
    remove jcr:understand,some:other on /apps

    # multi value restriction
    allow jcr:addChildNodes on /apps restriction(rep:ntNames,sling:Folder,nt:unstructured)

    # multiple restrictions
    allow jcr:modifyProperties on /apps restriction(rep:ntNames,sling:Folder,nt:unstructured) restriction(rep:itemNames,prop1,prop2)

    # restrictions with glob patterns
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,/cat,/cat/,cat)
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,cat/,*,*cat)
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,/cat/*,*/cat,*cat/*)

    allow jcr:something on / restriction(rep:glob)
end

# test-31.txt

# Principal-centered ACL syntax with options (SLING-6423)
set ACL for user1,u2 (ACLOptions=mergePreserve)
    remove * on /libs,/apps
    allow jcr:read on /content
end

# With multiple options
set ACL for user1,u2 (ACLOptions=mergePreserve,someOtherOption,someOther123,namespaced:option)
    remove * on /libs,/apps
    allow jcr:read on /content
end

# test-32.txt

# repo-level permissions in &quot;set ACL for&quot;
set ACL for user1
    allow jcr:all on :repository,/content
end

# test-33.txt

# Set principal-based access control (see SLING-8602 and SLING-10281), requires
# o.a.s.repoinit.parser 1.9.0 and
# o.a.s.jcr.repoinit 1.1.44
# precondition for o.a.s.jcr.repoinit: 
# repository needs to support 'o.a.j.api.security.authorization.PrincipalAccessControlList'
# Also, this only works for users selected by the Jackrabbit/Oak FilterProvider, see
# https://jackrabbit.apache.org/oak/docs/security/authorization/principalbased.html#configuration
# mostly a copy of test-33 but with &quot;ensure&quot; prefix instead of &quot;set&quot;

ensure principal ACL for principal1,principal2
    remove * on /libs,/apps
    allow jcr:read on /content

    deny jcr:write on /apps

    # Optional nodetypes clause
    deny jcr:lockManagement on /apps, /content nodetypes sling:Folder, nt:unstructured
    # nodetypes clause with restriction clause
    deny jcr:modifyProperties on /apps, /content nodetypes sling:Folder, nt:unstructured restriction(rep:itemNames,prop1,prop2)
    remove jcr:understand,some:other on /apps

    # multi value restriction
    allow jcr:addChildNodes on /apps restriction(rep:ntNames,sling:Folder,nt:unstructured)

    # multiple restrictions
    allow jcr:modifyProperties on /apps restriction(rep:ntNames,sling:Folder,nt:unstructured) restriction(rep:itemNames,prop1,prop2)

    # restrictions with glob patterns
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,/cat,/cat/,cat)
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,cat/,*,*cat)
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,/cat/*,*/cat,*cat/*)

    allow jcr:something on / restriction(rep:glob)
end

# Principal-based ACL syntax with options (SLING-6423)
ensure principal ACL for principal1,principal2 (ACLOptions=mergePreserve)
    remove * on /libs,/apps
    allow jcr:read on /content
end

# With multiple options
ensure principal ACL for principal1,principal2 (ACLOptions=mergePreserve,someOtherOption,someOther123,namespaced:option)
    remove * on /libs,/apps
    allow jcr:read on /content
end

# repository level
ensure principal ACL for principal1,principal2
    allow jcr:namespaceManagement on :repository 
end

ensure principal ACL for principal1
    allow jcr:all on :repository,/content
end

# test-34.txt

# Functions at the beginning of path names (SLING-8757)

set ACL on home(alice)
  allow jcr:one for alice, bob, carol
end

set ACL on home(jack),/tmp/a,functionNamesAreFree(bobby)
  allow jcr:two for alice
end

set ACL for fred
  allow jcr:three on /one,home(Alice123),/tmp
end

set ACL on /a/b,home(jack),/tmp/a,square(bobby)
  allow jcr:four for alice
end

set ACL for austin
  allow jcr:five on /one,home(Alice123),/tmp
end

set ACL on home(  spacesAreOk )
  allow jcr:six for spaceman
end

set ACL on home(alice)/sub/folder, /anotherPath, home(fred)/root
  allow jcr:seven for mercury
end

# test-35.txt

# Removal of individual access control entries (see SLING-11160), requires
# o.a.s.repoinit.parser 1.6.14 and
# o.a.s.jcr.repoinit 1.1.38

# remove entries by path

remove ACE on /libs,/apps, /, /content/example.com/some-other_path
    allow jcr:read for user1,user2
    allow privilege_without_namespace for user4
    deny jcr:write,something:else,another:one for user2
    deny jcr:lockManagement for user1
    deny jcr:modifyProperties for user2 restriction(rep:itemNames,prop1,prop2)
end

# remove entries by principal

remove ACE for user1,u2
    allow jcr:read on /content
    allow jcr:addChildNodes, jcr:modifyProperties on /content restriction(rep:glob)
    deny jcr:read on /etc, /var restriction(rep:ntNames,sling:Folder,nt:unstructured) restriction(rep:itemNames,prop1,prop2)
end

# remove principal-based entries

remove principal ACE for principal1,principal2
    allow jcr:read on /content
    deny jcr:modifyProperties on /apps, /content restriction(rep:itemNames,prop1,prop2)
    allow jcr:addChildNodes on /apps restriction(rep:ntNames,sling:Folder,nt:unstructured)
    allow jcr:modifyProperties on /apps restriction(rep:ntNames,sling:Folder,nt:unstructured) restriction(rep:itemNames,prop1,prop2)
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,/cat,/cat/,cat)
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,cat/,*,*cat)
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,/cat/*,*/cat,*cat/*)
    allow jcr:something on / restriction(rep:glob)
    allow jcr:all on :repository,home(alice)
end

# test-40.txt

# Register namespaces, requires
# o.a.s.repoinit.parser 1.0.4
# and o.a.s.jcr.repoinit 1.0.2
# Quoted Namespaces requires
# o.a.s.repoinit.parser 1.6.16
register namespace (foo) uri:some-uri/V/1.0
register namespace ( prefix_with-other.things ) andSimpleURI
register namespace (foo2) &quot;uri:some-uri/V/1.1/test#&quot;

# test-42.txt

# Register privileges
register privilege withoutabstract_withoutaggregates
register privilege ns:withoutabstract_withoutaggregatesNS
register abstract privilege withabstract_withoutaggregates
register abstract privilege ns:withabstract_withoutaggregatesNS

register privilege withoutabstract_withaggregate with bla
register privilege withoutabstract_withaggregates with bla,blub
register privilege withoutabstract_withaggregates with bla,ns:namespacedA
register privilege ns:withoutabstract_withaggregates with bla,ns:namespacedB

register abstract privilege withabstract_withaggregate with foo
register abstract privilege withabstract_withaggregates with foo,bar
register abstract privilege withabstract_withaggregates with foo,ns:namespacedC
register abstract privilege ns:withabstract_withaggregates with foo,ns:namespacedD

register privilege priv with declared_aggregate_priv1,declared_aggregate_priv2
register privilege priv with declared_aggregate_priv1,namespaced:_priv4

# test-50.txt

# Embedded CNDs for nodetype definitions

register nodetypes
&lt;&lt;===
    &lt;slingevent='http://sling.apache.org/jcr/event/1.0'&gt;
    &lt;nt='http://www.jcp.org/jcr/nt/1.0'&gt;
    &lt;mix='http://www.jcp.org/jcr/mix/1.0'&gt;
    
    [slingevent:Event] &gt; nt:unstructured, nt:hierarchyNode
      - slingevent:topic (string)
      - slingevent:application (string)
      - slingevent:created (date)
      - slingevent:properties (binary)
      
    [slingevent:Job] &gt; slingevent:Event, mix:lockable
      - slingevent:processor (string)
      - slingevent:id (string)
      - slingevent:finished (date)
     
    [slingevent:TimedEvent] &gt; slingevent:Event, mix:lockable
      - slingevent:processor (string)
      - slingevent:id (string)
      - slingevent:expression (string)
      - slingevent:date (date)
      - slingevent:period (long)
===&gt;&gt;

register nodetypes
&lt;&lt;===
Just one line, not indented
===&gt;&gt;

register nodetypes
&lt;&lt;===
&lt;&lt; Using line prefixes
&lt;&lt; to avoid conflicts with Sling provisioning model parser
===&gt;&gt;

# test-60.txt

# Create/delete users

delete user userB
create user userB

create user userC with password some_password

# Although the following syntax is valid for encrpyted passwords,
# the o.a.s.jcr.repoinit module only supports plain text
# ones, see SLING-6219
create user userD with password {SHA-256}dc460da4ad72c
create user userE with password {someEncoding} afdgwdsdf

create user one_with-more-chars.ok:/123456 with password {encoding_with.ok-:/12345} pw-with.ok-:/13456

create user userF with path /thePathF
create user userG with path /thePathG with password {theEncoding} userGpwd
create user userH with path thePathH
create user userJ with path thePathJ with password {theEncoding} userJpwd

# test-61.txt

# Disable service users
disable service user svcA : &quot;This message explains why it's disabled.  Whitespace   is  preserved.&quot;
disable service user svcB : &quot;Testing escaped double \&quot;quote\&quot; in this string.&quot;
disable service user svcC : &quot;Testing escaped backslash \\ in this string.&quot;
disable service user svcD : &quot;Testing quoted escaped backslash \&quot;\\\&quot; in this string.&quot;
disable service user svcE : &quot;Testing unescaped single backslash \ in this string.&quot;

# test-62.txt

# Create groups
create group groupa
create group groupb with path /thePathF

# test-63.txt

# Delete groups
delete group groupa

# test-64.txt

# Add members to groups
add user1,user2 to group grpA

# test-65.txt

# Remove members from group
remove user3,user5 from group grpB

# test-66.txt

# Add and remove group members
add user1,user2 to group grpA
add user3 to group grpB
add user4,user5 to group grpB
remove user1 from group grpA
remove user3,user5 from group grpB

# test-67.txt

# Set properties
set properties on /pathA, /path/B
  set sling:ResourceType{String} to /x/y/z
  set cq:allowedTemplates to /d/e/f/*, m/n/*
  default someInteger{Long} to 42
  set aDouble{Double} to 3.14
  set someFlag{Boolean} to true
  default someDate{Date} to &quot;2020-03-19T11:39:33.437+05:30&quot;
  set customSingleValueStringProp to test
  set customSingleValueQuotedStringProp to &quot;hello, you!&quot;
  set customMultiValueStringProp to test1, test2
  default threeValues to test1, test2, test3
  set quotedA to &quot;Here's a \&quot;double quoted string\&quot; with suffix&quot;
  set quotedMix to &quot;quoted&quot;, non-quoted, &quot;the last \&quot; one&quot;
end

set properties on /single/path
  set someString to &quot;some string&quot;
end

set properties on /test/curly/brackets
  set curlyBracketsAndDoubleQuotes{String} to &quot;{\&quot;one, two\&quot;:\&quot;three, four\&quot;}&quot;
  set curlyBracketsAndSingleQuotes{String} to &quot;{'five, six':'seven,eight'}&quot;
end

set properties on /endkeyword
  # using &quot;end&quot; instead of &quot;endS&quot; below causes parsing to fail
  set endS to one
  set two to endS
end

set properties on /forcedMultiValue
  set singleMultiValue{String[]} to &quot;single&quot;
  set emptyMultiValue{String[]} to
  set singleLongMultiValue{Long[]} to 1243
  set emptyLongMultiValue{Long[]} to
end

set properties on /blankLinesInList
  set one to two

  set two to four

  set three to five
end

# SLING-10252: set properties on the user or group profile
set properties on authorizable(bob)
  set stringProp to &quot;hello, you!&quot;
end
set properties on authorizable(bob)/nested
  set stringProp to &quot;hello, you nested!&quot;
end

set properties on authorizable(bob), authorizable(alice)
  set stringProp to &quot;hello, you again!&quot;
end
set properties on authorizable(bob)/nested, authorizable(alice)/nested
  set stringProp to &quot;hello, you nested again!&quot;
end

# test-68.txt

# SLING-9857: &quot;with forced path&quot; option
create user A with path /path/user/A
create user AF with forced path /path/user/AF

create service user B with path /path/service/B
create service user BF with forced path /path/service/BF

create group G with path /path/group/G
create group GF with forced path /path/group/GF

# test-69.txt

# Disable users, with various messages
disable user A : &quot;This message explains why it's disabled.  Whitespace   is  preserved.&quot;
disable user uB : &quot;Testing escaped double \&quot;quote\&quot; in this string.&quot;
disable user userC : &quot;Testing escaped backslash \\ in this string.&quot;
disable user D : &quot;Testing quoted escaped backslash \&quot;\\\&quot; in this string.&quot;
disable user E : &quot;Testing unescaped single backslash \ in this string.&quot;

# test-70.txt

# Remove AC policies entirely (not just individual entries)
delete ACL for ana
delete ACL for alice, aida
delete ACL on :repository, home(anni), functionNamesAreFree(aendu)
delete ACL on /, /var, /etc
delete ACL on /content
delete principal ACL for ada, amy
delete principal ACL for adi

# test-71.txt

# Support quoted Group IDs
create group &quot;Test Group&quot;
create group &quot;Test Group With Spaces&quot; with path /thePathF
delete group &quot;Test Group&quot;
set ACL on /content
    allow jcr:read for &quot;Test Group&quot;,user1
end
set ACL on /content
    allow jcr:read for &quot;Test Group- Cool People&quot;,&quot;Test Group&quot;,user1
end
set ACL for user1,&quot;Test Group&quot;,u2
    allow jcr:read on /content
end
set principal ACL for user1,&quot;Test Group&quot; (ACLOptions=mergePreserve)
    remove * on /libs,/apps
    allow jcr:read on /content
end
set ACL on /test (ACLOptions=merge)
    remove * for user1,&quot;Test Group&quot;,user2
end
set properties on authorizable(bob), authorizable(&quot;Test Group&quot;)
  set stringProp to &quot;hello, you again!&quot;
end
set properties on authorizable(bob)/nested, authorizable(&quot;Test Group&quot;)/nested
  set stringProp to &quot;hello, you nested again!&quot;
end
add user1,&quot;Test Group 2000&quot;,user2 to group &quot;Parent Group&quot;
remove user1,&quot;Test Group 2000&quot;,user2 from group &quot;Parent Group&quot;

# Test other escaped characters 
create group &quot;Tab	Group&quot;
create group &quot;Untrimmed Group &quot;
create group &quot; Really Untrimmed Group &quot;
create group &quot;Group\With\Backslash&quot;
create group &quot;Group
Newline&quot;

# test-72.txt

add mixin mix:one to /thePath1
add mixin mix:one,mix:two to /thePath1,/thePath2
add mixin mix:three, mix:four to /thePath3, /thePath4

remove mixin mix:one from /thePath1
remove mixin mix:one,mix:two from /thePath1,/thePath2
remove mixin mix:three, mix:four from /thePath3, /thePath4

# test-73.txt

# Various &quot;create path&quot; tests
# as &quot;create path&quot; does not modify existing nodes it is deprecated and &quot;ensure nodes&quot; should be used instead

# Nodetypes:
# A nodetype in brackets right after &quot;create path&quot;, like
# sling:Folder below, sets the default type for all path
# segments of this statement.
# A nodetype in brackets at the end of a path segment, like
# nt:unstructured below, applies just to that path segment.
# If no specific nodetype is set, the repository uses its
# default based on node type definitions.

create path (sling:Folder) /var/discovery(nt:unstructured)/somefolder

# more tests and examples
create path /one/two/three
create path /three/four(nt:folk)/five(nt:jazz)/six
create path (nt:x) /seven/eight/nine
create path /one(mixin nt:art)/step(mixin nt:dance)/two/steps
create path (nt:foxtrot) /one/step(mixin nt:dance)/two/steps
create path /one/step(mixin nt:dance,nt:art)/two/steps
create path /one/step(nt:foxtrot mixin nt:dance)/two/steps
create path /one/step(nt:foxtrot mixin nt:dance,nt:art)/two/steps
create path /one:and/step/two:and/steps
create path /one@home/step/two@home/steps
create path /one+tap/step/two+tap/steps

# this is to cover an edge case: SLING-11384 (create root node with primary type)
create path /(nt:x)

# SLING-10740 - Repoinit create path statement with properties
create path (sling:Folder) /var/discovery(nt:unstructured)/somefolder2 with properties
  set sling:ResourceType{String} to /x/y/z
  set cq:allowedTemplates to /d/e/f/*, m/n/*
  default someInteger{Long} to 42
end

# test-74.txt

# Set principal-based access control (see SLING-8602), requires
# o.a.s.repoinit.parser 1.2.8 and
# o.a.s.jcr.repoinit 1.1.14
# precondition for o.a.s.jcr.repoinit: 
# repository needs to support 'o.a.j.api.security.authorization.PrincipalAccessControlList'
# Also, this only works for users selected by the Jackrabbit/Oak FilterProvider, see
# https://jackrabbit.apache.org/oak/docs/security/authorization/principalbased.html#configuration
# Deprecated: Use &quot;ensure principal ACL&quot; instead as &quot;set principal ACL&quot; is not failing if it cannot be applied
set principal ACL for principal1,principal2
    remove * on /libs,/apps
    allow jcr:read on /content

    deny jcr:write on /apps

    # Optional nodetypes clause
    deny jcr:lockManagement on /apps, /content nodetypes sling:Folder, nt:unstructured
    # nodetypes clause with restriction clause
    deny jcr:modifyProperties on /apps, /content nodetypes sling:Folder, nt:unstructured restriction(rep:itemNames,prop1,prop2)
    remove jcr:understand,some:other on /apps

    # multi value restriction
    allow jcr:addChildNodes on /apps restriction(rep:ntNames,sling:Folder,nt:unstructured)

    # multiple restrictions
    allow jcr:modifyProperties on /apps restriction(rep:ntNames,sling:Folder,nt:unstructured) restriction(rep:itemNames,prop1,prop2)

    # restrictions with glob patterns
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,/cat,/cat/,cat)
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,cat/,*,*cat)
    allow jcr:addChildNodes on /apps,/content restriction(rep:glob,/cat/*,*/cat,*cat/*)

    allow jcr:something on / restriction(rep:glob)
end

# Principal-based ACL syntax with options (SLING-6423)
set principal ACL for principal1,principal2 (ACLOptions=mergePreserve)
    remove * on /libs,/apps
    allow jcr:read on /content
end

# With multiple options
set principal ACL for principal1,principal2 (ACLOptions=mergePreserve,someOtherOption,someOther123,namespaced:option)
    remove * on /libs,/apps
    allow jcr:read on /content
end

# repository level
set principal ACL for principal1,principal2
    allow jcr:namespaceManagement on :repository 
end

set principal ACL for principal1
    allow jcr:all on :repository,/content
end
</code></pre>
</section></div></div><div data-pagefind-body="true" data-pagefind-weight="7.0" style="display:none;"> - ( Repository Initialization (repoinit) )</div>                            
                        </div>
                    </div>
                </div>
            </div><footer class="footer">
                <div class="content has-text-centered is-small">
<div class="editpagelink">
                        This page can be edited on GitHub at <a href="https://github.com/apache/sling-site/edit/master/src/main/jbake/content/documentation/bundles/repository-initialization.md">
                            content/documentation/bundles/repository-initialization.md
                        </a>
                    </div>                    <div class="revisionInfo">
                        Last modified by <span class="author">Bertrand Delacretaz</span> on <span class="comment">2024-02-06</span>
                    </div><p>
                        Apache Sling, Sling, Apache, the Apache feather logo, and the Apache Sling project
    logo are trademarks of The Apache Software Foundation. All other marks mentioned 
    may be trademarks or registered trademarks of their respective owners.
                    </p><p>
                        Copyright © 2007-2024<a href="https://www.apache.org/">
                            The Apache Software Foundation
                        </a>|<a href="https://privacy.apache.org/policies/privacy-policy-public.html">
                            Privacy Policy
                        </a>
                    </p>
                </div>
            </footer>
        </div>
    </body>
</html>